import{e as zr,u as Gr,_ as fr,a as er,b as cr,c as kt,d as Br}from"./OrbitControls-BUtMaXt_.js";import{r as k}from"./chunk-JZWAC4HX-CEDt07HX.js";import{s as Bt}from"./shaderMaterial-D7pW_17q.js";import{v as Pt}from"./constants-DMhkyvJ3.js";import{i as yr,I as Lt,S as Er,D as Ht,z as Zr,H as Me,E as Ne,J as Ge,L as xe,K as rr,N as zt,Q as Gt,V as Ue,X as Zt,C as Pr,Y as Be,c as Wr,Z as Wt,g as $r,_ as Xr,$ as ur,W as $t,a0 as Xt,a1 as gr,a2 as Ze,h as Yt,a3 as Vt,a4 as qt,a5 as Kt,a6 as Qt,a7 as mr,a8 as Jt,a9 as jt,aa as Lr,ab as ea,ac as lr,ad as ra,ae as ta,af as aa,ag as na,ah as ia}from"./three.module-D2towu2S.js";import{v as Yr}from"./constants-CGf7u7XM.js";var Ee=Uint8Array,Pe=Uint16Array,wr=Uint32Array,Vr=new Ee([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),qr=new Ee([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),oa=new Ee([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Kr=function(i,t){for(var n=new Pe(31),s=0;s<31;++s)n[s]=t+=1<<i[s-1];for(var u=new wr(n[30]),s=1;s<30;++s)for(var h=n[s];h<n[s+1];++h)u[h]=h-n[s]<<5|s;return[n,u]},Qr=Kr(Vr,2),Jr=Qr[0],sa=Qr[1];Jr[28]=258,sa[258]=28;var la=Kr(qr,0),ca=la[0],_r=new Pe(32768);for(var ee=0;ee<32768;++ee){var ke=(ee&43690)>>>1|(ee&21845)<<1;ke=(ke&52428)>>>2|(ke&13107)<<2,ke=(ke&61680)>>>4|(ke&3855)<<4,_r[ee]=((ke&65280)>>>8|(ke&255)<<8)>>>1}var je=(function(i,t,n){for(var s=i.length,u=0,h=new Pe(t);u<s;++u)++h[i[u]-1];var d=new Pe(t);for(u=0;u<t;++u)d[u]=d[u-1]+h[u-1]<<1;var M;if(n){M=new Pe(1<<t);var f=15-t;for(u=0;u<s;++u)if(i[u])for(var g=u<<4|i[u],F=t-i[u],x=d[i[u]-1]++<<F,b=x|(1<<F)-1;x<=b;++x)M[_r[x]>>>f]=g}else for(M=new Pe(s),u=0;u<s;++u)i[u]&&(M[u]=_r[d[i[u]-1]++]>>>15-i[u]);return M}),ar=new Ee(288);for(var ee=0;ee<144;++ee)ar[ee]=8;for(var ee=144;ee<256;++ee)ar[ee]=9;for(var ee=256;ee<280;++ee)ar[ee]=7;for(var ee=280;ee<288;++ee)ar[ee]=8;var jr=new Ee(32);for(var ee=0;ee<32;++ee)jr[ee]=5;var ua=je(ar,9,1),ha=je(jr,5,1),vr=function(i){for(var t=i[0],n=1;n<i.length;++n)i[n]>t&&(t=i[n]);return t},Ce=function(i,t,n){var s=t/8|0;return(i[s]|i[s+1]<<8)>>(t&7)&n},pr=function(i,t){var n=t/8|0;return(i[n]|i[n+1]<<8|i[n+2]<<16)>>(t&7)},da=function(i){return(i/8|0)+(i&7&&1)},va=function(i,t,n){(n==null||n>i.length)&&(n=i.length);var s=new(i instanceof Pe?Pe:i instanceof wr?wr:Ee)(n-t);return s.set(i.subarray(t,n)),s},pa=function(i,t,n){var s=i.length;if(!s||n&&!n.l&&s<5)return t||new Ee(0);var u=!t||n,h=!n||n.i;n||(n={}),t||(t=new Ee(s*3));var d=function(X){var Re=t.length;if(X>Re){var Fe=new Ee(Math.max(Re*2,X));Fe.set(t),t=Fe}},M=n.f||0,f=n.p||0,g=n.b||0,F=n.l,x=n.d,b=n.m,B=n.n,z=s*8;do{if(!F){n.f=M=Ce(i,f,1);var se=Ce(i,f+1,3);if(f+=3,se)if(se==1)F=ua,x=ha,b=9,B=5;else if(se==2){var ue=Ce(i,f,31)+257,le=Ce(i,f+10,15)+4,P=ue+Ce(i,f+5,31)+1;f+=14;for(var U=new Ee(P),q=new Ee(19),E=0;E<le;++E)q[oa[E]]=Ce(i,f+E*3,7);f+=le*3;for(var I=vr(q),H=(1<<I)-1,$=je(q,I,1),E=0;E<P;){var L=$[Ce(i,f,H)];f+=L&15;var G=L>>>4;if(G<16)U[E++]=G;else{var Z=0,R=0;for(G==16?(R=3+Ce(i,f,3),f+=2,Z=U[E-1]):G==17?(R=3+Ce(i,f,7),f+=3):G==18&&(R=11+Ce(i,f,127),f+=7);R--;)U[E++]=Z}}var re=U.subarray(0,ue),O=U.subarray(ue);b=vr(re),B=vr(O),F=je(re,b,1),x=je(O,B,1)}else throw"invalid block type";else{var G=da(f)+4,ne=i[G-4]|i[G-3]<<8,ie=G+ne;if(ie>s){if(h)throw"unexpected EOF";break}u&&d(g+ne),t.set(i.subarray(G,ie),g),n.b=g+=ne,n.p=f=ie*8;continue}if(f>z){if(h)throw"unexpected EOF";break}}u&&d(g+131072);for(var Se=(1<<b)-1,Le=(1<<B)-1,Ie=f;;Ie=f){var Z=F[pr(i,f)&Se],J=Z>>>4;if(f+=Z&15,f>z){if(h)throw"unexpected EOF";break}if(!Z)throw"invalid length/literal";if(J<256)t[g++]=J;else if(J==256){Ie=f,F=null;break}else{var Oe=J-254;if(J>264){var E=J-257,te=Vr[E];Oe=Ce(i,f,(1<<te)-1)+Jr[E],f+=te}var de=x[pr(i,f)&Le],Te=de>>>4;if(!de)throw"invalid distance";f+=de&15;var O=ca[Te];if(Te>3){var te=qr[Te];O+=pr(i,f)&(1<<te)-1,f+=te}if(f>z){if(h)throw"unexpected EOF";break}u&&d(g+131072);for(var $e=g+Oe;g<$e;g+=4)t[g]=t[g-O],t[g+1]=t[g+1-O],t[g+2]=t[g+2-O],t[g+3]=t[g+3-O];g=$e}}n.l=F,n.p=Ie,n.b=g,F&&(M=1,n.m=b,n.d=x,n.n=B)}while(!M);return g==t.length?t:va(t,0,g)},fa=new Ee(0),ga=function(i){if((i[0]&15)!=8||i[0]>>>4>7||(i[0]<<8|i[1])%31)throw"invalid zlib data";if(i[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function or(i,t){return pa((ga(i),i.subarray(2,-4)),t)}var ma=typeof TextDecoder<"u"&&new TextDecoder,wa=0;try{ma.decode(fa,{stream:!0}),wa=1}catch{}const _a=i=>i&&i.isCubeTexture;class ya extends yr{constructor(t,n){var s,u;const h=_a(t),M=((u=h?(s=t.image[0])==null?void 0:s.width:t.image.width)!=null?u:1024)/4,f=Math.floor(Math.log2(M)),g=Math.pow(2,f),F=3*Math.max(g,112),x=4*g,b=[h?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/F}`,`#define CUBEUV_TEXEL_HEIGHT ${1/x}`,`#define CUBEUV_MAX_MIP ${f}.0`],B=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,z=b.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${Yr>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,se={map:{value:t},height:{value:n?.height||15},radius:{value:n?.radius||100}},G=new Lt(1,16),ne=new Er({uniforms:se,fragmentShader:z,vertexShader:B,side:Ht});super(G,ne)}set radius(t){this.material.uniforms.radius.value=t}get radius(){return this.material.uniforms.radius.value}set height(t){this.material.uniforms.height.value=t}get height(){return this.material.uniforms.height.value}}class Ea extends Zr{constructor(t){super(t),this.type=Me}parse(t){const d=function(E,I){switch(E){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(I||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(I||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(I||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(I||""))}},x=function(E,I,H){I=I||1024;let L=E.pos,Z=-1,R=0,re="",O=String.fromCharCode.apply(null,new Uint16Array(E.subarray(L,L+128)));for(;0>(Z=O.indexOf(`
`))&&R<I&&L<E.byteLength;)re+=O,R+=O.length,L+=128,O+=String.fromCharCode.apply(null,new Uint16Array(E.subarray(L,L+128)));return-1<Z?(E.pos+=R+Z+1,re+O.slice(0,Z)):!1},b=function(E){const I=/^#\?(\S+)/,H=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,$=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,L=/^\s*FORMAT=(\S+)\s*$/,Z=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,R={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let re,O;for((E.pos>=E.byteLength||!(re=x(E)))&&d(1,"no header found"),(O=re.match(I))||d(3,"bad initial token"),R.valid|=1,R.programtype=O[1],R.string+=re+`
`;re=x(E),re!==!1;){if(R.string+=re+`
`,re.charAt(0)==="#"){R.comments+=re+`
`;continue}if((O=re.match(H))&&(R.gamma=parseFloat(O[1])),(O=re.match($))&&(R.exposure=parseFloat(O[1])),(O=re.match(L))&&(R.valid|=2,R.format=O[1]),(O=re.match(Z))&&(R.valid|=4,R.height=parseInt(O[1],10),R.width=parseInt(O[2],10)),R.valid&2&&R.valid&4)break}return R.valid&2||d(3,"missing format specifier"),R.valid&4||d(3,"missing image size specifier"),R},B=function(E,I,H){const $=I;if($<8||$>32767||E[0]!==2||E[1]!==2||E[2]&128)return new Uint8Array(E);$!==(E[2]<<8|E[3])&&d(3,"wrong scanline width");const L=new Uint8Array(4*I*H);L.length||d(4,"unable to allocate buffer space");let Z=0,R=0;const re=4*$,O=new Uint8Array(4),Se=new Uint8Array(re);let Le=H;for(;Le>0&&R<E.byteLength;){R+4>E.byteLength&&d(1),O[0]=E[R++],O[1]=E[R++],O[2]=E[R++],O[3]=E[R++],(O[0]!=2||O[1]!=2||(O[2]<<8|O[3])!=$)&&d(3,"bad rgbe scanline format");let Ie=0,J;for(;Ie<re&&R<E.byteLength;){J=E[R++];const te=J>128;if(te&&(J-=128),(J===0||Ie+J>re)&&d(3,"bad scanline data"),te){const de=E[R++];for(let Te=0;Te<J;Te++)Se[Ie++]=de}else Se.set(E.subarray(R,R+J),Ie),Ie+=J,R+=J}const Oe=$;for(let te=0;te<Oe;te++){let de=0;L[Z]=Se[te+de],de+=$,L[Z+1]=Se[te+de],de+=$,L[Z+2]=Se[te+de],de+=$,L[Z+3]=Se[te+de],Z+=4}Le--}return L},z=function(E,I,H,$){const L=E[I+3],Z=Math.pow(2,L-128)/255;H[$+0]=E[I+0]*Z,H[$+1]=E[I+1]*Z,H[$+2]=E[I+2]*Z,H[$+3]=1},se=function(E,I,H,$){const L=E[I+3],Z=Math.pow(2,L-128)/255;H[$+0]=Ge.toHalfFloat(Math.min(E[I+0]*Z,65504)),H[$+1]=Ge.toHalfFloat(Math.min(E[I+1]*Z,65504)),H[$+2]=Ge.toHalfFloat(Math.min(E[I+2]*Z,65504)),H[$+3]=Ge.toHalfFloat(1)},G=new Uint8Array(t);G.pos=0;const ne=b(G),ie=ne.width,ue=ne.height,le=B(G.subarray(G.pos),ie,ue);let P,U,q;switch(this.type){case Ne:q=le.length/4;const E=new Float32Array(q*4);for(let H=0;H<q;H++)z(le,H*4,E,H*4);P=E,U=Ne;break;case Me:q=le.length/4;const I=new Uint16Array(q*4);for(let H=0;H<q;H++)se(le,H*4,I,H*4);P=I,U=Me;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:ie,height:ue,data:P,header:ne.string,gamma:ne.gamma,exposure:ne.exposure,type:U}}setDataType(t){return this.type=t,this}load(t,n,s,u){function h(d,M){switch(d.type){case Ne:case Me:"colorSpace"in d?d.colorSpace="srgb-linear":d.encoding=3e3,d.minFilter=xe,d.magFilter=xe,d.generateMipmaps=!1,d.flipY=!0;break}n&&n(d,M)}return super.load(t,h,s,u)}}const Qe=Yr>=152;class Ma extends Zr{constructor(t){super(t),this.type=Me}parse(t){const I=Math.pow(2.7182818,2.2);function H(e,r){for(var a=0,o=0;o<65536;++o)(o==0||e[o>>3]&1<<(o&7))&&(r[a++]=o);for(var l=a-1;a<65536;)r[a++]=0;return l}function $(e){for(var r=0;r<16384;r++)e[r]={},e[r].len=0,e[r].lit=0,e[r].p=null}const L={l:0,c:0,lc:0};function Z(e,r,a,o,l){for(;a<e;)r=r<<8|Dr(o,l),a+=8;a-=e,L.l=r>>a&(1<<e)-1,L.c=r,L.lc=a}const R=new Array(59);function re(e){for(var r=0;r<=58;++r)R[r]=0;for(var r=0;r<65537;++r)R[e[r]]+=1;for(var a=0,r=58;r>0;--r){var o=a+R[r]>>1;R[r]=a,a=o}for(var r=0;r<65537;++r){var l=e[r];l>0&&(e[r]=l|R[l]++<<6)}}function O(e,r,a,o,l,c,p){for(var v=a,_=0,w=0;l<=c;l++){if(v.value-a.value>o)return!1;Z(6,_,w,e,v);var y=L.l;if(_=L.c,w=L.lc,p[l]=y,y==63){if(v.value-a.value>o)throw"Something wrong with hufUnpackEncTable";Z(8,_,w,e,v);var m=L.l+6;if(_=L.c,w=L.lc,l+m>c+1)throw"Something wrong with hufUnpackEncTable";for(;m--;)p[l++]=0;l--}else if(y>=59){var m=y-59+2;if(l+m>c+1)throw"Something wrong with hufUnpackEncTable";for(;m--;)p[l++]=0;l--}}re(p)}function Se(e){return e&63}function Le(e){return e>>6}function Ie(e,r,a,o){for(;r<=a;r++){var l=Le(e[r]),c=Se(e[r]);if(l>>c)throw"Invalid table entry";if(c>14){var p=o[l>>c-14];if(p.len)throw"Invalid table entry";if(p.lit++,p.p){var v=p.p;p.p=new Array(p.lit);for(var _=0;_<p.lit-1;++_)p.p[_]=v[_]}else p.p=new Array(1);p.p[p.lit-1]=r}else if(c)for(var w=0,_=1<<14-c;_>0;_--){var p=o[(l<<14-c)+w];if(p.len||p.p)throw"Invalid table entry";p.len=c,p.lit=r,w++}}return!0}const J={c:0,lc:0};function Oe(e,r,a,o){e=e<<8|Dr(a,o),r+=8,J.c=e,J.lc=r}const te={c:0,lc:0};function de(e,r,a,o,l,c,p,v,_,w){if(e==r){o<8&&(Oe(a,o,l,p),a=J.c,o=J.lc),o-=8;var y=a>>o,y=new Uint8Array([y])[0];if(_.value+y>w)return!1;for(var m=v[_.value-1];y-- >0;)v[_.value++]=m}else if(_.value<w)v[_.value++]=e;else return!1;te.c=a,te.lc=o}function Te(e){return e&65535}function $e(e){var r=Te(e);return r>32767?r-65536:r}const X={a:0,b:0};function Re(e,r){var a=$e(e),o=$e(r),l=o,c=a+(l&1)+(l>>1),p=c,v=c-l;X.a=p,X.b=v}function Fe(e,r){var a=Te(e),o=Te(r),l=a-(o>>1)&65535,c=o+l-32768&65535;X.a=c,X.b=l}function ot(e,r,a,o,l,c,p){for(var v=p<16384,_=a>l?l:a,w=1,y;w<=_;)w<<=1;for(w>>=1,y=w,w>>=1;w>=1;){for(var m=0,oe=m+c*(l-y),C=c*w,T=c*y,A=o*w,N=o*y,Y,K,ce,fe;m<=oe;m+=T){for(var Q=m,be=m+o*(a-y);Q<=be;Q+=N){var j=Q+A,he=Q+C,Ae=he+A;v?(Re(e[Q+r],e[he+r]),Y=X.a,ce=X.b,Re(e[j+r],e[Ae+r]),K=X.a,fe=X.b,Re(Y,K),e[Q+r]=X.a,e[j+r]=X.b,Re(ce,fe),e[he+r]=X.a,e[Ae+r]=X.b):(Fe(e[Q+r],e[he+r]),Y=X.a,ce=X.b,Fe(e[j+r],e[Ae+r]),K=X.a,fe=X.b,Fe(Y,K),e[Q+r]=X.a,e[j+r]=X.b,Fe(ce,fe),e[he+r]=X.a,e[Ae+r]=X.b)}if(a&w){var he=Q+C;v?Re(e[Q+r],e[he+r]):Fe(e[Q+r],e[he+r]),Y=X.a,e[he+r]=X.b,e[Q+r]=Y}}if(l&w)for(var Q=m,be=m+o*(a-y);Q<=be;Q+=N){var j=Q+A;v?Re(e[Q+r],e[j+r]):Fe(e[Q+r],e[j+r]),Y=X.a,e[j+r]=X.b,e[Q+r]=Y}y=w,w>>=1}return m}function st(e,r,a,o,l,c,p,v,_,w){for(var y=0,m=0,oe=v,C=Math.trunc(l.value+(c+7)/8);l.value<C;)for(Oe(y,m,a,l),y=J.c,m=J.lc;m>=14;){var T=y>>m-14&16383,A=r[T];if(A.len)m-=A.len,de(A.lit,p,y,m,a,o,l,_,w,oe),y=te.c,m=te.lc;else{if(!A.p)throw"hufDecode issues";var N;for(N=0;N<A.lit;N++){for(var Y=Se(e[A.p[N]]);m<Y&&l.value<C;)Oe(y,m,a,l),y=J.c,m=J.lc;if(m>=Y&&Le(e[A.p[N]])==(y>>m-Y&(1<<Y)-1)){m-=Y,de(A.p[N],p,y,m,a,o,l,_,w,oe),y=te.c,m=te.lc;break}}if(N==A.lit)throw"hufDecode issues"}}var K=8-c&7;for(y>>=K,m-=K;m>0;){var A=r[y<<14-m&16383];if(A.len)m-=A.len,de(A.lit,p,y,m,a,o,l,_,w,oe),y=te.c,m=te.lc;else throw"hufDecode issues"}return!0}function Rr(e,r,a,o,l,c){var p={value:0},v=a.value,_=ge(r,a),w=ge(r,a);a.value+=4;var y=ge(r,a);if(a.value+=4,_<0||_>=65537||w<0||w>=65537)throw"Something wrong with HUF_ENCSIZE";var m=new Array(65537),oe=new Array(16384);$(oe);var C=o-(a.value-v);if(O(e,r,a,C,_,w,m),y>8*(o-(a.value-v)))throw"Something wrong with hufUncompress";Ie(m,_,w,oe),st(m,oe,e,r,a,y,w,c,l,p)}function lt(e,r,a){for(var o=0;o<a;++o)r[o]=e[r[o]]}function Fr(e){for(var r=1;r<e.length;r++){var a=e[r-1]+e[r]-128;e[r]=a}}function Ar(e,r){for(var a=0,o=Math.floor((e.length+1)/2),l=0,c=e.length-1;!(l>c||(r[l++]=e[a++],l>c));)r[l++]=e[o++]}function Ur(e){for(var r=e.byteLength,a=new Array,o=0,l=new DataView(e);r>0;){var c=l.getInt8(o++);if(c<0){var p=-c;r-=p+1;for(var v=0;v<p;v++)a.push(l.getUint8(o++))}else{var p=c;r-=2;for(var _=l.getUint8(o++),v=0;v<p+1;v++)a.push(_)}}return a}function ct(e,r,a,o,l,c){var j=new DataView(c.buffer),p=a[e.idx[0]].width,v=a[e.idx[0]].height,_=3,w=Math.floor(p/8),y=Math.ceil(p/8),m=Math.ceil(v/8),oe=p-(y-1)*8,C=v-(m-1)*8,T={value:0},A=new Array(_),N=new Array(_),Y=new Array(_),K=new Array(_),ce=new Array(_);for(let V=0;V<_;++V)ce[V]=r[e.idx[V]],A[V]=V<1?0:A[V-1]+y*m,N[V]=new Float32Array(64),Y[V]=new Uint16Array(64),K[V]=new Uint16Array(y*64);for(let V=0;V<m;++V){var fe=8;V==m-1&&(fe=C);var Q=8;for(let ae=0;ae<y;++ae){ae==y-1&&(Q=oe);for(let W=0;W<_;++W)Y[W].fill(0),Y[W][0]=l[A[W]++],ut(T,o,Y[W]),ht(Y[W],N[W]),dt(N[W]);vt(N);for(let W=0;W<_;++W)pt(N[W],K[W],ae*64)}let pe=0;for(let ae=0;ae<_;++ae){const W=a[e.idx[ae]].type;for(let ye=8*V;ye<8*V+fe;++ye){pe=ce[ae][ye];for(let He=0;He<w;++He){const me=He*64+(ye&7)*8;j.setUint16(pe+0*W,K[ae][me+0],!0),j.setUint16(pe+2*W,K[ae][me+1],!0),j.setUint16(pe+4*W,K[ae][me+2],!0),j.setUint16(pe+6*W,K[ae][me+3],!0),j.setUint16(pe+8*W,K[ae][me+4],!0),j.setUint16(pe+10*W,K[ae][me+5],!0),j.setUint16(pe+12*W,K[ae][me+6],!0),j.setUint16(pe+14*W,K[ae][me+7],!0),pe+=16*W}}if(w!=y)for(let ye=8*V;ye<8*V+fe;++ye){const He=ce[ae][ye]+8*w*2*W,me=w*64+(ye&7)*8;for(let De=0;De<Q;++De)j.setUint16(He+De*2*W,K[ae][me+De],!0)}}}for(var be=new Uint16Array(p),j=new DataView(c.buffer),he=0;he<_;++he){a[e.idx[he]].decoded=!0;var Ae=a[e.idx[he]].type;if(a[he].type==2)for(var Ke=0;Ke<v;++Ke){const V=ce[he][Ke];for(var _e=0;_e<p;++_e)be[_e]=j.getUint16(V+_e*2*Ae,!0);for(var _e=0;_e<p;++_e)j.setFloat32(V+_e*2*Ae,S(be[_e]),!0)}}}function ut(e,r,a){for(var o,l=1;l<64;)o=r[e.value],o==65280?l=64:o>>8==255?l+=o&255:(a[l]=o,l++),e.value++}function ht(e,r){r[0]=S(e[0]),r[1]=S(e[1]),r[2]=S(e[5]),r[3]=S(e[6]),r[4]=S(e[14]),r[5]=S(e[15]),r[6]=S(e[27]),r[7]=S(e[28]),r[8]=S(e[2]),r[9]=S(e[4]),r[10]=S(e[7]),r[11]=S(e[13]),r[12]=S(e[16]),r[13]=S(e[26]),r[14]=S(e[29]),r[15]=S(e[42]),r[16]=S(e[3]),r[17]=S(e[8]),r[18]=S(e[12]),r[19]=S(e[17]),r[20]=S(e[25]),r[21]=S(e[30]),r[22]=S(e[41]),r[23]=S(e[43]),r[24]=S(e[9]),r[25]=S(e[11]),r[26]=S(e[18]),r[27]=S(e[24]),r[28]=S(e[31]),r[29]=S(e[40]),r[30]=S(e[44]),r[31]=S(e[53]),r[32]=S(e[10]),r[33]=S(e[19]),r[34]=S(e[23]),r[35]=S(e[32]),r[36]=S(e[39]),r[37]=S(e[45]),r[38]=S(e[52]),r[39]=S(e[54]),r[40]=S(e[20]),r[41]=S(e[22]),r[42]=S(e[33]),r[43]=S(e[38]),r[44]=S(e[46]),r[45]=S(e[51]),r[46]=S(e[55]),r[47]=S(e[60]),r[48]=S(e[21]),r[49]=S(e[34]),r[50]=S(e[37]),r[51]=S(e[47]),r[52]=S(e[50]),r[53]=S(e[56]),r[54]=S(e[59]),r[55]=S(e[61]),r[56]=S(e[35]),r[57]=S(e[36]),r[58]=S(e[48]),r[59]=S(e[49]),r[60]=S(e[57]),r[61]=S(e[58]),r[62]=S(e[62]),r[63]=S(e[63])}function dt(e){const r=.5*Math.cos(.7853975),a=.5*Math.cos(3.14159/16),o=.5*Math.cos(3.14159/8),l=.5*Math.cos(3*3.14159/16),c=.5*Math.cos(5*3.14159/16),p=.5*Math.cos(3*3.14159/8),v=.5*Math.cos(7*3.14159/16);for(var _=new Array(4),w=new Array(4),y=new Array(4),m=new Array(4),oe=0;oe<8;++oe){var C=oe*8;_[0]=o*e[C+2],_[1]=p*e[C+2],_[2]=o*e[C+6],_[3]=p*e[C+6],w[0]=a*e[C+1]+l*e[C+3]+c*e[C+5]+v*e[C+7],w[1]=l*e[C+1]-v*e[C+3]-a*e[C+5]-c*e[C+7],w[2]=c*e[C+1]-a*e[C+3]+v*e[C+5]+l*e[C+7],w[3]=v*e[C+1]-c*e[C+3]+l*e[C+5]-a*e[C+7],y[0]=r*(e[C+0]+e[C+4]),y[3]=r*(e[C+0]-e[C+4]),y[1]=_[0]+_[3],y[2]=_[1]-_[2],m[0]=y[0]+y[1],m[1]=y[3]+y[2],m[2]=y[3]-y[2],m[3]=y[0]-y[1],e[C+0]=m[0]+w[0],e[C+1]=m[1]+w[1],e[C+2]=m[2]+w[2],e[C+3]=m[3]+w[3],e[C+4]=m[3]-w[3],e[C+5]=m[2]-w[2],e[C+6]=m[1]-w[1],e[C+7]=m[0]-w[0]}for(var T=0;T<8;++T)_[0]=o*e[16+T],_[1]=p*e[16+T],_[2]=o*e[48+T],_[3]=p*e[48+T],w[0]=a*e[8+T]+l*e[24+T]+c*e[40+T]+v*e[56+T],w[1]=l*e[8+T]-v*e[24+T]-a*e[40+T]-c*e[56+T],w[2]=c*e[8+T]-a*e[24+T]+v*e[40+T]+l*e[56+T],w[3]=v*e[8+T]-c*e[24+T]+l*e[40+T]-a*e[56+T],y[0]=r*(e[T]+e[32+T]),y[3]=r*(e[T]-e[32+T]),y[1]=_[0]+_[3],y[2]=_[1]-_[2],m[0]=y[0]+y[1],m[1]=y[3]+y[2],m[2]=y[3]-y[2],m[3]=y[0]-y[1],e[0+T]=m[0]+w[0],e[8+T]=m[1]+w[1],e[16+T]=m[2]+w[2],e[24+T]=m[3]+w[3],e[32+T]=m[3]-w[3],e[40+T]=m[2]-w[2],e[48+T]=m[1]-w[1],e[56+T]=m[0]-w[0]}function vt(e){for(var r=0;r<64;++r){var a=e[0][r],o=e[1][r],l=e[2][r];e[0][r]=a+1.5747*l,e[1][r]=a-.1873*o-.4682*l,e[2][r]=a+1.8556*o}}function pt(e,r,a){for(var o=0;o<64;++o)r[a+o]=Ge.toHalfFloat(ft(e[o]))}function ft(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(I,Math.abs(e)-1)}function Nr(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function gt(e){var r=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),a=new Uint8Array(Ur(r)),o=new Uint8Array(a.length);return Fr(a),Ar(a,o),new DataView(o.buffer)}function dr(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),a=or(r),o=new Uint8Array(a.length);return Fr(a),Ar(a,o),new DataView(o.buffer)}function mt(e){for(var r=e.viewer,a={value:e.offset.value},o=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),l=new Uint8Array(8192),c=0,p=new Array(e.channels),v=0;v<e.channels;v++)p[v]={},p[v].start=c,p[v].end=p[v].start,p[v].nx=e.width,p[v].ny=e.lines,p[v].size=e.type,c+=p[v].nx*p[v].ny*p[v].size;var _=Ye(r,a),w=Ye(r,a);if(w>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(_<=w)for(var v=0;v<w-_+1;v++)l[v+_]=ze(r,a);var y=new Uint16Array(65536),m=H(l,y),oe=ge(r,a);Rr(e.array,r,a,oe,o,c);for(var v=0;v<e.channels;++v)for(var C=p[v],T=0;T<p[v].size;++T)ot(o,C.start+T,C.nx,C.size,C.ny,C.nx*C.size,m);lt(y,o,c);for(var A=0,N=new Uint8Array(o.buffer.byteLength),Y=0;Y<e.lines;Y++)for(var K=0;K<e.channels;K++){var C=p[K],ce=C.nx*C.size,fe=new Uint8Array(o.buffer,C.end*2,ce*2);N.set(fe,A),A+=ce*2,C.end+=ce}return new DataView(N.buffer)}function wt(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),a=or(r);const o=e.lines*e.channels*e.width,l=e.type==1?new Uint16Array(o):new Uint32Array(o);let c=0,p=0;const v=new Array(4);for(let _=0;_<e.lines;_++)for(let w=0;w<e.channels;w++){let y=0;switch(e.type){case 1:v[0]=c,v[1]=v[0]+e.width,c=v[1]+e.width;for(let m=0;m<e.width;++m){const oe=a[v[0]++]<<8|a[v[1]++];y+=oe,l[p]=y,p++}break;case 2:v[0]=c,v[1]=v[0]+e.width,v[2]=v[1]+e.width,c=v[2]+e.width;for(let m=0;m<e.width;++m){const oe=a[v[0]++]<<24|a[v[1]++]<<16|a[v[2]++]<<8;y+=oe,l[p]=y,p++}break}}return new DataView(l.buffer)}function Or(e){var r=e.viewer,a={value:e.offset.value},o=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),l={version:we(r,a),unknownUncompressedSize:we(r,a),unknownCompressedSize:we(r,a),acCompressedSize:we(r,a),dcCompressedSize:we(r,a),rleCompressedSize:we(r,a),rleUncompressedSize:we(r,a),rleRawSize:we(r,a),totalAcUncompressedCount:we(r,a),totalDcUncompressedCount:we(r,a),acCompression:we(r,a)};if(l.version<2)throw"EXRLoader.parse: "+qe.compression+" version "+l.version+" is unsupported";for(var c=new Array,p=Ye(r,a)-2;p>0;){var v=nr(r.buffer,a),_=ze(r,a),w=_>>2&3,y=(_>>4)-1,m=new Int8Array([y])[0],oe=ze(r,a);c.push({name:v,index:m,type:oe,compression:w}),p-=v.length+3}for(var C=qe.channels,T=new Array(e.channels),A=0;A<e.channels;++A){var N=T[A]={},Y=C[A];N.name=Y.name,N.compression=0,N.decoded=!1,N.type=Y.pixelType,N.pLinear=Y.pLinear,N.width=e.width,N.height=e.lines}for(var K={idx:new Array(3)},ce=0;ce<e.channels;++ce)for(var N=T[ce],A=0;A<c.length;++A){var fe=c[A];N.name==fe.name&&(N.compression=fe.compression,fe.index>=0&&(K.idx[fe.index]=ce),N.offset=ce)}if(l.acCompressedSize>0)switch(l.acCompression){case 0:var j=new Uint16Array(l.totalAcUncompressedCount);Rr(e.array,r,a,l.acCompressedSize,j,l.totalAcUncompressedCount);break;case 1:var Q=e.array.slice(a.value,a.value+l.totalAcUncompressedCount),be=or(Q),j=new Uint16Array(be.buffer);a.value+=l.totalAcUncompressedCount;break}if(l.dcCompressedSize>0){var he={array:e.array,offset:a,size:l.dcCompressedSize},Ae=new Uint16Array(dr(he).buffer);a.value+=l.dcCompressedSize}if(l.rleRawSize>0){var Q=e.array.slice(a.value,a.value+l.rleCompressedSize),be=or(Q),Ke=Ur(be.buffer);a.value+=l.rleCompressedSize}for(var _e=0,V=new Array(T.length),A=0;A<V.length;++A)V[A]=new Array;for(var pe=0;pe<e.lines;++pe)for(var ae=0;ae<T.length;++ae)V[ae].push(_e),_e+=T[ae].width*e.type*2;ct(K,V,T,j,Ae,o);for(var A=0;A<T.length;++A){var N=T[A];if(!N.decoded)switch(N.compression){case 2:for(var W=0,ye=0,pe=0;pe<e.lines;++pe){for(var He=V[A][W],me=0;me<N.width;++me){for(var De=0;De<2*N.type;++De)o[He++]=Ke[ye+De*N.width*N.height];ye++}W++}break;default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(o.buffer)}function nr(e,r){for(var a=new Uint8Array(e),o=0;a[r.value+o]!=0;)o+=1;var l=new TextDecoder().decode(a.slice(r.value,r.value+o));return r.value=r.value+o+1,l}function _t(e,r,a){var o=new TextDecoder().decode(new Uint8Array(e).slice(r.value,r.value+a));return r.value=r.value+a,o}function yt(e,r){var a=Xe(e,r),o=ge(e,r);return[a,o]}function Et(e,r){var a=ge(e,r),o=ge(e,r);return[a,o]}function Xe(e,r){var a=e.getInt32(r.value,!0);return r.value=r.value+4,a}function ge(e,r){var a=e.getUint32(r.value,!0);return r.value=r.value+4,a}function Dr(e,r){var a=e[r.value];return r.value=r.value+1,a}function ze(e,r){var a=e.getUint8(r.value);return r.value=r.value+1,a}const we=function(e,r){let a;return"getBigInt64"in DataView.prototype?a=Number(e.getBigInt64(r.value,!0)):a=e.getUint32(r.value+4,!0)+Number(e.getUint32(r.value,!0)<<32),r.value+=8,a};function ve(e,r){var a=e.getFloat32(r.value,!0);return r.value+=4,a}function Mt(e,r){return Ge.toHalfFloat(ve(e,r))}function S(e){var r=(e&31744)>>10,a=e&1023;return(e>>15?-1:1)*(r?r===31?a?NaN:1/0:Math.pow(2,r-15)*(1+a/1024):6103515625e-14*(a/1024))}function Ye(e,r){var a=e.getUint16(r.value,!0);return r.value+=2,a}function St(e,r){return S(Ye(e,r))}function It(e,r,a,o){for(var l=a.value,c=[];a.value<l+o-1;){var p=nr(r,a),v=Xe(e,a),_=ze(e,a);a.value+=3;var w=Xe(e,a),y=Xe(e,a);c.push({name:p,pixelType:v,pLinear:_,xSampling:w,ySampling:y})}return a.value+=1,c}function Ct(e,r){var a=ve(e,r),o=ve(e,r),l=ve(e,r),c=ve(e,r),p=ve(e,r),v=ve(e,r),_=ve(e,r),w=ve(e,r);return{redX:a,redY:o,greenX:l,greenY:c,blueX:p,blueY:v,whiteX:_,whiteY:w}}function Tt(e,r){var a=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],o=ze(e,r);return a[o]}function bt(e,r){var a=ge(e,r),o=ge(e,r),l=ge(e,r),c=ge(e,r);return{xMin:a,yMin:o,xMax:l,yMax:c}}function xt(e,r){var a=["INCREASING_Y"],o=ze(e,r);return a[o]}function Rt(e,r){var a=ve(e,r),o=ve(e,r);return[a,o]}function Ft(e,r){var a=ve(e,r),o=ve(e,r),l=ve(e,r);return[a,o,l]}function At(e,r,a,o,l){if(o==="string"||o==="stringvector"||o==="iccProfile")return _t(r,a,l);if(o==="chlist")return It(e,r,a,l);if(o==="chromaticities")return Ct(e,a);if(o==="compression")return Tt(e,a);if(o==="box2i")return bt(e,a);if(o==="lineOrder")return xt(e,a);if(o==="float")return ve(e,a);if(o==="v2f")return Rt(e,a);if(o==="v3f")return Ft(e,a);if(o==="int")return Xe(e,a);if(o==="rational")return yt(e,a);if(o==="timecode")return Et(e,a);if(o==="preview")return a.value+=l,"skipped";a.value+=l}function Ut(e,r,a){const o={};if(e.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";o.version=e.getUint8(4);const l=e.getUint8(5);o.spec={singleTile:!!(l&2),longName:!!(l&4),deepFormat:!!(l&8),multiPart:!!(l&16)},a.value=8;for(var c=!0;c;){var p=nr(r,a);if(p==0)c=!1;else{var v=nr(r,a),_=ge(e,a),w=At(e,r,a,v,_);w===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${v}'.`):o[p]=w}}if((l&-5)!=0)throw console.error("EXRHeader:",o),"THREE.EXRLoader: provided file is currently unsupported.";return o}function Nt(e,r,a,o,l){const c={size:0,viewer:r,array:a,offset:o,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[Qe?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":c.lines=1,c.uncompress=Nr;break;case"RLE_COMPRESSION":c.lines=1,c.uncompress=gt;break;case"ZIPS_COMPRESSION":c.lines=1,c.uncompress=dr;break;case"ZIP_COMPRESSION":c.lines=16,c.uncompress=dr;break;case"PIZ_COMPRESSION":c.lines=32,c.uncompress=mt;break;case"PXR24_COMPRESSION":c.lines=16,c.uncompress=wt;break;case"DWAA_COMPRESSION":c.lines=32,c.uncompress=Or;break;case"DWAB_COMPRESSION":c.lines=256,c.uncompress=Or;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(c.scanlineBlockSize=c.lines,c.type==1)switch(l){case Ne:c.getter=St,c.inputSize=2;break;case Me:c.getter=Ye,c.inputSize=2;break}else if(c.type==2)switch(l){case Ne:c.getter=ve,c.inputSize=4;break;case Me:c.getter=Mt,c.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+c.type+" for "+e.compression+".";c.blockCount=(e.dataWindow.yMax+1)/c.scanlineBlockSize;for(var p=0;p<c.blockCount;p++)we(r,o);c.outputChannels=c.channels==3?4:c.channels;const v=c.width*c.height*c.outputChannels;switch(l){case Ne:c.byteArray=new Float32Array(v),c.channels<c.outputChannels&&c.byteArray.fill(1,0,v);break;case Me:c.byteArray=new Uint16Array(v),c.channels<c.outputChannels&&c.byteArray.fill(15360,0,v);break;default:console.error("THREE.EXRLoader: unsupported type: ",l);break}return c.bytesPerLine=c.width*c.inputSize*c.channels,c.outputChannels==4?c.format=rr:c.format=zt,Qe?c.colorSpace="srgb-linear":c.encoding=3e3,c}const ir=new DataView(t),Ot=new Uint8Array(t),Ve={value:0},qe=Ut(ir,t,Ve),D=Nt(qe,ir,Ot,Ve,this.type),kr={value:0},Dt={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<D.height/D.scanlineBlockSize;e++){const r=ge(ir,Ve);D.size=ge(ir,Ve),D.lines=r+D.scanlineBlockSize>D.height?D.height-r:D.scanlineBlockSize;const o=D.size<D.lines*D.bytesPerLine?D.uncompress(D):Nr(D);Ve.value+=D.size;for(let l=0;l<D.scanlineBlockSize;l++){const c=l+e*D.scanlineBlockSize;if(c>=D.height)break;for(let p=0;p<D.channels;p++){const v=Dt[qe.channels[p].name];for(let _=0;_<D.width;_++){kr.value=(l*(D.channels*D.width)+p*D.width+_)*D.inputSize;const w=(D.height-1-c)*(D.width*D.outputChannels)+_*D.outputChannels+v;D.byteArray[w]=D.getter(o,kr)}}}}return{header:qe,width:D.width,height:D.height,data:D.byteArray,format:D.format,[Qe?"colorSpace":"encoding"]:D[Qe?"colorSpace":"encoding"],type:this.type}}setDataType(t){return this.type=t,this}load(t,n,s,u){function h(d,M){Qe?d.colorSpace=M.colorSpace:d.encoding=M.encoding,d.minFilter=xe,d.magFilter=xe,d.generateMipmaps=!1,d.flipY=!1,n&&n(d,M)}return super.load(t,h,s,u)}}const Sa=Bt({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new Pr,sectionColor:new Pr,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new Ue,worldPlanePosition:new Ue},`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform vec3 worldPlanePosition;
    uniform float fadeDistance;
    uniform bool infiniteGrid;
    uniform bool followCamera;

    void main() {
      localPosition = position.xzy;
      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;
      
      worldPosition = modelMatrix * vec4(localPosition, 1.0);
      if (followCamera) {
        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);
        localPosition = (inverse(modelMatrix) * worldPosition).xyz;
      }

      gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
  `,`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform float cellSize;
    uniform float sectionSize;
    uniform vec3 cellColor;
    uniform vec3 sectionColor;
    uniform float fadeDistance;
    uniform float fadeStrength;
    uniform float fadeFrom;
    uniform float cellThickness;
    uniform float sectionThickness;

    float getGrid(float size, float thickness) {
      vec2 r = localPosition.xz / size;
      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
      float line = min(grid.x, grid.y) + 1.0 - thickness;
      return 1.0 - min(line, 1.0);
    }

    void main() {
      float g1 = getGrid(cellSize, cellThickness);
      float g2 = getGrid(sectionSize, sectionThickness);

      vec3 from = worldCamProjPosition*vec3(fadeFrom);
      float dist = distance(from, worldPosition.xyz);
      float d = 1.0 - min(dist / fadeDistance, 1.0);
      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));

      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));
      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);
      if (gl_FragColor.a <= 0.0) discard;

      #include <tonemapping_fragment>
      #include <${Pt>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `),Xa=k.forwardRef(({args:i,cellColor:t="#000000",sectionColor:n="#2080ff",cellSize:s=.5,sectionSize:u=1,followCamera:h=!1,infiniteGrid:d=!1,fadeDistance:M=100,fadeStrength:f=1,fadeFrom:g=1,cellThickness:F=.5,sectionThickness:x=1,side:b=Zt,...B},z)=>{zr({GridMaterial:Sa});const se=k.useRef(null);k.useImperativeHandle(z,()=>se.current,[]);const G=new Gt,ne=new Ue(0,1,0),ie=new Ue(0,0,0);Gr(P=>{G.setFromNormalAndCoplanarPoint(ne,ie).applyMatrix4(se.current.matrixWorld);const U=se.current.material,q=U.uniforms.worldCamProjPosition,E=U.uniforms.worldPlanePosition;G.projectPoint(P.camera.position,q.value),E.value.set(0,0,0).applyMatrix4(se.current.matrixWorld)});const ue={cellSize:s,sectionSize:u,cellColor:t,sectionColor:n,cellThickness:F,sectionThickness:x},le={fadeDistance:M,fadeStrength:f,fadeFrom:g,infiniteGrid:d,followCamera:h};return k.createElement("mesh",fr({ref:se,frustumCulled:!1},B),k.createElement("gridMaterial",fr({transparent:!0,"extensions-derivatives":!0,side:b},ue,le)),k.createElement("planeGeometry",{args:i}))}),et=(i,t,n)=>{let s;switch(i){case mr:s=new Uint8ClampedArray(t*n*4);break;case Me:s=new Uint16Array(t*n*4);break;case Qt:s=new Uint32Array(t*n*4);break;case Kt:s=new Int8Array(t*n*4);break;case qt:s=new Int16Array(t*n*4);break;case Vt:s=new Int32Array(t*n*4);break;case Ne:s=new Float32Array(t*n*4);break;default:throw new Error("Unsupported data type")}return s};let sr;const Ia=(i,t,n,s)=>{if(sr!==void 0)return sr;const u=new Xr(1,1,s);t.setRenderTarget(u);const h=new yr(new $r,new Yt({color:16777215}));t.render(h,n),t.setRenderTarget(null);const d=et(i,u.width,u.height);return t.readRenderTargetPixels(u,0,0,u.width,u.height,d),u.dispose(),h.geometry.dispose(),h.material.dispose(),sr=d[0]!==0,sr};class Mr{_renderer;_rendererIsDisposable=!1;_material;_scene;_camera;_quad;_renderTarget;_width;_height;_type;_colorSpace;_supportsReadPixels=!0;constructor(t){this._width=t.width,this._height=t.height,this._type=t.type,this._colorSpace=t.colorSpace;const n={format:rr,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:t.renderTargetOptions?.anisotropy!==void 0?t.renderTargetOptions?.anisotropy:1,generateMipmaps:t.renderTargetOptions?.generateMipmaps!==void 0?t.renderTargetOptions?.generateMipmaps:!1,magFilter:t.renderTargetOptions?.magFilter!==void 0?t.renderTargetOptions?.magFilter:xe,minFilter:t.renderTargetOptions?.minFilter!==void 0?t.renderTargetOptions?.minFilter:xe,samples:t.renderTargetOptions?.samples!==void 0?t.renderTargetOptions?.samples:void 0,wrapS:t.renderTargetOptions?.wrapS!==void 0?t.renderTargetOptions?.wrapS:Be,wrapT:t.renderTargetOptions?.wrapT!==void 0?t.renderTargetOptions?.wrapT:Be};if(this._material=t.material,t.renderer?this._renderer=t.renderer:(this._renderer=Mr.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new Wr,this._camera=new Wt,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!Ia(this._type,this._renderer,this._camera,n)){let s;this._type===Me&&(s=this._renderer.extensions.has("EXT_color_buffer_float")?Ne:void 0),s!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${Ne}`),this._type=s):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new yr(new $r,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new Xr(this.width,this.height,n),this._renderTarget.texture.mapping=t.renderTargetOptions?.mapping!==void 0?t.renderTargetOptions?.mapping:ur}static instantiateRenderer(){const t=new $t;return t.setSize(128,128),t}render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(t){throw this._renderer.setRenderTarget(null),t}this._renderer.setRenderTarget(null)};toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const t=et(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,t),t}toDataTexture(t){const n=new Xt(this.toArray(),this.width,this.height,rr,this._type,t?.mapping||ur,t?.wrapS||Be,t?.wrapT||Be,t?.magFilter||xe,t?.minFilter||xe,t?.anisotropy||1,gr);return n.generateMipmaps=t?.generateMipmaps!==void 0?t?.generateMipmaps:!1,n}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(t){this.disposeOnDemandRenderer(),t&&this.renderTarget.dispose(),this.material instanceof Er&&Object.values(this.material.uniforms).forEach(n=>{n.value instanceof Ze&&n.value.dispose()}),Object.values(this.material).forEach(n=>{n instanceof Ze&&n.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(t){this._width=t,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(t){this._height=t,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t,this._width=t.width,this._height=t.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}class rt extends Error{}class tt extends Error{}const Je=(i,t,n)=>{const s=new RegExp(`${t}="([^"]*)"`,"i").exec(i);if(s)return s[1];const u=new RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(i);if(u){const h=u[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return h&&h.length===3?h.map(d=>d.replace(/<\/?rdf:li>/g,"")):u[1].trim()}if(n!==void 0)return n;throw new Error(`Can't find ${t} in gainmap metadata`)},Ca=i=>{let t;typeof TextDecoder<"u"?t=new TextDecoder().decode(i):t=i.toString();let n=t.indexOf("<x:xmpmeta");for(;n!==-1;){const s=t.indexOf("x:xmpmeta>",n),u=t.slice(n,s+10);try{const h=Je(u,"hdrgm:GainMapMin","0"),d=Je(u,"hdrgm:GainMapMax"),M=Je(u,"hdrgm:Gamma","1"),f=Je(u,"hdrgm:OffsetSDR","0.015625"),g=Je(u,"hdrgm:OffsetHDR","0.015625"),F=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(u),x=F?F[1]:"0",b=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(u);if(!b)throw new Error("Incomplete gainmap metadata");const B=b[1];return{gainMapMin:Array.isArray(h)?h.map(z=>parseFloat(z)):[parseFloat(h),parseFloat(h),parseFloat(h)],gainMapMax:Array.isArray(d)?d.map(z=>parseFloat(z)):[parseFloat(d),parseFloat(d),parseFloat(d)],gamma:Array.isArray(M)?M.map(z=>parseFloat(z)):[parseFloat(M),parseFloat(M),parseFloat(M)],offsetSdr:Array.isArray(f)?f.map(z=>parseFloat(z)):[parseFloat(f),parseFloat(f),parseFloat(f)],offsetHdr:Array.isArray(g)?g.map(z=>parseFloat(z)):[parseFloat(g),parseFloat(g),parseFloat(g)],hdrCapacityMin:parseFloat(x),hdrCapacityMax:parseFloat(B)}}catch{}n=t.indexOf("<x:xmpmeta",s)}};class Ta{options;constructor(t){this.options={debug:t&&t.debug!==void 0?t.debug:!1,extractFII:t&&t.extractFII!==void 0?t.extractFII:!0,extractNonFII:t&&t.extractNonFII!==void 0?t.extractNonFII:!0}}extract(t){return new Promise((n,s)=>{const u=this.options.debug,h=new DataView(t.buffer);if(h.getUint16(0)!==65496){s(new Error("Not a valid jpeg"));return}const d=h.byteLength;let M=2,f=0,g;for(;M<d;){if(++f>250){s(new Error(`Found no marker after ${f} loops ðŸ˜µ`));return}if(h.getUint8(M)!==255){s(new Error(`Not a valid marker at offset 0x${M.toString(16)}, found: 0x${h.getUint8(M).toString(16)}`));return}if(g=h.getUint8(M+1),u&&console.log(`Marker: ${g.toString(16)}`),g===226){u&&console.log("Found APP2 marker (0xffe2)");const F=M+4;if(h.getUint32(F)===1297106432){const x=F+4;let b;if(h.getUint16(x)===18761)b=!1;else if(h.getUint16(x)===19789)b=!0;else{s(new Error("No valid endianness marker found in TIFF header"));return}if(h.getUint16(x+2,!b)!==42){s(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const B=h.getUint32(x+4,!b);if(B<8){s(new Error("Not valid TIFF data! (First offset less than 8)"));return}const z=x+B,se=h.getUint16(z,!b),G=z+2;let ne=0;for(let P=G;P<G+12*se;P+=12)h.getUint16(P,!b)===45057&&(ne=h.getUint32(P+8,!b));const ue=z+2+se*12+4,le=[];for(let P=ue;P<ue+ne*16;P+=16){const U={MPType:h.getUint32(P,!b),size:h.getUint32(P+4,!b),dataOffset:h.getUint32(P+8,!b),dependantImages:h.getUint32(P+12,!b),start:-1,end:-1,isFII:!1};U.dataOffset?(U.start=x+U.dataOffset,U.isFII=!1):(U.start=0,U.isFII=!0),U.end=U.start+U.size,le.push(U)}if(this.options.extractNonFII&&le.length){const P=new Blob([h]),U=[];for(const q of le){if(q.isFII&&!this.options.extractFII)continue;const E=P.slice(q.start,q.end+1,"image/jpeg");U.push(E)}n(U)}}}M+=2+h.getUint16(M+2)}})}}const ba=async i=>{const t=Ca(i);if(!t)throw new tt("Gain map XMP metadata not found");const s=await new Ta({extractFII:!0,extractNonFII:!0}).extract(i);if(s.length!==2)throw new rt("Gain map recovery image not found");return{sdr:new Uint8Array(await s[0].arrayBuffer()),gainMap:new Uint8Array(await s[1].arrayBuffer()),metadata:t}},Hr=i=>new Promise((t,n)=>{const s=document.createElement("img");s.onload=()=>{t(s)},s.onerror=u=>{n(u)},s.src=URL.createObjectURL(i)});class xa extends Jt{_renderer;_renderTargetOptions;_internalLoadingManager;_config;constructor(t,n){super(n),this._config=t,t.renderer&&(this._renderer=t.renderer),this._internalLoadingManager=new jt}setRenderer(t){return this._renderer=t,this}setRenderTargetOptions(t){return this._renderTargetOptions=t,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: A Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const t=this._config.createMaterial({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new Ze,sdr:new Ze});return this._config.createQuadRenderer({width:16,height:16,type:Me,colorSpace:gr,material:t,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async processImages(t,n,s){const u=n?new Blob([n],{type:"image/jpeg"}):void 0,h=new Blob([t],{type:"image/jpeg"});let d,M,f=!1;if(typeof createImageBitmap>"u"){const g=await Promise.all([u?Hr(u):Promise.resolve(void 0),Hr(h)]);M=g[0],d=g[1],f=s==="flipY"}else{const g=await Promise.all([u?createImageBitmap(u,{imageOrientation:s||"flipY"}):Promise.resolve(void 0),createImageBitmap(h,{imageOrientation:s||"flipY"})]);M=g[0],d=g[1]}return{sdrImage:d,gainMapImage:M,needsFlip:f}}createTextures(t,n,s){const u=new Ze(n||new ImageData(2,2),ur,Be,Be,xe,Lr,rr,mr,1,gr);u.flipY=s,u.needsUpdate=!0;const h=new Ze(t,ur,Be,Be,xe,Lr,rr,mr,1,ea);return h.flipY=s,h.needsUpdate=!0,{gainMap:u,sdr:h}}updateQuadRenderer(t,n,s,u,h){t.width=n.width,t.height=n.height,t.material.gainMap=s,t.material.sdr=u,t.material.gainMapMin=h.gainMapMin,t.material.gainMapMax=h.gainMapMax,t.material.offsetHdr=h.offsetHdr,t.material.offsetSdr=h.offsetSdr,t.material.gamma=h.gamma,t.material.hdrCapacityMin=h.hdrCapacityMin,t.material.hdrCapacityMax=h.hdrCapacityMax,t.material.maxDisplayBoost=Math.pow(2,h.hdrCapacityMax),t.material.needsUpdate=!0}}const Ra=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,Fa=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class Aa extends Er{_maxDisplayBoost;_hdrCapacityMin;_hdrCapacityMax;constructor({gamma:t,offsetHdr:n,offsetSdr:s,gainMapMin:u,gainMapMax:h,maxDisplayBoost:d,hdrCapacityMin:M,hdrCapacityMax:f,sdr:g,gainMap:F}){super({name:"GainMapDecoderMaterial",vertexShader:Ra,fragmentShader:Fa,uniforms:{sdr:{value:g},gainMap:{value:F},gamma:{value:new Ue(1/t[0],1/t[1],1/t[2])},offsetHdr:{value:new Ue().fromArray(n)},offsetSdr:{value:new Ue().fromArray(s)},gainMapMin:{value:new Ue().fromArray(u)},gainMapMax:{value:new Ue().fromArray(h)},weightFactor:{value:(Math.log2(d)-M)/(f-M)}},blending:ra,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=d,this._hdrCapacityMin=M,this._hdrCapacityMax=f,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(t){this.uniforms.sdr.value=t}get gainMap(){return this.uniforms.gainMap.value}set gainMap(t){this.uniforms.gainMap.value=t}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(t){this.uniforms.offsetHdr.value.fromArray(t)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(t){this.uniforms.offsetSdr.value.fromArray(t)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(t){this.uniforms.gainMapMin.value.fromArray(t)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(t){this.uniforms.gainMapMax.value.fromArray(t)}get gamma(){const t=this.uniforms.gamma.value;return[1/t.x,1/t.y,1/t.z]}set gamma(t){const n=this.uniforms.gamma.value;n.x=1/t[0],n.y=1/t[1],n.z=1/t[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(t){this._hdrCapacityMin=t,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(t){this._hdrCapacityMax=t,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(t){this._maxDisplayBoost=Math.max(1,Math.min(65504,t)),this.calculateWeight()}calculateWeight(){const t=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,t))}}class at extends xa{constructor(t,n){super({renderer:t,createMaterial:s=>new Aa(s),createQuadRenderer:s=>new Mr(s)},n)}async render(t,n,s,u){const{sdrImage:h,gainMapImage:d,needsFlip:M}=await this.processImages(s,u,"flipY"),{gainMap:f,sdr:g}=this.createTextures(h,d,M);this.updateQuadRenderer(t,h,f,g,n),t.render()}}class Ua extends at{load([t,n,s],u,h,d){const M=this.prepareQuadRenderer();let f,g,F;const x=async()=>{if(f&&g&&F){try{await this.render(M,F,f,g)}catch(I){this.manager.itemError(t),this.manager.itemError(n),this.manager.itemError(s),typeof d=="function"&&d(I),M.disposeOnDemandRenderer();return}typeof u=="function"&&u(M),this.manager.itemEnd(t),this.manager.itemEnd(n),this.manager.itemEnd(s),M.disposeOnDemandRenderer()}};let b=!0,B=0,z=0,se=!0,G=0,ne=0,ie=!0,ue=0,le=0;const P=()=>{if(typeof h=="function"){const I=B+G+ue,H=z+ne+le,$=b&&se&&ie;h(new ProgressEvent("progress",{lengthComputable:$,loaded:H,total:I}))}};this.manager.itemStart(t),this.manager.itemStart(n),this.manager.itemStart(s);const U=new lr(this._internalLoadingManager);U.setResponseType("arraybuffer"),U.setRequestHeader(this.requestHeader),U.setPath(this.path),U.setWithCredentials(this.withCredentials),U.load(t,async I=>{if(typeof I=="string")throw new Error("Invalid sdr buffer");f=I,await x()},I=>{b=I.lengthComputable,z=I.loaded,B=I.total,P()},I=>{this.manager.itemError(t),typeof d=="function"&&d(I)});const q=new lr(this._internalLoadingManager);q.setResponseType("arraybuffer"),q.setRequestHeader(this.requestHeader),q.setPath(this.path),q.setWithCredentials(this.withCredentials),q.load(n,async I=>{if(typeof I=="string")throw new Error("Invalid gainmap buffer");g=I,await x()},I=>{se=I.lengthComputable,ne=I.loaded,G=I.total,P()},I=>{this.manager.itemError(n),typeof d=="function"&&d(I)});const E=new lr(this._internalLoadingManager);return E.setRequestHeader(this.requestHeader),E.setPath(this.path),E.setWithCredentials(this.withCredentials),E.load(s,async I=>{if(typeof I!="string")throw new Error("Invalid metadata string");F=JSON.parse(I),await x()},I=>{ie=I.lengthComputable,le=I.loaded,ue=I.total,P()},I=>{this.manager.itemError(s),typeof d=="function"&&d(I)}),M}}class Na extends at{load(t,n,s,u){const h=this.prepareQuadRenderer(),d=new lr(this._internalLoadingManager);return d.setResponseType("arraybuffer"),d.setRequestHeader(this.requestHeader),d.setPath(this.path),d.setWithCredentials(this.withCredentials),this.manager.itemStart(t),d.load(t,async M=>{if(typeof M=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const f=new Uint8Array(M);let g,F,x;try{const b=await ba(f);g=b.sdr,F=b.gainMap,x=b.metadata}catch(b){if(b instanceof tt||b instanceof rt)console.warn(`Failure to reconstruct an HDR image from ${t}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),x={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},g=f;else throw b}try{await this.render(h,x,g.buffer,F?.buffer)}catch(b){this.manager.itemError(t),typeof u=="function"&&u(b),h.disposeOnDemandRenderer();return}typeof n=="function"&&n(h),this.manager.itemEnd(t),h.disposeOnDemandRenderer()},s,M=>{this.manager.itemError(t),typeof u=="function"&&u(M)}),h}}const tr={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},nt="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",We=i=>Array.isArray(i),Sr=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function hr({files:i=Sr,path:t="",preset:n=void 0,colorSpace:s=void 0,extensions:u}={}){n&&(Ir(n),i=tr[n],t=nt);const h=We(i),{extension:d,isCubemap:M}=Cr(i),f=Tr(d);if(!f)throw new Error("useEnvironment: Unrecognized file extension: "+i);const g=er(B=>B.gl);k.useLayoutEffect(()=>{if(d!=="webp"&&d!=="jpg"&&d!=="jpeg")return;function B(){cr.clear(f,h?[i]:i)}g.domElement.addEventListener("webglcontextlost",B,{once:!0})},[i,g.domElement]);const F=cr(f,h?[i]:i,B=>{(d==="webp"||d==="jpg"||d==="jpeg")&&B.setRenderer(g),B.setPath==null||B.setPath(t),u&&u(B)});let x=h?F[0]:F;if(d==="jpg"||d==="jpeg"||d==="webp"){var b;x=(b=x.renderTarget)==null?void 0:b.texture}return x.mapping=M?ta:aa,x.colorSpace=s??(M?"srgb":"srgb-linear"),x}const Oa={files:Sr,path:"",preset:void 0,extensions:void 0};hr.preload=i=>{const t={...Oa,...i};let{files:n,path:s=""}=t;const{preset:u,extensions:h}=t;u&&(Ir(u),n=tr[u],s=nt);const{extension:d}=Cr(n);if(d==="webp"||d==="jpg"||d==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const M=Tr(d);if(!M)throw new Error("useEnvironment: Unrecognized file extension: "+n);cr.preload(M,We(n)?[n]:n,f=>{f.setPath==null||f.setPath(s),h&&h(f)})};const Da={files:Sr,preset:void 0};hr.clear=i=>{const t={...Da,...i};let{files:n}=t;const{preset:s}=t;s&&(Ir(s),n=tr[s]);const{extension:u}=Cr(n),h=Tr(u);if(!h)throw new Error("useEnvironment: Unrecognized file extension: "+n);cr.clear(h,We(n)?[n]:n)};function Ir(i){if(!(i in tr))throw new Error("Preset must be one of: "+Object.keys(tr).join(", "))}function Cr(i){var t;const n=We(i)&&i.length===6,s=We(i)&&i.length===3&&i.some(d=>d.endsWith("json")),u=We(i)?i[0]:i;return{extension:n?"cube":s?"webp":u.startsWith("data:application/exr")?"exr":u.startsWith("data:application/hdr")?"hdr":u.startsWith("data:image/jpeg")?"jpg":(t=u.split(".").pop())==null||(t=t.split("?"))==null||(t=t.shift())==null?void 0:t.toLowerCase(),isCubemap:n,isGainmap:s}}function Tr(i){return i==="cube"?na:i==="hdr"?Ea:i==="exr"?Ma:i==="jpg"||i==="jpeg"?Na:i==="webp"?Ua:null}const ka=i=>i.current&&i.current.isScene,Ba=i=>ka(i)?i.current:i;function br(i,t,n,s,u={}){var h,d,M,f;u={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...u};const g=Ba(t||n),F=g.background,x=g.environment,b={backgroundBlurriness:g.backgroundBlurriness,backgroundIntensity:g.backgroundIntensity,backgroundRotation:(h=(d=g.backgroundRotation)==null||d.clone==null?void 0:d.clone())!==null&&h!==void 0?h:[0,0,0],environmentIntensity:g.environmentIntensity,environmentRotation:(M=(f=g.environmentRotation)==null||f.clone==null?void 0:f.clone())!==null&&M!==void 0?M:[0,0,0]};return i!=="only"&&(g.environment=s),i&&(g.background=s),Br(g,u),()=>{i!=="only"&&(g.environment=x),i&&(g.background=F),Br(g,b)}}function xr({scene:i,background:t=!1,map:n,...s}){const u=er(h=>h.scene);return k.useLayoutEffect(()=>{if(n)return br(t,i,u,n,s)}),null}function it({background:i=!1,scene:t,blur:n,backgroundBlurriness:s,backgroundIntensity:u,backgroundRotation:h,environmentIntensity:d,environmentRotation:M,...f}){const g=hr(f),F=er(x=>x.scene);return k.useLayoutEffect(()=>br(i,t,F,g,{backgroundBlurriness:n??s,backgroundIntensity:u,backgroundRotation:h,environmentIntensity:d,environmentRotation:M})),k.useEffect(()=>()=>{g.dispose()},[g]),null}function Pa({children:i,near:t=.1,far:n=1e3,resolution:s=256,frames:u=1,map:h,background:d=!1,blur:M,backgroundBlurriness:f,backgroundIntensity:g,backgroundRotation:F,environmentIntensity:x,environmentRotation:b,scene:B,files:z,path:se,preset:G=void 0,extensions:ne}){const ie=er(E=>E.gl),ue=er(E=>E.scene),le=k.useRef(null),[P]=k.useState(()=>new Wr),U=k.useMemo(()=>{const E=new ia(s);return E.texture.type=Me,E},[s]);k.useEffect(()=>()=>{U.dispose()},[U]),k.useLayoutEffect(()=>{if(u===1){const E=ie.autoClear;ie.autoClear=!0,le.current.update(ie,P),ie.autoClear=E}return br(d,B,ue,U.texture,{backgroundBlurriness:M??f,backgroundIntensity:g,backgroundRotation:F,environmentIntensity:x,environmentRotation:b})},[i,P,U.texture,B,ue,d,u,ie]);let q=1;return Gr(()=>{if(u===1/0||q<u){const E=ie.autoClear;ie.autoClear=!0,le.current.update(ie,P),ie.autoClear=E,q++}}),k.createElement(k.Fragment,null,kt(k.createElement(k.Fragment,null,i,k.createElement("cubeCamera",{ref:le,args:[t,n,U]}),z||G?k.createElement(it,{background:!0,files:z,preset:G,path:se,extensions:ne}):h?k.createElement(xr,{background:!0,map:h,extensions:ne}):null),P))}function La(i){var t,n,s,u;const h=hr(i),d=i.map||h;k.useMemo(()=>zr({GroundProjectedEnvImpl:ya}),[]),k.useEffect(()=>()=>{h.dispose()},[h]);const M=k.useMemo(()=>[d],[d]),f=(t=i.ground)==null?void 0:t.height,g=(n=i.ground)==null?void 0:n.radius,F=(s=(u=i.ground)==null?void 0:u.scale)!==null&&s!==void 0?s:1e3;return k.createElement(k.Fragment,null,k.createElement(xr,fr({},i,{map:d})),k.createElement("groundProjectedEnvImpl",{args:M,scale:F,height:f,radius:g}))}function Ya(i){return i.ground?k.createElement(La,i):i.map?k.createElement(xr,i):i.children?k.createElement(Pa,i):k.createElement(it,i)}export{Ya as E,Xa as G};
