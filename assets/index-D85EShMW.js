import{r,j as e,w as ot}from"./chunk-JMJ3UQ3L-DTa-kQyz.js";import{_ as $e,u as re,a as ce,C as at,O as nt}from"./OrbitControls-Dc9Mpcp3.js";import{c as q}from"./createLucideIcon-DJfiQI6J.js";import{H as it}from"./house-BtsHXS8_.js";import{s as ct,g as lt,r as dt}from"./index-tSOQ2Rud.js";import{_ as De,f as We,h as ut,ai as ft,j as ie,S as Ae,i as ge,aj as pt,u as mt,v as Fe,ak as Ne,x as He,r as _,al as ht,M as Re,V as $,am as oe,g as Ve}from"./three.module-CkFzBGVQ.js";import{G as xt,E as vt}from"./Environment-DKJYQHIy.js";import{C as yt}from"./clock-BKAR4OtO.js";import{S as bt,R as gt,T as wt,C as St,a as Mt}from"./trash-2-AgHRitPU.js";import{X as jt}from"./x-DoNpzKz6.js";import{T as Rt}from"./triangle-alert-b9EnD7-w.js";import"./shaderMaterial-B3TDCXl_.js";import"./constants-CBBPndjW.js";const Ct=[["path",{d:"M8 6v6",key:"18i7km"}],["path",{d:"M15 6v6",key:"1sg6z9"}],["path",{d:"M2 12h19.6",key:"de5uta"}],["path",{d:"M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3",key:"1wwztk"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}],["path",{d:"M9 18h5",key:"lrx6i"}],["circle",{cx:"16",cy:"18",r:"2",key:"1v4tcr"}]],Nt=q("bus",Ct);const kt=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Pt=q("calendar",kt);const Et=[["path",{d:"M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21",key:"g5wo59"}],["path",{d:"m5.082 11.09 8.828 8.828",key:"1wx5vj"}]],Dt=q("eraser",Et);const At=[["path",{d:"M12 16h.01",key:"1drbdi"}],["path",{d:"M16 16h.01",key:"1f9h7w"}],["path",{d:"M3 19a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5a.5.5 0 0 0-.769-.422l-4.462 2.844A.5.5 0 0 1 15 10.5v-2a.5.5 0 0 0-.769-.422L9.77 10.922A.5.5 0 0 1 9 10.5V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z",key:"1iv0i2"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],Tt=q("factory",At);const It=[["path",{d:"m12 14 4-4",key:"9kzdfg"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0",key:"19p75a"}]],Lt=q("gauge",It);const _t=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],zt=q("pencil",_t);const Ot=[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]],Ut=q("route",Ot);const Bt=[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]],Gt=q("shopping-cart",Bt);const $t=[["path",{d:"M10 10v.2A3 3 0 0 1 8.9 16H5a3 3 0 0 1-1-5.8V10a3 3 0 0 1 6 0Z",key:"1l6gj6"}],["path",{d:"M7 16v6",key:"1a82de"}],["path",{d:"M13 19v3",key:"13sx9i"}],["path",{d:"M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .8-1.7L13 3l-1.4 1.5",key:"1sj9kv"}]],Wt=q("trees",$t);const Ft=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],Ht=q("trending-up",Ft);const Vt=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Yt=q("users",Vt);const qt=[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]],Xt=q("wallet",qt),Kt={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},Jt={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `};function Qt(o,l){const b=o+"Geometry";return r.forwardRef(({args:d,children:p,...u},v)=>{const h=r.useRef(null);return r.useImperativeHandle(v,()=>h.current),r.useLayoutEffect(()=>{l?.(h.current)}),r.createElement("mesh",$e({ref:h},u),r.createElement(b,{attach:"geometry",args:d}),p)})}const Zt=Qt("plane"),er=r.forwardRef(({scale:o=10,frames:l=1/0,opacity:b=1,width:d=1,height:p=1,blur:u=1,near:v=0,far:h=10,resolution:S=512,smooth:M=!0,color:j="#000000",depthWrite:U=!1,renderOrder:L,...x},P)=>{const z=r.useRef(null),N=re(m=>m.scene),t=re(m=>m.gl),g=r.useRef(null);d=d*(Array.isArray(o)?o[0]:o||1),p=p*(Array.isArray(o)?o[1]:o||1);const[n,D,k,y,s,f,w]=r.useMemo(()=>{const m=new De(S,S),R=new De(S,S);R.texture.generateMipmaps=m.texture.generateMipmaps=!1;const I=new We(d,p).rotateX(Math.PI/2),Q=new ut(I),V=new ft;V.depthTest=V.depthWrite=!1,V.onBeforeCompile=Z=>{Z.uniforms={...Z.uniforms,ucolor:{value:new ie(j)}},Z.fragmentShader=Z.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),Z.fragmentShader=Z.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const le=new Ae(Kt),xe=new Ae(Jt);return xe.depthTest=le.depthTest=!1,[m,I,V,Q,le,xe,R]},[S,d,p,o,j]),c=m=>{y.visible=!0,y.material=s,s.uniforms.tDiffuse.value=n.texture,s.uniforms.h.value=m*1/256,t.setRenderTarget(w),t.render(y,g.current),y.material=f,f.uniforms.tDiffuse.value=w.texture,f.uniforms.v.value=m*1/256,t.setRenderTarget(n),t.render(y,g.current),y.visible=!1};let a=0,i,O;return ce(()=>{g.current&&(l===1/0||a<l)&&(a++,i=N.background,O=N.overrideMaterial,z.current.visible=!1,N.background=null,N.overrideMaterial=k,t.setRenderTarget(n),t.render(N,g.current),c(u),M&&c(u*.4),t.setRenderTarget(null),z.current.visible=!0,N.overrideMaterial=O,N.background=i)}),r.useImperativeHandle(P,()=>z.current,[]),r.createElement("group",$e({"rotation-x":Math.PI/2},x,{ref:z}),r.createElement("mesh",{renderOrder:L,geometry:D,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},r.createElement("meshBasicMaterial",{transparent:!0,map:n.texture,opacity:b,depthWrite:U})),r.createElement("orthographicCamera",{ref:g,args:[-d/2,d/2,p/2,-p/2,v,h]}))});function tr({pixelated:o}){const l=re(v=>v.gl),b=re(v=>v.internal.active),d=re(v=>v.performance.current),p=re(v=>v.viewport.initialDpr),u=re(v=>v.setDpr);return r.useEffect(()=>{const v=l.domElement;return()=>{b&&u(p),o&&v&&(v.style.imageRendering="auto")}},[]),r.useEffect(()=>{u(d*p),o&&l.domElement&&(l.domElement.style.imageRendering=d===1?"auto":"pixelated")},[d]),null}const rr=r.createContext(null);function sr({iterations:o=10,ms:l=250,threshold:b=.75,step:d=.1,factor:p=.5,flipflops:u=1/0,bounds:v=L=>L>100?[60,100]:[40,60],onIncline:h,onDecline:S,onChange:M,onFallback:j,children:U}){const L=Math.pow(10,0),[x,P]=r.useState(()=>({fps:0,index:0,factor:p,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:N=>{const t=Symbol();return x.subscriptions.set(t,N.current),()=>{x.subscriptions.delete(t)}}}));let z=0;return ce(()=>{const{frames:N,averages:t}=x;if(!x.fallback&&t.length<o){N.push(performance.now());const g=N[N.length-1]-N[0];if(g>=l){if(x.fps=Math.round(N.length/g*1e3*L)/L,x.refreshrate=Math.max(x.refreshrate,x.fps),t[x.index++%o]=x.fps,t.length===o){const[n,D]=v(x.refreshrate),k=t.filter(s=>s>=D),y=t.filter(s=>s<n);k.length>o*b&&(x.factor=Math.min(1,x.factor+d),x.flipped++,h&&h(x),x.subscriptions.forEach(s=>s.onIncline&&s.onIncline(x))),y.length>o*b&&(x.factor=Math.max(0,x.factor-d),x.flipped++,S&&S(x),x.subscriptions.forEach(s=>s.onDecline&&s.onDecline(x))),z!==x.factor&&(z=x.factor,M&&M(x),x.subscriptions.forEach(s=>s.onChange&&s.onChange(x))),x.flipped>u&&!x.fallback&&(x.fallback=!0,j&&j(x),x.subscriptions.forEach(s=>s.onFallback&&s.onFallback(x))),x.averages=[]}x.frames=[]}}}),r.createElement(rr.Provider,{value:x},U)}var C=(o=>(o.EMPTY="EMPTY",o.ROAD="ROAD",o.RESIDENTIAL="RESIDENTIAL",o.COMMERCIAL="COMMERCIAL",o.INDUSTRIAL="INDUSTRIAL",o.PARK="PARK",o.BUS_STOP="BUS_STOP",o))(C||{});const Te={low:{level:"low",shadows:!1,environmentEffects:!1,pixelRatio:1,antialias:!1},medium:{level:"medium",shadows:!0,environmentEffects:!0,pixelRatio:1.5,antialias:!1},high:{level:"high",shadows:!0,environmentEffects:!0,pixelRatio:2,antialias:!0}},A=16,Ie=1,he={[C.EMPTY]:{type:C.EMPTY,cost:0,color:"#2d3748",label:"Bulldoze",icon:Dt,description:"Clear the land for new developments."},[C.ROAD]:{type:C.ROAD,cost:10,color:"#4a5568",label:"Road",icon:Ut,description:"Connect your city. Essential for cars and growth."},[C.RESIDENTIAL]:{type:C.RESIDENTIAL,cost:50,color:"#48bb78",label:"Residential",icon:it,description:"Where your citizens live. Provides population."},[C.COMMERCIAL]:{type:C.COMMERCIAL,cost:80,color:"#4299e1",label:"Commercial",icon:Gt,description:"Stores and offices. Boosts city income and development."},[C.INDUSTRIAL]:{type:C.INDUSTRIAL,cost:120,color:"#ecc94b",label:"Industrial",icon:Tt,description:"Factories and production. High income generation."},[C.PARK]:{type:C.PARK,cost:200,color:"#38b2ac",label:"Park",icon:Wt,description:"Green spaces for relaxation and city aesthetics."},[C.BUS_STOP]:{type:C.BUS_STOP,cost:150,color:"#f6ad55",label:"Bus Stop",icon:Nt,description:"Define routes. Buses stop at nearby roads to pick up citizens."}},Le={money:5e3,population:0,day:1,income:0,expense:0},or="neo-city-db",ee="saves",ae="current-save",ar=1;class nr{db=null;dbReady;constructor(){this.dbReady=this.initDB()}initDB(){return new Promise((l,b)=>{if(typeof window>"u"||!window.indexedDB){l();return}const d=indexedDB.open(or,1);d.onerror=()=>{console.error("Failed to open IndexedDB:",d.error),b(d.error)},d.onsuccess=()=>{this.db=d.result,l()},d.onupgradeneeded=p=>{const u=p.target.result;u.objectStoreNames.contains(ee)||u.createObjectStore(ee)}})}async save(l,b,d,p,u){await this.dbReady;const v={cityData:l,stats:b,cityName:d,gameTime:p,feedMessages:u,savedAt:Date.now(),version:ar};return this.db?new Promise(h=>{const j=this.db.transaction([ee],"readwrite").objectStore(ee).put(v,ae);j.onsuccess=()=>h(!0),j.onerror=()=>{console.error("IndexedDB save failed, trying localStorage"),h(this.saveToLocalStorage(v))}}):this.saveToLocalStorage(v)}saveToLocalStorage(l){try{return ct(ae,l),!0}catch(b){return console.error("localStorage save failed:",b),!1}}async load(){if(await this.dbReady,this.db){const l=await new Promise(b=>{const u=this.db.transaction([ee],"readonly").objectStore(ee).get(ae);u.onsuccess=()=>b(u.result||null),u.onerror=()=>{console.error("IndexedDB load failed, trying localStorage"),b(null)}});if(l)return l}return this.loadFromLocalStorage()}loadFromLocalStorage(){try{const l=lt(ae,!0);if(l)return l}catch(l){console.error("localStorage load failed:",l)}return null}async deleteSave(){if(await this.dbReady,this.db)return new Promise(l=>{const p=this.db.transaction([ee],"readwrite").objectStore(ee).delete(ae);p.onsuccess=()=>l(!0),p.onerror=()=>l(!1)});try{return dt(ae),!0}catch{return!1}}async hasSave(){return await this.load()!==null}}const we=new nr,ne=new ge(1,1,1),ir=new pt(1,1,4),cr=new mt(1,1,1,8),lr=new Fe(1,8,8),W=new Ne,Se=new ie,dr=new He().makeScale(0,0,0);new _({color:"#1a1a1a",roughness:.9}),new _({color:"#a0aec0"}),new _({color:"#2d3748",roughness:.7}),new _({color:"#fbbf24"}),new _({color:"#ffffff",roughness:.4}),new _({color:"#48bb78"}),new _({color:"#276749"}),new _({color:"#c6f6d5"}),new _({color:"#4299e1"}),new _({color:"#4299e1",transparent:!0,opacity:.9,metalness:1,roughness:0}),new _({color:"#2b6cb0"}),new _({color:"#ecc94b"}),new _({color:"#cbd5e0"}),new _({color:"#744210"}),new _({color:"#4a5568"}),new _({color:"#38b2ac"}),new _({color:"#234e52"}),new _({color:"#2d6a4f"}),new _({color:"#63b3ed",metalness:1,roughness:0}),new _({color:"#ebf8ff",transparent:!0,opacity:.6}),new _({color:"#718096"}),new _({color:"#4a5568",transparent:!0,opacity:.8}),new _({color:"#2d3748"}),new _({color:"#744210"}),new _({color:"#a0aec0"}),new _({color:"#f6ad55"});const de=512,ur=256,Me=512,fr=({cityData:o,selectedBuilding:l})=>{const b=r.useRef(null),d=r.useRef(null),p=r.useRef(null),u=r.useRef(null),v=r.useRef(null),h=r.useRef(null),S=r.useRef(null),M=r.useRef(null),j=r.useRef(null),U=r.useRef({y:0,targetY:0}),L=r.useMemo(()=>{const x=new Set(o.filter(P=>P.type===C.ROAD).map(P=>`${P.x},${P.z}`));return(P,z)=>x.has(`${P},${z}`)},[o]);return r.useEffect(()=>{const x=[b,d,p,u,v,h,S,M,j];[h,S,M,j].forEach(c=>{if(c.current&&!c.current.instanceColor){const a=new Float32Array(c.current.count*3);for(let i=0;i<c.current.count*3;i++)a[i]=1;c.current.instanceColor=new ht(a,3),c.current.instanceColor.needsUpdate=!0}}),x.forEach(c=>{if(c.current)for(let a=0;a<c.current.count;a++)c.current.setMatrixAt(a,dr)});let z=0,N=0,t=0,g=0,n=0,D=0,k=0,y=0;const s=(c,a,i,O,m,R)=>!c.current||a>=c.current.count?a:(W.position.set(...i),W.scale.set(...O),R?W.rotation.set(...R):W.rotation.set(0,0,0),W.updateMatrix(),c.current.setMatrixAt(a,W.matrix),m&&c.current.setColorAt(a,Se.set(m)),a+1),f=(c,a,i,O,m,R,I)=>!c.current||a>=c.current.count?a:(W.position.set(...i),W.scale.set(O,m,O),I?W.rotation.set(...I):W.rotation.set(0,0,0),W.updateMatrix(),c.current.setMatrixAt(a,W.matrix),R&&c.current.setColorAt(a,Se.set(R)),a+1),w=(c,a,i,O,m,R,I)=>!c.current||a>=c.current.count?a:(W.position.set(...i),W.scale.set(O,m,O),I?W.rotation.set(...I):W.rotation.set(0,0,0),W.updateMatrix(),c.current.setMatrixAt(a,W.matrix),R&&c.current.setColorAt(a,Se.set(R)),a+1);o.forEach(c=>{if(c.type===C.EMPTY)return;const a=c.x-A/2+.5,i=c.z-A/2+.5,O=l?.x===c.x&&l?.z===c.z,m=O?U.current.y:0;switch(c.type){case C.ROAD:{const R=L(c.x,c.z-1),I=L(c.x,c.z+1),Q=L(c.x+1,c.z),V=L(c.x-1,c.z);z=s(b,z,[a,.04,i],[1,.08,1],"#1a1a1a"),N=s(d,N,[a-.45,.08,i],[.1,.022,1],"#a0aec0"),N=s(d,N,[a+.45,.08,i],[.1,.022,1],"#a0aec0"),N=s(d,N,[a,.08,i-.45],[1,.022,.1],"#a0aec0"),N=s(d,N,[a,.08,i+.45],[1,.022,.1],"#a0aec0"),R||(g=s(v,g,[a,.09,i-.48],[1,.04,.04])),I||(g=s(v,g,[a,.09,i+.48],[1,.04,.04])),Q||(g=s(v,g,[a+.48,.09,i],[.04,.04,1])),V||(g=s(v,g,[a-.48,.09,i],[.04,.04,1])),[R,I,Q,V].filter(Boolean).length>0&&(R&&(t=s(p,t,[a-.01,.081,i-.25],[.04,.005,.4],"#fbbf24")),I&&(t=s(p,t,[a-.01,.081,i+.25],[.04,.005,.4],"#fbbf24")),V&&(t=s(p,t,[a-.25,.081,i],[.4,.005,.04],"#fbbf24")),Q&&(t=s(p,t,[a+.25,.081,i],[.4,.005,.04],"#fbbf24")));break}case C.RESIDENTIAL:{const R=c.level,I=O?"#60d67a":"#48bb78";R===1?(n=s(h,n,[a-.15,.35+m,i],[.4,.7,.6],I),n=s(h,n,[a+.15,.2+m,i],[.4,.4,.6],"#c6f6d5"),n=s(h,n,[a,.7+m,i],[.8,.05,.7],"#2d3748")):R===2?(n=s(h,n,[a,.175+m,i],[.8,.35,.4],I),n=s(h,n,[a,.35+m,i],[.9,.1,.5],"#22543d",[.05,0,0])):(n=s(h,n,[a,.25+m,i],[.6,.5,.6],I),D=f(S,D,[a,.7+m,i],.5,.4,"#276749",[0,Math.PI/4,0]));break}case C.COMMERCIAL:{const R=c.level,I=O?"#5cb3f0":"#4299e1";R===1?(n=s(h,n,[a,.6+m,i],[.6,1.2,.6],I),n=s(h,n,[a,1.2+m,i],[.65,.05,.65],"#2b6cb0")):R===2?(n=s(h,n,[a,.2+m,i],[.8,.4,.8],I),n=s(h,n,[a+.2,.45+m,i+.35],[.2,.5,.1],"#f6e05e"),n=s(h,n,[a,.4+m,i],[.9,.05,.9],"#2c5282")):(n=s(h,n,[a,.4+m,i],[.7,.8,.7],I),n=s(h,n,[a,.85+m,i],[.75,.1,.75],"#2b6cb0"));break}case C.INDUSTRIAL:{const R=c.level,I=O?"#f5d654":"#ecc94b";R===1?(k=w(M,k,[a-.2,.25+m,i-.2],.2,.5,"#cbd5e0"),k=w(M,k,[a+.2,.25+m,i+.2],.2,.5,"#cbd5e0"),n=s(h,n,[a,.05+m,i],[.8,.1,.8],"#4a5568")):R===2?(n=s(h,n,[a,.2+m,i],[.7,.4,.7],I),k=w(M,k,[a+.2,.4+m,i+.2],.05,.8,"#744210"),k=w(M,k,[a-.2,.4+m,i+.2],.05,.8,"#744210"),k=w(M,k,[a,.4+m,i-.2],.05,.8,"#744210")):(n=s(h,n,[a,.3+m,i],[.8,.6,.8],I),k=w(M,k,[a+.2,.6+m,i+.2],.1,1,"#744210"));break}case C.PARK:{const R=c.level,I=O?"#4cc9bd":"#38b2ac";n=s(h,n,[a,.05+m,i],[.9,.1,.9],I),R===1?(k=w(M,k,[a,.1+m,i],.3,.05,"#63b3ed"),y=s(j,y,[a,.2+m,i],[.1,.1,.1],"#ebf8ff")):R===2?(n=s(h,n,[a-.2,.2+m,i+.2],[.2,.2,.2],"#f56565"),k=w(M,k,[a+.2,.2+m,i-.2],.15,.4,"#4299e1",[0,0,.5])):(D=f(S,D,[a,.4+m,i],.2,.5,"#234e52"),D=f(S,D,[a+.25,.25+m,i+.2],.15,.3,"#2d6a4f"));break}case C.BUS_STOP:{const R=O?"#8999a8":"#718096";n=s(h,n,[a,.025+m,i],[.8,.05,.8],R),n=s(h,n,[a,.25+m,i-.3],[.6,.5,.05],"#4a5568"),n=s(h,n,[a,.5+m,i-.15],[.7,.05,.4],"#2d3748",[.1,0,0]),n=s(h,n,[a,.1+m,i-.15],[.4,.1,.15],"#744210"),k=w(M,k,[a+.3,.3+m,i+.2],.02,.6,"#a0aec0"),n=s(h,n,[a+.3,.55+m,i+.2],[.15,.1,.02],"#f6ad55");break}}}),[b,d,p,u,v,h,S,M,j].forEach(c=>{c.current&&(c.current.instanceMatrix.needsUpdate=!0,c.current.instanceColor&&(c.current.instanceColor.needsUpdate=!0))})},[o,l,L]),ce(x=>{l?U.current.targetY=Math.sin(x.clock.elapsedTime*4)*.1+.1:U.current.targetY=0,U.current.y=Re.lerp(U.current.y,U.current.targetY,.1)}),e.jsxs("group",{children:[e.jsx("instancedMesh",{ref:b,args:[ne,void 0,de],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#1a1a1a",roughness:.9})}),e.jsx("instancedMesh",{ref:d,args:[ne,void 0,de*4],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#a0aec0"})}),e.jsx("instancedMesh",{ref:p,args:[ne,void 0,de*4],children:e.jsx("meshStandardMaterial",{color:"#fbbf24"})}),e.jsx("instancedMesh",{ref:u,args:[ne,void 0,de*20],children:e.jsx("meshStandardMaterial",{color:"#ffffff",roughness:.4})}),e.jsx("instancedMesh",{ref:v,args:[ne,void 0,de*4],children:e.jsx("meshStandardMaterial",{color:"#2d3748",roughness:.7})}),e.jsx("instancedMesh",{ref:h,args:[ne,void 0,ur*6],castShadow:!0,receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#ffffff"})}),e.jsx("instancedMesh",{ref:S,args:[ir,void 0,Me],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#ffffff"})}),e.jsx("instancedMesh",{ref:M,args:[cr,void 0,Me],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#ffffff"})}),e.jsx("instancedMesh",{ref:j,args:[lr,void 0,Me],children:e.jsx("meshStandardMaterial",{color:"#ffffff",transparent:!0,opacity:.6})})]})},pr=new ge(A,.5,A),mr=new ge(A,1.5,A),hr=new We(.95,.95),xr=new _({color:"#38a169"}),vr=new _({color:"#4a3728"}),yr=new _({transparent:!0,opacity:0}),Ye=r.memo(()=>e.jsxs("group",{position:[0,-.25,0],children:[e.jsx("mesh",{geometry:pr,material:xr}),e.jsx("mesh",{geometry:mr,material:vr,position:[0,-1,0]})]}));Ye.displayName="Terrain";const qe=r.memo(()=>e.jsx(xt,{infiniteGrid:!1,args:[A,A],fadeDistance:30,sectionSize:Ie,sectionThickness:1.5,sectionColor:"#2d3748",cellSize:Ie,cellThickness:.5,cellColor:"#2d3748",position:[0,.01,0]}));qe.displayName="GridOverlay";const Xe=r.memo(({hovered:o,selectedType:l})=>{const b=r.useMemo(()=>new _({color:l===C.EMPTY?"#f56565":"#ffffff",transparent:!0,opacity:.3}),[l]);return o?e.jsx("mesh",{position:[o.x-A/2+.5,.03,o.z-A/2+.5],rotation:[-Math.PI/2,0,0],geometry:hr,material:b}):null});Xe.displayName="HoverIndicator";const br=({cityData:o,onTileClick:l,selectedType:b,selectedBuilding:d})=>{const[p,u]=r.useState(null),v=r.useCallback(M=>{M.stopPropagation();const j=Math.floor(M.point.x+A/2),U=Math.floor(M.point.z+A/2);j>=0&&j<A&&U>=0&&U<A?u({x:j,z:U}):u(null)},[]),h=r.useCallback(()=>{u(null)},[]),S=r.useCallback(M=>{M.stopPropagation(),p&&l(p.x,p.z)},[p,l]);return e.jsxs("group",{children:[e.jsx(Ye,{}),e.jsx(qe,{}),e.jsx(Zt,{args:[A,A],rotation:[-Math.PI/2,0,0],position:[0,.02,0],onPointerMove:v,onPointerOut:h,onClick:S,material:yr,receiveShadow:!0}),e.jsx(fr,{cityData:o,selectedBuilding:d}),e.jsx(Xe,{hovered:p,selectedType:b})]})},gr=r.memo(br),wr=({stats:o,cityName:l,onRenameCity:b,selectedType:d,onSelectType:p,selectedBuildingInfo:u,onDeselect:v,isFeedVisible:h,onToggleFeed:S,saveSettings:M,onSave:j,onToggleAutoSave:U,gameTime:L,performanceLevel:x="medium",onPerformanceChange:P})=>{const[z,N]=r.useState(!1),[t,g]=r.useState(l),n=r.useRef(null),D=u?u.type:d,k=D!==C.EMPTY?he[D]:null,y=f=>{const w=Math.floor(f),c=Math.floor(f%1*60),a=w>=12?"PM":"AM";return`${w%12||12}:${c.toString().padStart(2,"0")} ${a}`};r.useEffect(()=>{z&&n.current&&(n.current.focus(),n.current.select())},[z]);const s=f=>{f?.preventDefault();const w=t.trim()||l;b(w),g(w),N(!1)};return e.jsxs("div",{className:"absolute inset-0 pointer-events-none flex flex-col justify-between p-6",children:[e.jsxs("div",{className:"flex flex-row justify-between items-start w-full relative",children:[e.jsxs("div",{className:"flex flex-col space-y-4 items-start",children:[e.jsx("div",{className:"pointer-events-auto group",children:z?e.jsx("form",{onSubmit:s,className:"flex items-center",children:e.jsx("input",{ref:n,type:"text",value:t,onChange:f=>g(f.target.value),onBlur:()=>s(),className:"bg-gray-800/80 backdrop-blur-md border-2 border-blue-500 rounded-lg px-4 py-1 text-2xl font-black text-white shadow-[0_0_15px_rgba(59,130,246,0.5)] focus:outline-none tracking-tight",maxLength:24})}):e.jsxs("div",{onClick:()=>N(!0),className:"flex items-center space-x-3 cursor-pointer hover:translate-x-1 transition-transform duration-200",children:[e.jsx("h1",{className:"text-3xl font-black italic tracking-tighter drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] text-white bg-linear-to-br from-white to-gray-400 bg-clip-text",children:l}),e.jsx(zt,{className:"w-3 h-3 text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"})]})}),e.jsx("div",{className:"flex justify-start items-start pointer-events-auto w-full",children:e.jsxs("div",{className:"bg-gray-900/80 backdrop-blur-md border border-gray-700 p-4 rounded-xl shadow-2xl flex space-x-8",children:[e.jsx(ue,{icon:Xt,label:"Budget",value:`$${o.money.toLocaleString()}`,color:"text-yellow-400"}),e.jsx(ue,{icon:Yt,label:"Population",value:o.population.toLocaleString(),color:"text-green-400"}),e.jsx(ue,{icon:Pt,label:"Day",value:o.day.toString(),color:"text-blue-400"}),e.jsx(ue,{icon:yt,label:"Time",value:y(L),color:"text-indigo-400"}),e.jsx(ue,{icon:Ht,label:"Cashflow",value:`$${o.income-o.expense}/m`,color:o.income-o.expense>=0?"text-green-400":"text-red-400"})]})})]}),e.jsxs("div",{className:"bg-gray-900/90 text-white p-2 md:p-3 rounded-xl border border-gray-700 shadow-2xl backdrop-blur-md flex gap-2 md:gap-3 items-center pointer-events-auto",children:[P&&e.jsxs("div",{className:"flex items-center gap-1 border-r border-gray-700 pr-3",children:[e.jsx(Lt,{className:"w-4 h-4 text-gray-400"}),e.jsxs("select",{value:x,onChange:f=>P(f.target.value),className:"bg-gray-800 border border-gray-600 rounded-lg px-2 py-1 text-xs font-bold uppercase tracking-wide focus:outline-none focus:ring-1 focus:ring-blue-500",title:"Performance Quality",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"})]})]}),e.jsxs("button",{onClick:j,className:"flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg transition-colors text-xs font-bold uppercase tracking-wide",title:"Save City",children:[e.jsx(bt,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden md:inline",children:"Save"})]}),e.jsxs("button",{onClick:U,className:`flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-colors text-xs font-bold uppercase tracking-wide ${M.autoSaveEnabled?"bg-green-600 hover:bg-green-500 text-white":"bg-gray-700 hover:bg-gray-600 text-gray-300"}`,title:M.autoSaveEnabled?"Disable Auto-save":"Enable Auto-save",children:[e.jsx(gt,{className:`w-4 h-4 ${M.autoSaveEnabled?"animate-spin":""}`}),e.jsx("span",{className:"hidden md:inline",children:"Auto"})]}),M.lastSavedAt&&e.jsxs("div",{className:"hidden lg:flex flex-col items-end border-l border-gray-700 pl-3",children:[e.jsx("span",{className:"text-[8px] text-gray-500 uppercase font-bold tracking-widest",children:"Last Sync"}),e.jsx("span",{className:"text-[10px] font-mono text-blue-400",children:new Date(M.lastSavedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})]}),k&&e.jsxs("div",{className:"absolute top-1/2 left-6 -translate-y-1/2 w-72 bg-gray-900/95 backdrop-blur-xl border border-blue-500/30 rounded-2xl shadow-2xl p-6 pointer-events-auto animate-in slide-in-from-left duration-300",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-800",children:e.jsx(k.icon,{className:"w-6 h-6",style:{color:k.color}})}),u&&e.jsx("button",{onClick:v,className:"text-gray-500 hover:text-white transition-colors",children:e.jsx(jt,{className:"w-5 h-5"})})]}),e.jsx("h3",{className:"text-xl font-bold mb-1",children:k.label}),e.jsx("p",{className:"text-xs text-gray-500 mb-4 uppercase tracking-widest",children:u?"Building Inspector":"Construction Tool"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-gray-300 leading-relaxed italic",children:['"',k.description,'"']}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 border-t border-gray-800 pt-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Cost"}),e.jsxs("p",{className:`text-sm ${o.money>=k.cost?"text-green-400":"text-red-400"}`,children:["$",k.cost.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Status"}),e.jsx("p",{className:"text-sm text-green-400",children:u?"Operational":"Ready"})]}),u&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Coordinates"}),e.jsxs("p",{className:"text-sm text-gray-400",children:["X: ",u.x,", Z: ",u.z]})]})]})]})]}),e.jsx("div",{className:"flex justify-start pointer-events-auto",children:e.jsx("div",{className:"bg-gray-900/90 backdrop-blur-md border border-gray-700 p-2 rounded-2xl shadow-2xl flex space-x-2",children:Object.values(he).map(f=>e.jsxs("button",{onClick:()=>p(f.type),className:`flex flex-col items-center justify-center w-20 h-20 rounded-xl transition-all ${d===f.type?"bg-blue-600 ring-2 ring-white scale-105":"bg-gray-800 hover:bg-gray-700"}`,children:[e.jsx(f.icon,{className:"w-6 h-6 mb-1"}),e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tighter",children:f.label}),e.jsxs("span",{className:"text-[10px] opacity-70",children:["$",f.cost]})]},f.type))})})]})},ue=({icon:o,label:l,value:b,color:d})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] uppercase font-bold text-gray-400 tracking-widest",children:l}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(o,{className:`w-4 h-4 ${d}`}),e.jsx("span",{className:"text-xl font-bold tabular-nums",children:b})]})]}),J=[.14,.32],Sr=.42,Mr=.85,je=1.6,te=24,fe=40,pe=6,jr=3,Rr=2,Cr=2.5,F=new Ne,T=new Ne,me=new ie,Nr=new He().makeScale(0,0,0),_e=["#f56565","#4299e1","#f6e05e","#ffffff","#2d3748","#38b2ac","#9f7aea"],ze=["#f6ad55","#4fd1c5","#6366f1"],Oe=["#8d5524","#c68642","#e0ac69","#f1c27d","#ffdbac"],Ue=["#2563eb","#dc2626","#16a34a","#d97706","#7c3aed","#db2777","#4b5563","#1e293b","#f97316","#06b6d4","#84cc16","#6366f1"],kr=({cityData:o})=>{const l=r.useRef(null),b=r.useRef(null),d=r.useRef(null),p=r.useRef(null),u=r.useRef(null),v=r.useRef(null),h=r.useRef(null),S=r.useRef(null),M=r.useRef(null),j=r.useRef([]);r.useEffect(()=>{const L=o.filter(y=>y.type===C.ROAD),x=o.filter(y=>y.type===C.BUS_STOP),P=o.filter(y=>y.type!==C.EMPTY&&y.type!==C.ROAD),z=j.current.filter(y=>y.type==="car"),N=j.current.filter(y=>y.type==="person"),t=j.current.filter(y=>y.type==="bus");let g=[...j.current];g=g.filter(y=>{const s=Math.floor(y.targetPos.x+A/2),f=Math.floor(y.targetPos.z+A/2),w=o.find(c=>c.x===s&&c.z===f);return y.type==="car"||y.type==="bus"?w&&w.type===C.ROAD:w&&w.type!==C.EMPTY});const n=Math.min(te,L.length)-z.length;if(n>0)for(let y=0;y<n;y++){const s=L[Math.floor(Math.random()*L.length)],f=new $(s.x-A/2+.5,.08,s.z-A/2+.5),w=Math.floor(Math.random()*J.length);g.push({id:Math.random(),type:"car",prevPos:f.clone(),currentPos:f.clone(),targetPos:f.clone(),actualWorldPos:f.clone(),progress:1,baseSpeed:.5+Math.random()*.4,currentSpeed:.5,color:_e[Math.floor(Math.random()*_e.length)],waitTimer:0,lastDirection:new $(0,0,1),targetRotation:new oe,currentRotation:new oe,laneIndex:w,visualLaneOffset:J[w],laneChangeTimer:0,preferredSide:0,isStoppedAtStation:!1})}const D=Math.min(pe,x.length*2)-t.length;if(D>0&&L.length>0)for(let y=0;y<D;y++){const s=L[Math.floor(Math.random()*L.length)],f=new $(s.x-A/2+.5,.12,s.z-A/2+.5);g.push({id:Math.random(),type:"bus",prevPos:f.clone(),currentPos:f.clone(),targetPos:f.clone(),actualWorldPos:f.clone(),progress:1,baseSpeed:.35,currentSpeed:.35,color:ze[Math.floor(Math.random()*ze.length)],waitTimer:0,lastDirection:new $(0,0,1),targetRotation:new oe,currentRotation:new oe,laneIndex:1,visualLaneOffset:J[1],laneChangeTimer:0,preferredSide:0,isStoppedAtStation:!1})}const k=Math.min(fe,P.length)-N.length;if(k>0)for(let y=0;y<k;y++){const s=P[Math.floor(Math.random()*P.length)],f=new $(s.x-A/2+.5,.05,s.z-A/2+.5);g.push({id:Math.random(),type:"person",prevPos:f.clone(),currentPos:f.clone(),targetPos:f.clone(),actualWorldPos:f.clone(),progress:1,baseSpeed:.12+Math.random()*.1,currentSpeed:.12,color:Ue[Math.floor(Math.random()*Ue.length)],headColor:Oe[Math.floor(Math.random()*Oe.length)],scale:.85+Math.random()*.3,waitTimer:0,lastDirection:new $(0,0,1),targetRotation:new oe,currentRotation:new oe,laneIndex:0,visualLaneOffset:0,laneChangeTimer:0,preferredSide:Math.random()>.5?1:-1,isStoppedAtStation:!1})}if(j.current=g,l.current){const y=g.filter(s=>s.type==="car");for(let s=0;s<te;s++)s<y.length&&(l.current.setColorAt(s,me.set(y[s].color)),b.current?.setColorAt(s,me.set(y[s].color)));l.current.instanceColor&&(l.current.instanceColor.needsUpdate=!0),b.current?.instanceColor&&(b.current.instanceColor.needsUpdate=!0)}if(v.current){const y=g.filter(s=>s.type==="bus");for(let s=0;s<pe;s++)s<y.length&&v.current.setColorAt(s,me.set(y[s].color));v.current.instanceColor&&(v.current.instanceColor.needsUpdate=!0)}if(S.current){const y=g.filter(s=>s.type==="person");for(let s=0;s<fe;s++)s<y.length&&(S.current.setColorAt(s,me.set(y[s].color)),M.current?.setColorAt(s,me.set(y[s].headColor)));S.current.instanceColor&&(S.current.instanceColor.needsUpdate=!0),M.current?.instanceColor&&(M.current.instanceColor.needsUpdate=!0)}},[o]);const U=(L,x,P,z,N)=>{const g=[{x:L+1,z:x},{x:L-1,z:x},{x:L,z:x+1},{x:L,z:x-1}].map(n=>{const D=o.find(y=>y.x===n.x&&y.z===n.z);if(!D)return{...n,score:-1/0};if((N==="car"||N==="bus")&&D.type!==C.ROAD)return{...n,score:-1/0};if(N==="person"&&D.type===C.EMPTY)return{...n,score:-1/0};let k=100;return n.x===P&&n.z===z&&(k-=195),k+=Math.random()*20,{...n,score:k}}).filter(n=>n.score!==-1/0);return g.length>0?(g.sort((n,D)=>D.score-n.score),g[0]):null};return ce((L,x)=>{[l,b,d,p,u,v,h,S,M].forEach(t=>{if(t.current)for(let g=0;g<(t.current.count||0);g++)t.current.setMatrixAt(g,Nr)});let P=0,z=0,N=0;j.current.forEach(t=>{const g=t.type==="car",n=t.type==="bus",D=t.type==="person";if((g||n)&&t.currentSpeed<.05){if(t.waitTimer+=x,t.waitTimer>jr){const f=t.currentPos.clone();t.currentPos.copy(t.targetPos),t.targetPos.copy(f),t.progress=1-t.progress,t.waitTimer=0}}else t.waitTimer=0;if(t.progress>=1){const f=Math.floor(t.targetPos.x+A/2),w=Math.floor(t.targetPos.z+A/2);if(n&&!t.isStoppedAtStation&&[{x:f+1,z:w},{x:f-1,z:w},{x:f,z:w+1},{x:f,z:w-1}].some(m=>o.find(R=>R.x===m.x&&R.z===m.z)?.type===C.BUS_STOP)&&(t.isStoppedAtStation=!0,t.waitTimer=Cr),n&&t.isStoppedAtStation)if(t.waitTimer-=x,t.waitTimer<=0)t.isStoppedAtStation=!1;else return;const c=Math.floor(t.prevPos.x+A/2),a=Math.floor(t.prevPos.z+A/2),i=U(f,w,c,a,t.type);if(i){t.prevPos.copy(t.currentPos),t.currentPos.copy(t.targetPos);const O=o.find(R=>R.x===i.x&&R.z===i.z),m=new $(i.x-A/2+.5,n?.12:g?.08:.05,i.z-A/2+.5);if(g||n){const R=new $().subVectors(m,t.currentPos).normalize(),I=new $(-R.z,0,R.x).multiplyScalar(J[t.laneIndex]);t.targetPos.copy(m.add(I))}else if(O?.type===C.ROAD){const R=new $().subVectors(m,t.currentPos).normalize(),I=new $(-R.z,0,R.x).multiplyScalar(Sr*t.preferredSide);t.targetPos.copy(m.add(I))}else{const R=new $((Math.random()-.5)*.45,0,(Math.random()-.5)*.45);t.targetPos.copy(m.add(R))}t.progress=0}else if(g||n){const O=t.currentPos.clone();t.currentPos.copy(t.targetPos),t.targetPos.copy(O),t.progress=0}}let k=t.baseSpeed;if(g||n){t.laneChangeTimer=Math.max(0,t.laneChangeTimer-x);const f=new $().subVectors(t.targetPos,t.currentPos).normalize();let w=!1;for(const c of j.current)if((c.type==="car"||c.type==="bus")&&c.id!==t.id){const a=t.actualWorldPos.distanceTo(c.actualWorldPos);if(a<je){const i=new $().subVectors(c.actualWorldPos,t.actualWorldPos).normalize();f.dot(i)>.6&&t.laneIndex===c.laneIndex&&(k=a<(n?1.2:Mr)?0:t.baseSpeed*.4,g&&a<je*.8&&c.currentSpeed<t.baseSpeed*.6&&(w=!0))}}if(g&&w&&t.laneChangeTimer<=0){const c=(t.laneIndex+1)%J.length;let a=!0;for(const i of j.current)if((i.type==="car"||i.type==="bus")&&i.id!==t.id&&i.laneIndex===c&&t.actualWorldPos.distanceTo(i.actualWorldPos)<je){a=!1;break}if(a){t.laneIndex=c,t.laneChangeTimer=Rr;const i=new $().subVectors(t.targetPos,t.currentPos).normalize(),O=t.targetPos.clone().sub(new $(-i.z,0,i.x).multiplyScalar(J[1-c]));t.targetPos.copy(O.add(new $(-i.z,0,i.x).multiplyScalar(J[c])))}}t.visualLaneOffset=Re.lerp(t.visualLaneOffset,J[t.laneIndex],.05)}else for(const f of j.current)f.type==="person"&&f.id!==t.id&&t.actualWorldPos.distanceTo(f.actualWorldPos)<.2&&(k*=.5);t.currentSpeed=Re.lerp(t.currentSpeed,k,.1),t.progress=Math.min(1,t.progress+x*t.currentSpeed);const y=new $().lerpVectors(t.currentPos,t.targetPos,t.progress);if(g||n){const f=new $().subVectors(t.targetPos,t.currentPos).normalize(),w=new $(-f.z,0,f.x).multiplyScalar(t.visualLaneOffset-J[t.laneIndex]);t.actualWorldPos.copy(y.add(w))}else t.actualWorldPos.copy(y);F.position.copy(t.actualWorldPos);const s=new $().subVectors(t.targetPos,t.currentPos).normalize();if(s.lengthSq()>.001&&(F.lookAt(t.actualWorldPos.clone().add(s)),t.targetRotation.copy(F.quaternion),t.lastDirection.copy(s)),t.currentRotation.slerp(t.targetRotation,D?.3:.12),F.quaternion.copy(t.currentRotation),g&&P<te){F.updateMatrix(),l.current?.setMatrixAt(P,F.matrix),T.copy(F),T.position.y+=.07,T.position.add(t.lastDirection.clone().multiplyScalar(-.04)),T.scale.set(.8,.7,.5),T.updateMatrix(),b.current?.setMatrixAt(P,T.matrix),T.scale.set(.85,.75,.55),T.updateMatrix(),d.current?.setMatrixAt(P,T.matrix);const f=new $(-t.lastDirection.z,0,t.lastDirection.x).normalize();T.copy(F),T.position.add(t.lastDirection.clone().multiplyScalar(.201)).add(f.clone().multiplyScalar(.06)),T.scale.set(1,1,1),T.updateMatrix(),p.current?.setMatrixAt(P*2,T.matrix),T.position.add(f.clone().multiplyScalar(-.12)),T.updateMatrix(),p.current?.setMatrixAt(P*2+1,T.matrix),T.copy(F),T.position.add(t.lastDirection.clone().multiplyScalar(-.201)).add(f.clone().multiplyScalar(.06)),T.updateMatrix(),u.current?.setMatrixAt(P*2,T.matrix),T.position.add(f.clone().multiplyScalar(-.12)),T.updateMatrix(),u.current?.setMatrixAt(P*2+1,T.matrix),P++}else if(n&&z<pe)F.updateMatrix(),v.current?.setMatrixAt(z,F.matrix),T.copy(F),T.position.y+=.08,T.scale.set(.9,.6,.85),T.updateMatrix(),h.current?.setMatrixAt(z,T.matrix),z++;else if(D&&N<fe){const f=Math.abs(Math.sin(L.clock.elapsedTime*10+t.id))*.03,w=t.scale||1;F.scale.set(w,w,w),F.position.y=t.actualWorldPos.y+f+.05*w,F.updateMatrix(),S.current?.setMatrixAt(N,F.matrix),T.copy(F),T.position.y+=.09*w,T.scale.set(w*.8,w*.8,w*.8),T.updateMatrix(),M.current?.setMatrixAt(N,T.matrix),N++}}),[l,b,d,p,u,v,h,S,M].forEach(t=>{t.current&&(t.current.instanceMatrix.needsUpdate=!0)})}),e.jsxs("group",{children:[e.jsxs("instancedMesh",{ref:l,args:[void 0,void 0,te],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{roughness:.3,metalness:.7})]}),e.jsxs("instancedMesh",{ref:b,args:[void 0,void 0,te],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{roughness:.3,metalness:.7})]}),e.jsxs("instancedMesh",{ref:d,args:[void 0,void 0,te],children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{color:"#050505",roughness:0,metalness:1})]}),e.jsxs("instancedMesh",{ref:p,args:[void 0,void 0,te*2],children:[e.jsx("boxGeometry",{args:[.05,.03,.01]}),e.jsx("meshStandardMaterial",{color:"#ffffff",emissive:"#ffffff",emissiveIntensity:3})]}),e.jsxs("instancedMesh",{ref:u,args:[void 0,void 0,te*2],children:[e.jsx("boxGeometry",{args:[.05,.03,.01]}),e.jsx("meshStandardMaterial",{color:"#ff0000",emissive:"#ff0000",emissiveIntensity:3})]}),e.jsxs("instancedMesh",{ref:v,args:[void 0,void 0,pe],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.35,.25,.8]}),e.jsx("meshStandardMaterial",{roughness:.4,metalness:.3})]}),e.jsxs("instancedMesh",{ref:h,args:[void 0,void 0,pe],children:[e.jsx("boxGeometry",{args:[.35,.25,.8]}),e.jsx("meshStandardMaterial",{color:"#0a0a0a",roughness:0,metalness:1})]}),e.jsxs("instancedMesh",{ref:S,args:[void 0,void 0,fe],castShadow:!0,children:[e.jsx("capsuleGeometry",{args:[.04,.08,4,8]}),e.jsx("meshStandardMaterial",{roughness:.8})]}),e.jsxs("instancedMesh",{ref:M,args:[void 0,void 0,fe],castShadow:!0,children:[e.jsx("sphereGeometry",{args:[.035,8,8]}),e.jsx("meshStandardMaterial",{roughness:.6})]})]})},Ke=r.memo(({gameTime:o,lowQuality:l=!1})=>{const b=(o-6)/24*Math.PI*2,d=25,p=r.useMemo(()=>new $(Math.cos(b)*d,Math.sin(b)*d,8),[b]),u=o<5.5||o>19.5,v=o>=5.5&&o<=7||o>=18&&o<=19.5,h=r.useMemo(()=>u?new ie("#3b82f6"):v?new ie("#ffaa44"):new ie("#ffffff"),[u,v]),S=r.useMemo(()=>u?.2:v?.8:1.2,[u,v]),M=r.useMemo(()=>u?"#0f172a":v?"#fb923c":"#BAE6FD",[u,v]),j=l?512:1024;return e.jsxs("group",{children:[e.jsx("color",{attach:"background",args:[M]}),e.jsx("directionalLight",{position:p,intensity:S,color:h,castShadow:!l,"shadow-bias":-.001,"shadow-mapSize":[j,j],"shadow-camera-left":-15,"shadow-camera-right":15,"shadow-camera-top":15,"shadow-camera-bottom":-15,"shadow-camera-near":1,"shadow-camera-far":50}),e.jsx("ambientLight",{intensity:u?.4:.7,color:u?"#3b82f6":"#ffffff"})]})});Ke.displayName="DayNightCycle";const Pr=new Fe(1,6,6),Be=new ge(.2,.05,.05),Er=new Ve({color:"white",opacity:.4,transparent:!0}),Ge=new Ve({color:"#333"}),be=r.memo(({position:o,scale:l,speed:b,seed:d})=>{const p=r.useRef(null),u=r.useRef(0);ce((h,S)=>{p.current&&(u.current+=S,u.current>.033&&(p.current.position.x+=b*u.current,p.current.position.x>A*1.5&&(p.current.position.x=-A*1.5),u.current=0))});const v=r.useMemo(()=>{const h=M=>{const j=Math.sin(M)*1e4;return j-Math.floor(j)},S=3+Math.round(h(d)*2);return Array.from({length:S}).map((M,j)=>({pos:[(h(d+j*3)-.5)*2,h(d+j*3+1)-.5,(h(d+j*3+2)-.5)*2],scale:.5+h(d+j*4)*.7}))},[d]);return e.jsx("group",{ref:p,position:o,scale:l,children:v.map((h,S)=>e.jsx("mesh",{geometry:Pr,material:Er,position:h.pos,scale:h.scale,castShadow:!1,receiveShadow:!1},S))})});be.displayName="Cloud";const Ce=r.memo(({position:o,speed:l,offset:b})=>{const d=r.useRef(null),p=r.useRef(null),u=r.useRef(null),v=r.useRef(0);return ce(h=>{if(d.current){const S=h.clock.elapsedTime+b;v.current+=1;const M=Math.sin(S*l),j=Math.cos(S*l);if(d.current.position.x=o[0]+M*(A/2),d.current.position.z=o[1]+j*(A/2),d.current.rotation.y=-S*l+Math.PI,v.current%2===0){const U=1+Math.sin(S*15)*.3;p.current&&(p.current.scale.y=U),u.current&&(u.current.scale.y=U)}}}),e.jsxs("group",{ref:d,position:[o[0],o[2],o[1]],children:[e.jsx("mesh",{ref:p,geometry:Be,material:Ge,position:[.1,0,0],rotation:[0,Math.PI/4,0]}),e.jsx("mesh",{ref:u,geometry:Be,material:Ge,position:[-.1,0,0],rotation:[0,-Math.PI/4,0]})]})});Ce.displayName="Bird";const Je=r.memo(()=>e.jsxs("group",{raycast:()=>null,children:[e.jsx(be,{position:[-12,10,4],scale:1.5,speed:.3,seed:1}),e.jsx(be,{position:[5,12,-8],scale:1.2,speed:.4,seed:2}),e.jsx(be,{position:[15,9,10],scale:1.6,speed:.25,seed:3}),e.jsxs("group",{position:[0,0,0],scale:.8,children:[e.jsx(Ce,{position:[0,0,8],speed:.5,offset:0}),e.jsx(Ce,{position:[2,0,8],speed:.5,offset:1.5})]})]}));Je.displayName="EnvironmentEffects";const Dr=({messages:o,isVisible:l,onClear:b})=>{const[d,p]=r.useState(!1);return l?e.jsxs("div",{className:"fixed bottom-6 right-6 w-70 z-50 flex flex-col pointer-events-auto",children:[e.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl border border-slate-700/50 rounded-2xl shadow-2xl overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-700/50 bg-slate-800/30",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-slate-400",children:"City Feed"})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:b,className:"text-slate-500 hover:text-red-400 transition-colors",title:"Clear all logs",children:e.jsx(wt,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>p(!d),className:"text-slate-500 hover:text-white transition-colors",children:d?e.jsx(St,{className:"w-3 h-3"}):e.jsx(Mt,{className:"w-3 h-3"})}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] animate-pulse"})]})]}),!d&&e.jsx("div",{className:"h-64 overflow-y-auto p-4 space-y-3 custom-scrollbar",children:o.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-slate-600 italic text-xs font-mono",children:"Waiting for citizen feedback..."}):o.map(u=>e.jsx("div",{className:"relative group animate-in fade-in slide-in-from-bottom-2 duration-300",children:e.jsxs("div",{className:"bg-slate-800/40 border-l-2 border-green-500/80 p-3 pl-4 rounded-r-lg hover:bg-slate-800/60 transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("span",{className:"text-[10px] font-bold text-slate-500 font-mono tracking-tight",children:["@",u.user]}),e.jsx("span",{className:"text-[9px] text-slate-600 font-mono uppercase",children:u.timestamp})]}),e.jsx("p",{className:"text-xs text-slate-200 font-mono leading-relaxed pr-8",children:u.content})]})},u.id))})]}),e.jsx("style",{dangerouslySetInnerHTML:{__html:`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(71, 85, 105, 0.5);
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(100, 116, 139, 0.8);
        }
      `}})]}):null},Ar=({onStart:o,hasSavedGame:l})=>e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center z-50 text-white font-sans p-6 bg-black/30 backdrop-blur-sm transition-all duration-1000",children:e.jsxs("div",{className:"max-w-md w-full bg-slate-900/90 p-8 rounded-2xl border border-slate-700 shadow-2xl backdrop-blur-xl relative overflow-hidden animate-fade-in",children:[e.jsx("div",{className:"absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("div",{className:"absolute -bottom-24 -left-24 w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("h1",{className:"text-5xl font-black mb-2 bg-linear-to-br from-white via-cyan-200 to-blue-400 bg-clip-text text-transparent tracking-tight",children:"Neo City"}),e.jsx("p",{className:"text-slate-400 mb-8 text-sm font-medium uppercase tracking-widest",children:"Cyberpunk City Simulation"}),e.jsxs("div",{className:"space-y-3",children:[l&&e.jsxs("button",{onClick:()=>o(!0),className:"w-full py-4 bg-linear-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-green-900/20 transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide flex items-center justify-center gap-2",children:[e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),"Continue"]}),e.jsx("button",{onClick:()=>o(!1),className:`w-full py-4 text-white font-bold rounded-xl shadow-lg transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide ${l?"bg-linear-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 shadow-slate-900/20":"bg-linear-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 shadow-cyan-900/20"}`,children:l?"New Game":"Start Building"})]})]})]})}),Tr=()=>{const[o,l]=r.useState(!1),[b,d]=r.useState([]),[p,u]=r.useState(Le),[v,h]=r.useState("Neo City"),[S,M]=r.useState(C.ROAD),[j,U]=r.useState(null),[L,x]=r.useState(null),[P,z]=r.useState(10),[N,t]=r.useState([]),[g,n]=r.useState(!0),[D,k]=r.useState(Te.medium),[y,s]=r.useState(D.pixelRatio),[f,w]=r.useState({autoSaveEnabled:!0,lastSavedAt:null}),[c,a]=r.useState(!1),i=r.useRef(b),O=r.useRef(p),m=r.useRef(v),R=r.useRef(P),I=r.useRef(N),Q=r.useRef(p.money);r.useEffect(()=>{i.current=b},[b]),r.useEffect(()=>{O.current=p},[p]),r.useEffect(()=>{m.current=v},[v]),r.useEffect(()=>{R.current=P},[P]),r.useEffect(()=>{I.current=N},[N]),r.useEffect(()=>{(async()=>{const B=await we.hasSave();a(B)})()},[]);const V=r.useCallback(async(E=!1)=>{const B=await we.save(i.current,O.current,m.current,R.current,I.current);if(B&&(w(G=>({...G,lastSavedAt:Date.now()})),!E)){const Y=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t(H=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:"City data synchronized to neural network.",timestamp:Y,type:"positive"},...H])}return B},[t]),le=r.useCallback(async()=>{const E=await we.load();return E?(d(E.cityData),u(E.stats),h(E.cityName),z(E.gameTime),t(E.feedMessages),w(B=>({...B,lastSavedAt:E.savedAt})),!0):!1},[]),xe=async(E=!1)=>{if(E)await le();else{u(Le),z(10);const B=[];for(let Y=0;Y<A;Y++)for(let H=0;H<A;H++)B.push({x:Y,z:H,type:C.EMPTY,level:0});d(B);const G={id:"welcome",user:"SYSTEM",content:`Welcome to ${v}. Terrain generation complete. Ready for development.`,timestamp:"10:00 AM",type:"neutral"};t([G])}l(!0)},Z=()=>{w(E=>({...E,autoSaveEnabled:!E.autoSaveEnabled}))};r.useEffect(()=>{if(!o||!f.autoSaveEnabled)return;const E=setInterval(()=>{V(!0)},6e4);return()=>clearInterval(E)},[o,f.autoSaveEnabled,V]),r.useEffect(()=>{if(!o)return;const E=setInterval(()=>{d(B=>{const G=B.reduce((K,ve)=>(K[ve.type]=(K[ve.type]||0)+1,K),{}),Y=(G[C.RESIDENTIAL]||0)*10,H=(G[C.COMMERCIAL]||0)*15+(G[C.INDUSTRIAL]||0)*25,se=(G[C.ROAD]||0)*2+(G[C.PARK]||0)*10;return u(K=>({...K,population:Y,money:K.money+(H-se),income:H,expense:se})),B})},5e3);return()=>clearInterval(E)},[o]);const ke=r.useRef(P);r.useEffect(()=>{if(!o)return;const E=setInterval(()=>{z(B=>{const G=B+.08;return G>=24?0:G})},100);return()=>clearInterval(E)},[o]),r.useEffect(()=>{o&&(ke.current>22&&P<2&&u(E=>({...E,day:E.day+1})),ke.current=P)},[P,o]),r.useEffect(()=>{if(o){if(p.money<0&&Q.current>=0){const B=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t(G=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:"Warning: City treasury is in deficit! Revenue generation required.",timestamp:B,type:"negative"},...G].slice(0,50))}Q.current=p.money}},[p.money]);const Qe=r.useCallback((E,B)=>{o&&(x(null),d(G=>{const Y=G.findIndex(X=>X.x===E&&X.z===B);if(Y===-1)return G;const H=G[Y];if(S===C.EMPTY){if(H.type===C.EMPTY)return G;const X=[...G],Ee=Math.floor(he[H.type].cost*.8),st=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t(ye=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:`Demolition complete: ${he[H.type].label} removed. $${Ee} refunded to treasury.`,timestamp:st,type:"positive"},...ye].slice(0,50)),u(ye=>({...ye,money:ye.money+Ee})),X[Y]={...H,type:C.EMPTY,level:0},U(null),X}if(H.type!==C.EMPTY)return U({x:E,z:B}),G;const se=he[S];if(O.current.money<se.cost)return x("Insufficient budget!"),G;const K=[...G],ve=Math.floor(Math.random()*3);K[Y]={...H,type:S,level:ve};const rt=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t(X=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:`Construction complete: ${se.label} deployed at [${E}, ${B}].`,timestamp:rt,type:"neutral"},...X].slice(0,50)),u(X=>({...X,money:X.money-se.cost})),U({x:E,z:B}),K}))},[S,o]),Ze=E=>{M(E),U(null),x(null)},et=b.find(E=>E.x===j?.x&&E.z===j?.z)||null,tt=r.useMemo(()=>({antialias:D.antialias,powerPreference:"high-performance",stencil:!1,depth:!0,alpha:!1}),[D.antialias]),Pe=r.useCallback(E=>{const B=Te[E];k(B),s(B.pixelRatio)},[]);return e.jsxs("div",{className:"relative w-full h-screen",children:[e.jsxs(at,{shadows:D.shadows,camera:{position:[15,15,15],fov:40},dpr:y,gl:tt,performance:{min:.5},children:[e.jsx(tr,{pixelated:!0}),e.jsx(sr,{onDecline:()=>{s(Math.max(.5,y-.25))},onIncline:()=>{s(Math.min(D.pixelRatio,y+.25))},flipflops:3,onFallback:()=>Pe("low")}),D.environmentEffects&&e.jsx(Je,{}),e.jsx(Ke,{gameTime:P,lowQuality:D.level==="low"}),e.jsx(gr,{cityData:b,onTileClick:Qe,selectedType:S,selectedBuilding:j}),e.jsx(kr,{cityData:b}),D.shadows&&e.jsx(er,{position:[0,-.01,0],opacity:.25,scale:25,blur:2,far:4,resolution:D.level==="high"?512:256}),e.jsx(vt,{preset:"city"}),e.jsx(nt,{makeDefault:!0,maxPolarAngle:Math.PI/2.1,minDistance:5,maxDistance:40,enableDamping:!0,dampingFactor:.05})]}),!o&&e.jsx(Ar,{onStart:xe,hasSavedGame:c}),o&&e.jsxs(e.Fragment,{children:[e.jsx(Dr,{messages:N,isVisible:g,onClear:()=>t([])}),L&&e.jsxs("div",{className:"absolute top-24 left-1/2 -translate-x-1/2 z-50 bg-red-600/90 text-white px-6 py-2 rounded-full shadow-lg border border-red-400 animate-bounce pointer-events-none flex items-center",children:[e.jsx(Rt,{className:"w-5 h-5 mr-2"}),L]}),e.jsx(wr,{stats:p,cityName:v,onRenameCity:h,selectedType:S,onSelectType:Ze,selectedBuildingInfo:et,onDeselect:()=>U(null),isFeedVisible:g,onToggleFeed:()=>n(!g),saveSettings:f,onSave:()=>V(!1),onToggleAutoSave:Z,gameTime:P,performanceLevel:D.level,onPerformanceChange:Pe})]})]})},Xr={fullscreen:!0};function Kr(){return[{title:"Neo City"},{property:"og:title",content:"Neo City"},{name:"description",content:"Neo City - A city building simulation game with isometric 3D graphics."}]}const Jr=ot(Tr);export{Jr as default,Xr as handle,Kr as meta};
