import{r,j as e,w as ut}from"./chunk-JMJ3UQ3L-DWVaYX8b.js";import{_ as He,u as re,a as de,C as ft,O as mt}from"./OrbitControls-B6XXv3Lv.js";import{c as V}from"./createLucideIcon-pA_Cmp7j.js";import{H as pt}from"./house-BPcJkcs2.js";import{s as xt,g as ht,r as vt}from"./index-tSOQ2Rud.js";import{u as bt}from"./usePageVisibility-G8wKNGIO.js";import{u as Ve}from"./useIsMobile-DkrCiyIh.js";import{_ as Te,f as Ye,h as yt,ai as gt,j as le,S as Ie,i as Me,aj as wt,u as Mt,v as Xe,ak as Pe,x as qe,r as H,al as St,M as ke,V as G,am as ne,g as Ke}from"./three.module-CkFzBGVQ.js";import{G as jt,E as Nt}from"./Environment-BP-rgkfV.js";import{C as Rt}from"./clock-DN0iNsGB.js";import{M as kt,a as Ct,C as Ze,B as Pt,I as Et,S as At,R as Dt,T as Tt,b as It}from"./listbox-k6V2V78B.js";import{C as _t}from"./check-DHokvDZO.js";import{X as zt}from"./x-DKPWXxoK.js";import{T as Lt}from"./triangle-alert-B0WyaEID.js";import"./shaderMaterial-B3TDCXl_.js";import"./constants-CBBPndjW.js";import"./index-CSJWayS4.js";const Ot=[["path",{d:"M8 6v6",key:"18i7km"}],["path",{d:"M15 6v6",key:"1sg6z9"}],["path",{d:"M2 12h19.6",key:"de5uta"}],["path",{d:"M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3",key:"1wwztk"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}],["path",{d:"M9 18h5",key:"lrx6i"}],["circle",{cx:"16",cy:"18",r:"2",key:"1v4tcr"}]],Ut=V("bus",Ot);const Bt=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Gt=V("calendar",Bt);const $t=[["path",{d:"M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21",key:"g5wo59"}],["path",{d:"m5.082 11.09 8.828 8.828",key:"1wx5vj"}]],Wt=V("eraser",$t);const Ft=[["path",{d:"M12 16h.01",key:"1drbdi"}],["path",{d:"M16 16h.01",key:"1f9h7w"}],["path",{d:"M3 19a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5a.5.5 0 0 0-.769-.422l-4.462 2.844A.5.5 0 0 1 15 10.5v-2a.5.5 0 0 0-.769-.422L9.77 10.922A.5.5 0 0 1 9 10.5V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z",key:"1iv0i2"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],Ht=V("factory",Ft);const Vt=[["path",{d:"m12 14 4-4",key:"9kzdfg"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0",key:"19p75a"}]],Yt=V("gauge",Vt);const Xt=[["path",{d:"M4.037 4.688a.495.495 0 0 1 .651-.651l16 6.5a.5.5 0 0 1-.063.947l-6.124 1.58a2 2 0 0 0-1.438 1.435l-1.579 6.126a.5.5 0 0 1-.947.063z",key:"edeuup"}]],qt=V("mouse-pointer-2",Xt);const Kt=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],Zt=V("pencil",Kt);const Jt=[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]],Qt=V("route",Jt);const er=[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]],tr=V("shopping-cart",er);const rr=[["path",{d:"M10 10v.2A3 3 0 0 1 8.9 16H5a3 3 0 0 1-1-5.8V10a3 3 0 0 1 6 0Z",key:"1l6gj6"}],["path",{d:"M7 16v6",key:"1a82de"}],["path",{d:"M13 19v3",key:"13sx9i"}],["path",{d:"M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .8-1.7L13 3l-1.4 1.5",key:"1sj9kv"}]],sr=V("trees",rr);const or=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],ar=V("trending-up",or);const nr=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],ir=V("users",nr);const cr=[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]],lr=V("wallet",cr),dr={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},ur={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `};function fr(o,d){const y=o+"Geometry";return r.forwardRef(({args:u,children:x,...b},h)=>{const f=r.useRef(null);return r.useImperativeHandle(h,()=>f.current),r.useLayoutEffect(()=>{d?.(f.current)}),r.createElement("mesh",He({ref:f},b),r.createElement(y,{attach:"geometry",args:u}),x)})}const mr=fr("plane"),pr=r.forwardRef(({scale:o=10,frames:d=1/0,opacity:y=1,width:u=1,height:x=1,blur:b=1,near:h=0,far:f=10,resolution:w=512,smooth:N=!0,color:M="#000000",depthWrite:T=!1,renderOrder:E,...m},A)=>{const _=r.useRef(null),k=re(v=>v.scene),t=re(v=>v.gl),g=r.useRef(null);u=u*(Array.isArray(o)?o[0]:o||1),x=x*(Array.isArray(o)?o[1]:o||1);const[n,z,C,l,s,S,p]=r.useMemo(()=>{const v=new Te(w,w),j=new Te(w,w);j.texture.generateMipmaps=v.texture.generateMipmaps=!1;const L=new Ye(u,x).rotateX(Math.PI/2),J=new yt(L),X=new gt;X.depthTest=X.depthWrite=!1,X.onBeforeCompile=Q=>{Q.uniforms={...Q.uniforms,ucolor:{value:new le(M)}},Q.fragmentShader=Q.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),Q.fragmentShader=Q.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const se=new Ie(dr),oe=new Ie(ur);return oe.depthTest=se.depthTest=!1,[v,L,X,J,se,oe,j]},[w,u,x,o,M]),c=v=>{l.visible=!0,l.material=s,s.uniforms.tDiffuse.value=n.texture,s.uniforms.h.value=v*1/256,t.setRenderTarget(p),t.render(l,g.current),l.material=S,S.uniforms.tDiffuse.value=p.texture,S.uniforms.v.value=v*1/256,t.setRenderTarget(n),t.render(l,g.current),l.visible=!1};let a=0,i,O;return de(()=>{g.current&&(d===1/0||a<d)&&(a++,i=k.background,O=k.overrideMaterial,_.current.visible=!1,k.background=null,k.overrideMaterial=C,t.setRenderTarget(n),t.render(k,g.current),c(b),N&&c(b*.4),t.setRenderTarget(null),_.current.visible=!0,k.overrideMaterial=O,k.background=i)}),r.useImperativeHandle(A,()=>_.current,[]),r.createElement("group",He({"rotation-x":Math.PI/2},m,{ref:_}),r.createElement("mesh",{renderOrder:E,geometry:z,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},r.createElement("meshBasicMaterial",{transparent:!0,map:n.texture,opacity:y,depthWrite:T})),r.createElement("orthographicCamera",{ref:g,args:[-u/2,u/2,x/2,-x/2,h,f]}))});function xr({pixelated:o}){const d=re(h=>h.gl),y=re(h=>h.internal.active),u=re(h=>h.performance.current),x=re(h=>h.viewport.initialDpr),b=re(h=>h.setDpr);return r.useEffect(()=>{const h=d.domElement;return()=>{y&&b(x),o&&h&&(h.style.imageRendering="auto")}},[]),r.useEffect(()=>{b(u*x),o&&d.domElement&&(d.domElement.style.imageRendering=u===1?"auto":"pixelated")},[u]),null}const hr=r.createContext(null);function vr({iterations:o=10,ms:d=250,threshold:y=.75,step:u=.1,factor:x=.5,flipflops:b=1/0,bounds:h=E=>E>100?[60,100]:[40,60],onIncline:f,onDecline:w,onChange:N,onFallback:M,children:T}){const E=Math.pow(10,0),[m,A]=r.useState(()=>({fps:0,index:0,factor:x,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:k=>{const t=Symbol();return m.subscriptions.set(t,k.current),()=>{m.subscriptions.delete(t)}}}));let _=0;return de(()=>{const{frames:k,averages:t}=m;if(!m.fallback&&t.length<o){k.push(performance.now());const g=k[k.length-1]-k[0];if(g>=d){if(m.fps=Math.round(k.length/g*1e3*E)/E,m.refreshrate=Math.max(m.refreshrate,m.fps),t[m.index++%o]=m.fps,t.length===o){const[n,z]=h(m.refreshrate),C=t.filter(s=>s>=z),l=t.filter(s=>s<n);C.length>o*y&&(m.factor=Math.min(1,m.factor+u),m.flipped++,f&&f(m),m.subscriptions.forEach(s=>s.onIncline&&s.onIncline(m))),l.length>o*y&&(m.factor=Math.max(0,m.factor-u),m.flipped++,w&&w(m),m.subscriptions.forEach(s=>s.onDecline&&s.onDecline(m))),_!==m.factor&&(_=m.factor,N&&N(m),m.subscriptions.forEach(s=>s.onChange&&s.onChange(m))),m.flipped>b&&!m.fallback&&(m.fallback=!0,M&&M(m),m.subscriptions.forEach(s=>s.onFallback&&s.onFallback(m))),m.averages=[]}m.frames=[]}}}),r.createElement(hr.Provider,{value:m},T)}var R=(o=>(o.EMPTY="EMPTY",o.ROAD="ROAD",o.RESIDENTIAL="RESIDENTIAL",o.COMMERCIAL="COMMERCIAL",o.INDUSTRIAL="INDUSTRIAL",o.PARK="PARK",o.BUS_STOP="BUS_STOP",o))(R||{});const _e={low:{level:"low",shadows:!1,environmentEffects:!1,pixelRatio:1,antialias:!1,shadowMapSize:512,maxLights:1},medium:{level:"medium",shadows:!0,environmentEffects:!0,pixelRatio:1.5,antialias:!1,shadowMapSize:1024,maxLights:2},high:{level:"high",shadows:!0,environmentEffects:!0,pixelRatio:2,antialias:!0,shadowMapSize:2048,maxLights:4}},P=16,ze=1,ve={[R.EMPTY]:{type:R.EMPTY,cost:0,color:"#2d3748",label:"Bulldoze",icon:Wt,description:"Clear the land for new developments."},[R.ROAD]:{type:R.ROAD,cost:10,color:"#4a5568",label:"Road",icon:Qt,description:"Connect your city. Essential for cars and growth."},[R.RESIDENTIAL]:{type:R.RESIDENTIAL,cost:50,color:"#48bb78",label:"Residential",icon:pt,description:"Where your citizens live. Provides population."},[R.COMMERCIAL]:{type:R.COMMERCIAL,cost:80,color:"#4299e1",label:"Commercial",icon:tr,description:"Stores and offices. Boosts city income and development."},[R.INDUSTRIAL]:{type:R.INDUSTRIAL,cost:120,color:"#ecc94b",label:"Industrial",icon:Ht,description:"Factories and production. High income generation."},[R.PARK]:{type:R.PARK,cost:200,color:"#38b2ac",label:"Park",icon:sr,description:"Green spaces for relaxation and city aesthetics."},[R.BUS_STOP]:{type:R.BUS_STOP,cost:150,color:"#f6ad55",label:"Bus Stop",icon:Ut,description:"Define routes. Buses stop at nearby roads to pick up citizens."}},Le={money:5e3,population:0,day:1,income:0,expense:0},br="neo-city-db",ee="saves",ie="current-save",yr=1;class gr{db=null;dbReady;constructor(){this.dbReady=this.initDB()}initDB(){return new Promise((d,y)=>{if(typeof window>"u"||!window.indexedDB){d();return}const u=indexedDB.open(br,1);u.onerror=()=>{console.error("Failed to open IndexedDB:",u.error),y(u.error)},u.onsuccess=()=>{this.db=u.result,d()},u.onupgradeneeded=x=>{const b=x.target.result;b.objectStoreNames.contains(ee)||b.createObjectStore(ee)}})}async save(d,y,u,x,b){await this.dbReady;const h={cityData:d,stats:y,cityName:u,gameTime:x,feedMessages:b,savedAt:Date.now(),version:yr};return this.db?new Promise(f=>{const M=this.db.transaction([ee],"readwrite").objectStore(ee).put(h,ie);M.onsuccess=()=>f(!0),M.onerror=()=>{console.error("IndexedDB save failed, trying localStorage"),f(this.saveToLocalStorage(h))}}):this.saveToLocalStorage(h)}saveToLocalStorage(d){try{return xt(ie,d),!0}catch(y){return console.error("localStorage save failed:",y),!1}}async load(){if(await this.dbReady,this.db){const d=await new Promise(y=>{const b=this.db.transaction([ee],"readonly").objectStore(ee).get(ie);b.onsuccess=()=>y(b.result||null),b.onerror=()=>{console.error("IndexedDB load failed, trying localStorage"),y(null)}});if(d)return d}return this.loadFromLocalStorage()}loadFromLocalStorage(){try{const d=ht(ie,!0);if(d)return d}catch(d){console.error("localStorage load failed:",d)}return null}async deleteSave(){if(await this.dbReady,this.db)return new Promise(d=>{const x=this.db.transaction([ee],"readwrite").objectStore(ee).delete(ie);x.onsuccess=()=>d(!0),x.onerror=()=>d(!1)});try{return vt(ie),!0}catch{return!1}}async hasSave(){return await this.load()!==null}}const Se=new gr,ce=new Me(1,1,1),wr=new wt(1,1,4),Mr=new Mt(1,1,1,8),Sr=new Xe(1,8,8),$=new Pe,je=new le,jr=new qe().makeScale(0,0,0),ue={asphalt:new H({color:"#1a1a1a",roughness:.9}),sidewalk:new H({color:"#a0aec0"}),curb:new H({color:"#2d3748",roughness:.7}),yellowLine:new H({color:"#fbbf24"}),zebra:new H({color:"#ffffff",roughness:.4})},ge={box:new H({color:"#ffffff"}),cone:new H({color:"#ffffff"}),cylinder:new H({color:"#ffffff"}),sphere:new H({color:"#ffffff",transparent:!0,opacity:.6})},fe=512,Nr=256,Ne=512,Rr=({cityData:o,selectedBuilding:d})=>{const y=r.useRef(null),u=r.useRef(null),x=r.useRef(null),b=r.useRef(null),h=r.useRef(null),f=r.useRef(null),w=r.useRef(null),N=r.useRef(null),M=r.useRef(null),T=r.useRef({y:0,targetY:0}),E=r.useMemo(()=>{const m=new Set(o.filter(A=>A.type===R.ROAD).map(A=>`${A.x},${A.z}`));return(A,_)=>m.has(`${A},${_}`)},[o]);return r.useEffect(()=>{const m=[y,u,x,b,h,f,w,N,M];[f,w,N,M].forEach(c=>{if(c.current&&!c.current.instanceColor){const a=new Float32Array(c.current.count*3);for(let i=0;i<c.current.count*3;i++)a[i]=1;c.current.instanceColor=new St(a,3),c.current.instanceColor.needsUpdate=!0}}),m.forEach(c=>{if(c.current)for(let a=0;a<c.current.count;a++)c.current.setMatrixAt(a,jr)});let _=0,k=0,t=0,g=0,n=0,z=0,C=0,l=0;const s=(c,a,i,O,v,j)=>!c.current||a>=c.current.count?a:($.position.set(...i),$.scale.set(...O),j?$.rotation.set(...j):$.rotation.set(0,0,0),$.updateMatrix(),c.current.setMatrixAt(a,$.matrix),v&&c.current.setColorAt(a,je.set(v)),a+1),S=(c,a,i,O,v,j,L)=>!c.current||a>=c.current.count?a:($.position.set(...i),$.scale.set(O,v,O),L?$.rotation.set(...L):$.rotation.set(0,0,0),$.updateMatrix(),c.current.setMatrixAt(a,$.matrix),j&&c.current.setColorAt(a,je.set(j)),a+1),p=(c,a,i,O,v,j,L)=>!c.current||a>=c.current.count?a:($.position.set(...i),$.scale.set(O,v,O),L?$.rotation.set(...L):$.rotation.set(0,0,0),$.updateMatrix(),c.current.setMatrixAt(a,$.matrix),j&&c.current.setColorAt(a,je.set(j)),a+1);o.forEach(c=>{if(c.type===R.EMPTY)return;const a=c.x-P/2+.5,i=c.z-P/2+.5,O=d?.x===c.x&&d?.z===c.z,v=O?T.current.y:0;switch(c.type){case R.ROAD:{const j=E(c.x,c.z-1),L=E(c.x,c.z+1),J=E(c.x+1,c.z),X=E(c.x-1,c.z);_=s(y,_,[a,.04,i],[1,.08,1],"#1a1a1a"),k=s(u,k,[a-.45,.08,i],[.1,.022,1],"#a0aec0"),k=s(u,k,[a+.45,.08,i],[.1,.022,1],"#a0aec0"),k=s(u,k,[a,.08,i-.45],[1,.022,.1],"#a0aec0"),k=s(u,k,[a,.08,i+.45],[1,.022,.1],"#a0aec0"),j||(g=s(h,g,[a,.09,i-.48],[1,.04,.04])),L||(g=s(h,g,[a,.09,i+.48],[1,.04,.04])),J||(g=s(h,g,[a+.48,.09,i],[.04,.04,1])),X||(g=s(h,g,[a-.48,.09,i],[.04,.04,1])),[j,L,J,X].filter(Boolean).length>0&&(j&&(t=s(x,t,[a-.01,.081,i-.25],[.04,.005,.4],"#fbbf24")),L&&(t=s(x,t,[a-.01,.081,i+.25],[.04,.005,.4],"#fbbf24")),X&&(t=s(x,t,[a-.25,.081,i],[.4,.005,.04],"#fbbf24")),J&&(t=s(x,t,[a+.25,.081,i],[.4,.005,.04],"#fbbf24")));break}case R.RESIDENTIAL:{const j=c.level,L=O?"#60d67a":"#48bb78";j===1?(n=s(f,n,[a-.15,.35+v,i],[.4,.7,.6],L),n=s(f,n,[a+.15,.2+v,i],[.4,.4,.6],"#c6f6d5"),n=s(f,n,[a,.7+v,i],[.8,.05,.7],"#2d3748")):j===2?(n=s(f,n,[a,.175+v,i],[.8,.35,.4],L),n=s(f,n,[a,.35+v,i],[.9,.1,.5],"#22543d",[.05,0,0])):(n=s(f,n,[a,.25+v,i],[.6,.5,.6],L),z=S(w,z,[a,.7+v,i],.5,.4,"#276749",[0,Math.PI/4,0]));break}case R.COMMERCIAL:{const j=c.level,L=O?"#5cb3f0":"#4299e1";j===1?(n=s(f,n,[a,.6+v,i],[.6,1.2,.6],L),n=s(f,n,[a,1.2+v,i],[.65,.05,.65],"#2b6cb0")):j===2?(n=s(f,n,[a,.2+v,i],[.8,.4,.8],L),n=s(f,n,[a+.2,.45+v,i+.35],[.2,.5,.1],"#f6e05e"),n=s(f,n,[a,.4+v,i],[.9,.05,.9],"#2c5282")):(n=s(f,n,[a,.4+v,i],[.7,.8,.7],L),n=s(f,n,[a,.85+v,i],[.75,.1,.75],"#2b6cb0"));break}case R.INDUSTRIAL:{const j=c.level,L=O?"#f5d654":"#ecc94b";j===1?(C=p(N,C,[a-.2,.25+v,i-.2],.2,.5,"#cbd5e0"),C=p(N,C,[a+.2,.25+v,i+.2],.2,.5,"#cbd5e0"),n=s(f,n,[a,.05+v,i],[.8,.1,.8],"#4a5568")):j===2?(n=s(f,n,[a,.2+v,i],[.7,.4,.7],L),C=p(N,C,[a+.2,.4+v,i+.2],.05,.8,"#744210"),C=p(N,C,[a-.2,.4+v,i+.2],.05,.8,"#744210"),C=p(N,C,[a,.4+v,i-.2],.05,.8,"#744210")):(n=s(f,n,[a,.3+v,i],[.8,.6,.8],L),C=p(N,C,[a+.2,.6+v,i+.2],.1,1,"#744210"));break}case R.PARK:{const j=c.level,L=O?"#4cc9bd":"#38b2ac";n=s(f,n,[a,.05+v,i],[.9,.1,.9],L),j===1?(C=p(N,C,[a,.1+v,i],.3,.05,"#63b3ed"),l=s(M,l,[a,.2+v,i],[.1,.1,.1],"#ebf8ff")):j===2?(n=s(f,n,[a-.2,.2+v,i+.2],[.2,.2,.2],"#f56565"),C=p(N,C,[a+.2,.2+v,i-.2],.15,.4,"#4299e1",[0,0,.5])):(z=S(w,z,[a,.4+v,i],.2,.5,"#234e52"),z=S(w,z,[a+.25,.25+v,i+.2],.15,.3,"#2d6a4f"));break}case R.BUS_STOP:{const j=O?"#8999a8":"#718096";n=s(f,n,[a,.025+v,i],[.8,.05,.8],j),n=s(f,n,[a,.25+v,i-.3],[.6,.5,.05],"#4a5568"),n=s(f,n,[a,.5+v,i-.15],[.7,.05,.4],"#2d3748",[.1,0,0]),n=s(f,n,[a,.1+v,i-.15],[.4,.1,.15],"#744210"),C=p(N,C,[a+.3,.3+v,i+.2],.02,.6,"#a0aec0"),n=s(f,n,[a+.3,.55+v,i+.2],[.15,.1,.02],"#f6ad55");break}}}),[y,u,x,b,h,f,w,N,M].forEach(c=>{c.current&&(c.current.instanceMatrix.needsUpdate=!0,c.current.instanceColor&&(c.current.instanceColor.needsUpdate=!0))})},[o,d,E]),de(m=>{d?T.current.targetY=Math.sin(m.clock.elapsedTime*4)*.1+.1:T.current.targetY=0,T.current.y=ke.lerp(T.current.y,T.current.targetY,.1)}),e.jsxs("group",{children:[e.jsx("instancedMesh",{ref:y,args:[ce,ue.asphalt,fe],receiveShadow:!0}),e.jsx("instancedMesh",{ref:u,args:[ce,ue.sidewalk,fe*4],receiveShadow:!0}),e.jsx("instancedMesh",{ref:x,args:[ce,ue.yellowLine,fe*4]}),e.jsx("instancedMesh",{ref:b,args:[ce,ue.zebra,fe*20]}),e.jsx("instancedMesh",{ref:h,args:[ce,ue.curb,fe*4]}),e.jsx("instancedMesh",{ref:f,args:[ce,ge.box,Nr*6],castShadow:!0,receiveShadow:!0}),e.jsx("instancedMesh",{ref:w,args:[wr,ge.cone,Ne],castShadow:!0}),e.jsx("instancedMesh",{ref:N,args:[Mr,ge.cylinder,Ne],castShadow:!0}),e.jsx("instancedMesh",{ref:M,args:[Sr,ge.sphere,Ne]})]})},kr=new Me(P,.5,P),Cr=new Me(P,1.5,P),Pr=new Ye(.95,.95),Er=new H({color:"#38a169"}),Ar=new H({color:"#4a3728"}),Dr=new H({transparent:!0,opacity:0}),Je=r.memo(()=>e.jsxs("group",{position:[0,-.25,0],children:[e.jsx("mesh",{geometry:kr,material:Er}),e.jsx("mesh",{geometry:Cr,material:Ar,position:[0,-1,0]})]}));Je.displayName="Terrain";const Qe=r.memo(()=>e.jsx(jt,{infiniteGrid:!1,args:[P,P],fadeDistance:30,sectionSize:ze,sectionThickness:1.5,sectionColor:"#2d3748",cellSize:ze,cellThickness:.5,cellColor:"#2d3748",position:[0,.01,0]}));Qe.displayName="GridOverlay";const et=r.memo(({hovered:o,selectedType:d})=>{const y=r.useMemo(()=>new H({color:d===R.EMPTY?"#f56565":d===null?"#3b82f6":"#ffffff",transparent:!0,opacity:.3}),[d]);return o?e.jsx("mesh",{position:[o.x-P/2+.5,.03,o.z-P/2+.5],rotation:[-Math.PI/2,0,0],geometry:Pr,material:y}):null});et.displayName="HoverIndicator";const Tr=({cityData:o,onTileClick:d,selectedType:y,selectedBuilding:u,isMobile:x})=>{const[b,h]=r.useState(null),f=r.useCallback(M=>{if(x)return;M.stopPropagation();const T=Math.floor(M.point.x+P/2),E=Math.floor(M.point.z+P/2);T>=0&&T<P&&E>=0&&E<P?h({x:T,z:E}):h(null)},[x]),w=r.useCallback(()=>{x||h(null)},[x]),N=r.useCallback(M=>{M.stopPropagation();const T=Math.floor(M.point.x+P/2),E=Math.floor(M.point.z+P/2);T>=0&&T<P&&E>=0&&E<P&&d(T,E)},[d]);return e.jsxs("group",{children:[e.jsx(Je,{}),e.jsx(Qe,{}),e.jsx(mr,{args:[P,P],rotation:[-Math.PI/2,0,0],position:[0,.02,0],onPointerMove:f,onPointerOut:w,onClick:N,material:Dr,receiveShadow:!0}),e.jsx(Rr,{cityData:o,selectedBuilding:u}),e.jsx(et,{hovered:b,selectedType:y})]})},Ir=r.memo(Tr),Oe=[{value:"low",label:"Low",icon:"ðŸ”‹",description:"Best FPS"},{value:"medium",label:"Medium",icon:"âš¡",description:"Balanced"},{value:"high",label:"High",icon:"ðŸŽ¨",description:"Best visuals"}],_r=({stats:o,cityName:d,onRenameCity:y,selectedType:u,onSelectType:x,selectedBuildingInfo:b,onDeselect:h,isFeedVisible:f,onToggleFeed:w,saveSettings:N,onSave:M,onToggleAutoSave:T,gameTime:E,performanceLevel:m="medium",onPerformanceChange:A})=>{const _=Ve(),[k,t]=r.useState(!1),[g,n]=r.useState(d),z=r.useRef(null),C=b?b.type:u,l=C?ve[C]:null,s=p=>{const c=Math.floor(p),a=Math.floor(p%1*60),i=c>=12?"PM":"AM";return`${c%12||12}:${a.toString().padStart(2,"0")} ${i}`};r.useEffect(()=>{k&&z.current&&(z.current.focus(),z.current.select())},[k]);const S=p=>{p?.preventDefault();const c=g.trim()||d;y(c),n(c),t(!1)};return e.jsxs("div",{className:"absolute inset-0 pointer-events-none flex flex-col justify-between p-4 md:p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start w-full relative gap-4",children:[e.jsxs("div",{className:"flex flex-col space-y-3 md:space-y-4 items-start w-full md:w-auto",children:[e.jsx("div",{className:"pointer-events-auto group",children:k?e.jsx("form",{onSubmit:S,className:"flex items-center",children:e.jsx("input",{ref:z,type:"text",value:g,onChange:p=>n(p.target.value),onBlur:()=>S(),className:"bg-gray-800/80 backdrop-blur-md border-2 border-blue-500 rounded-lg px-4 py-1 text-xl md:text-2xl font-black text-white shadow-[0_0_15px_rgba(59,130,246,0.5)] focus:outline-none tracking-tight",maxLength:24})}):e.jsxs("div",{onClick:()=>t(!0),className:"flex items-center space-x-3 cursor-pointer hover:translate-x-1 transition-transform duration-200",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-black italic tracking-tighter drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] text-white bg-linear-to-br from-white to-gray-400 bg-clip-text",children:d}),e.jsx(Zt,{className:"w-3 h-3 text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"})]})}),e.jsx("div",{className:"flex justify-start items-start pointer-events-auto w-full overflow-x-auto no-scrollbar",children:e.jsxs("div",{className:"bg-black/40 backdrop-blur-2xl border border-white/10 p-3 md:p-4 rounded-xl shadow-2xl flex space-x-6 md:space-x-8 min-w-max",children:[e.jsx(me,{icon:lr,label:"Budget",value:`$${o.money.toLocaleString()}`,color:"text-yellow-400",isMobile:_}),e.jsx(me,{icon:ir,label:"Population",value:o.population.toLocaleString(),color:"text-green-400",isMobile:_}),e.jsx(me,{icon:Gt,label:"Day",value:o.day.toString(),color:"text-blue-400",isMobile:_}),e.jsx(me,{icon:Rt,label:"Time",value:s(E),color:"text-indigo-400",isMobile:_}),e.jsx(me,{icon:ar,label:"Cashflow",value:`$${o.income-o.expense}/m`,color:o.income-o.expense>=0?"text-green-400":"text-red-400",isMobile:_})]})})]}),e.jsxs("div",{className:"bg-black/40 text-white p-2 rounded-xl border border-white/10 shadow-2xl backdrop-blur-2xl flex gap-2 items-center pointer-events-auto self-end md:self-start",children:[A&&e.jsxs("div",{className:"relative flex items-center gap-1.5 border-r border-gray-700 pr-3",children:[e.jsx(Yt,{className:`w-4 h-4 ${m==="low"?"text-green-400":m==="medium"?"text-yellow-400":"text-red-400"}`}),e.jsxs(kt,{value:m,onChange:A,children:[e.jsxs(Ct,{className:`relative flex items-center gap-1.5 bg-white/10 border rounded-lg px-2.5 py-1.5 text-xs font-bold uppercase tracking-wide cursor-pointer transition-all hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500/50 ${m==="low"?"border-green-500/50 text-green-400":m==="medium"?"border-yellow-500/50 text-yellow-400":"border-red-500/50 text-red-400"}`,children:[e.jsx("span",{children:Oe.find(p=>p.value===m)?.icon}),e.jsx("span",{children:m}),e.jsx(Ze,{className:"w-3 h-3 ml-1 opacity-60"})]}),e.jsx(Pt,{anchor:"bottom end",transition:!0,className:"z-50 mt-1 w-44 origin-top-right rounded-xl bg-black/80 backdrop-blur-2xl border border-white/20 p-1 shadow-xl focus:outline-none transition duration-150 ease-out data-closed:scale-95 data-closed:opacity-0",children:Oe.map(p=>e.jsxs(Et,{value:p.value,className:`group flex items-center justify-between gap-2 rounded-lg px-3 py-2 cursor-pointer transition-colors data-focus:bg-gray-700 ${p.value==="low"?"data-selected:text-green-400":p.value==="medium"?"data-selected:text-yellow-400":"data-selected:text-red-400"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-base",children:p.icon}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold uppercase",children:p.label}),e.jsx("div",{className:"text-[10px] text-gray-400",children:p.description})]})]}),e.jsx(_t,{className:"w-4 h-4 opacity-0 group-data-selected:opacity-100"})]},p.value))})]})]}),e.jsxs("button",{onClick:M,className:"flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg transition-colors text-xs font-bold uppercase tracking-wide",title:"Save City",children:[e.jsx(At,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden md:inline",children:"Save"})]}),e.jsxs("button",{onClick:T,className:`flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-colors text-xs font-bold uppercase tracking-wide ${N.autoSaveEnabled?"bg-green-600 hover:bg-green-500 text-white":"bg-gray-700 hover:bg-gray-600 text-gray-300"}`,title:N.autoSaveEnabled?"Disable Auto-save":"Enable Auto-save",children:[e.jsx(Dt,{className:`w-4 h-4 ${N.autoSaveEnabled?"animate-spin":""}`}),e.jsx("span",{className:"hidden md:inline",children:"Auto"})]}),N.lastSavedAt&&e.jsxs("div",{className:"hidden lg:flex flex-col items-end border-l border-gray-700 pl-3",children:[e.jsx("span",{className:"text-[8px] text-gray-500 uppercase font-bold tracking-widest",children:"Last Sync"}),e.jsx("span",{className:"text-[10px] font-mono text-blue-400",children:new Date(N.lastSavedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})]}),l&&_===!1&&e.jsxs("div",{className:`absolute ${_?"top-32 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)]":"top-1/2 left-6 -translate-y-1/2 w-72"} bg-black/60 backdrop-blur-2xl border border-blue-500/40 rounded-2xl shadow-2xl p-4 md:p-6 pointer-events-auto animate-in ${_?"fade-in zoom-in-95":"slide-in-from-left"} duration-300 z-40`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-3 md:mb-4",children:[e.jsx("div",{className:"p-2 md:p-3 rounded-lg bg-gray-800",children:e.jsx(l.icon,{className:"w-5 h-5 md:w-6 md:h-6",style:{color:l.color}})}),(b||u)&&e.jsx("button",{onClick:h,className:"text-gray-500 hover:text-white transition-colors",children:e.jsx(zt,{className:"w-5 h-5"})})]}),e.jsx("h3",{className:"text-lg md:text-xl font-bold mb-1",children:l.label}),e.jsx("p",{className:"text-[10px] text-gray-500 mb-3 md:mb-4 uppercase tracking-widest",children:b?"Building Inspector":"Construction Tool"}),e.jsxs("div",{className:"space-y-3 md:space-y-4",children:[e.jsxs("p",{className:"text-xs md:text-sm text-gray-300 leading-relaxed italic",children:['"',l.description,'"']}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 md:gap-4 border-t border-gray-800 pt-3 md:pt-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[9px] md:text-[10px] text-gray-500 uppercase font-bold",children:"Cost"}),e.jsxs("p",{className:`text-xs md:text-sm ${o.money>=l.cost?"text-green-400":"text-red-400"}`,children:["$",l.cost.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[9px] md:text-[10px] text-gray-500 uppercase font-bold",children:"Status"}),e.jsx("p",{className:"text-xs md:text-sm text-green-400",children:b?"Operational":"Ready"})]}),b&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-[9px] md:text-[10px] text-gray-500 uppercase font-bold",children:"Coordinates"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-400",children:["X: ",b.x,", Z: ",b.z]})]})]})]})]}),e.jsx("div",{className:"flex justify-center pointer-events-auto w-full overflow-hidden",children:e.jsxs("div",{className:"bg-black/40 backdrop-blur-2xl border border-white/20 p-1.5 rounded-2xl shadow-[0_12px_40px_rgba(0,0,0,0.7)] flex items-center gap-1 overflow-x-auto no-scrollbar max-w-full",children:[e.jsxs("button",{onClick:()=>x(null),className:`flex flex-col items-center justify-center shrink-0 ${_?"w-14 h-14":"w-16 h-16"} rounded-xl transition-all duration-300 active:scale-95 ${u===null?"bg-blue-500 text-white shadow-[0_0_20px_rgba(59,130,246,0.6)] scale-105":"text-gray-300 hover:bg-white/10 hover:text-white"}`,children:[e.jsx(qt,{className:"w-5 h-5 mb-1"}),e.jsx("span",{className:"text-[9px] font-bold uppercase tracking-tighter",children:"Select"})]}),e.jsx("div",{className:"w-px h-8 bg-white/20 self-center mx-0.5 shrink-0"}),Object.values(ve).map(p=>e.jsxs("button",{onClick:()=>x(p.type),className:`flex flex-col items-center justify-center shrink-0 ${_?"w-14 h-14":"w-16 h-16"} rounded-xl transition-all duration-300 active:scale-95 ${u===p.type?"bg-blue-500 text-white shadow-[0_0_20px_rgba(59,130,246,0.6)] scale-105":"text-gray-300 hover:bg-white/10 hover:text-white"}`,children:[e.jsx(p.icon,{className:"w-5 h-5 mb-1"}),e.jsx("span",{className:"text-[9px] font-bold uppercase tracking-tighter",children:p.label}),e.jsxs("span",{className:"text-[8px] font-medium opacity-80",children:["$",p.cost]})]},p.type))]})}),e.jsx("style",{dangerouslySetInnerHTML:{__html:`
                .no-scrollbar::-webkit-scrollbar {
                    display: none;
                }
                .no-scrollbar {
                    -ms-overflow-style: none;
                    scrollbar-width: none;
                }
            `}})]})},me=({icon:o,label:d,value:y,color:u,isMobile:x})=>e.jsxs("div",{className:"flex flex-col shrink-0",children:[e.jsx("span",{className:"text-[8px] md:text-[10px] uppercase font-bold text-gray-400 tracking-widest",children:d}),e.jsxs("div",{className:"flex items-center space-x-1.5 md:space-x-2",children:[e.jsx(o,{className:`w-3 h-3 md:w-4 md:h-4 ${u}`}),e.jsx("span",{className:"text-sm md:text-xl font-bold tabular-nums",children:y})]})]}),Z=[.14,.32],zr=.42,Lr=.85,Re=1.6,te=24,pe=40,xe=6,Or=3,Ur=2,Br=2.5,W=new Pe,I=new Pe,he=new le,Gr=new qe().makeScale(0,0,0),Ue=["#f56565","#4299e1","#f6e05e","#ffffff","#2d3748","#38b2ac","#9f7aea"],Be=["#f6ad55","#4fd1c5","#6366f1"],Ge=["#8d5524","#c68642","#e0ac69","#f1c27d","#ffdbac"],$e=["#2563eb","#dc2626","#16a34a","#d97706","#7c3aed","#db2777","#4b5563","#1e293b","#f97316","#06b6d4","#84cc16","#6366f1"],$r=({cityData:o})=>{const d=r.useRef(null),y=r.useRef(null),u=r.useRef(null),x=r.useRef(null),b=r.useRef(null),h=r.useRef(null),f=r.useRef(null),w=r.useRef(null),N=r.useRef(null),M=r.useRef([]);r.useEffect(()=>{const E=o.filter(l=>l.type===R.ROAD),m=o.filter(l=>l.type===R.BUS_STOP),A=o.filter(l=>l.type!==R.EMPTY&&l.type!==R.ROAD),_=M.current.filter(l=>l.type==="car"),k=M.current.filter(l=>l.type==="person"),t=M.current.filter(l=>l.type==="bus");let g=[...M.current];g=g.filter(l=>{const s=Math.floor(l.targetPos.x+P/2),S=Math.floor(l.targetPos.z+P/2),p=o.find(c=>c.x===s&&c.z===S);return l.type==="car"||l.type==="bus"?p&&p.type===R.ROAD:p&&p.type!==R.EMPTY});const n=Math.min(te,E.length)-_.length;if(n>0)for(let l=0;l<n;l++){const s=E[Math.floor(Math.random()*E.length)],S=new G(s.x-P/2+.5,.08,s.z-P/2+.5),p=Math.floor(Math.random()*Z.length);g.push({id:Math.random(),type:"car",prevPos:S.clone(),currentPos:S.clone(),targetPos:S.clone(),actualWorldPos:S.clone(),progress:1,baseSpeed:.5+Math.random()*.4,currentSpeed:.5,color:Ue[Math.floor(Math.random()*Ue.length)],waitTimer:0,lastDirection:new G(0,0,1),targetRotation:new ne,currentRotation:new ne,laneIndex:p,visualLaneOffset:Z[p],laneChangeTimer:0,preferredSide:0,isStoppedAtStation:!1})}const z=Math.min(xe,m.length*2)-t.length;if(z>0&&E.length>0)for(let l=0;l<z;l++){const s=E[Math.floor(Math.random()*E.length)],S=new G(s.x-P/2+.5,.12,s.z-P/2+.5);g.push({id:Math.random(),type:"bus",prevPos:S.clone(),currentPos:S.clone(),targetPos:S.clone(),actualWorldPos:S.clone(),progress:1,baseSpeed:.35,currentSpeed:.35,color:Be[Math.floor(Math.random()*Be.length)],waitTimer:0,lastDirection:new G(0,0,1),targetRotation:new ne,currentRotation:new ne,laneIndex:1,visualLaneOffset:Z[1],laneChangeTimer:0,preferredSide:0,isStoppedAtStation:!1})}const C=Math.min(pe,A.length)-k.length;if(C>0)for(let l=0;l<C;l++){const s=A[Math.floor(Math.random()*A.length)],S=new G(s.x-P/2+.5,.05,s.z-P/2+.5);g.push({id:Math.random(),type:"person",prevPos:S.clone(),currentPos:S.clone(),targetPos:S.clone(),actualWorldPos:S.clone(),progress:1,baseSpeed:.12+Math.random()*.1,currentSpeed:.12,color:$e[Math.floor(Math.random()*$e.length)],headColor:Ge[Math.floor(Math.random()*Ge.length)],scale:.85+Math.random()*.3,waitTimer:0,lastDirection:new G(0,0,1),targetRotation:new ne,currentRotation:new ne,laneIndex:0,visualLaneOffset:0,laneChangeTimer:0,preferredSide:Math.random()>.5?1:-1,isStoppedAtStation:!1})}if(M.current=g,d.current){const l=g.filter(s=>s.type==="car");for(let s=0;s<te;s++)s<l.length&&(d.current.setColorAt(s,he.set(l[s].color)),y.current?.setColorAt(s,he.set(l[s].color)));d.current.instanceColor&&(d.current.instanceColor.needsUpdate=!0),y.current?.instanceColor&&(y.current.instanceColor.needsUpdate=!0)}if(h.current){const l=g.filter(s=>s.type==="bus");for(let s=0;s<xe;s++)s<l.length&&h.current.setColorAt(s,he.set(l[s].color));h.current.instanceColor&&(h.current.instanceColor.needsUpdate=!0)}if(w.current){const l=g.filter(s=>s.type==="person");for(let s=0;s<pe;s++)s<l.length&&(w.current.setColorAt(s,he.set(l[s].color)),N.current?.setColorAt(s,he.set(l[s].headColor)));w.current.instanceColor&&(w.current.instanceColor.needsUpdate=!0),N.current?.instanceColor&&(N.current.instanceColor.needsUpdate=!0)}},[o]);const T=(E,m,A,_,k)=>{const g=[{x:E+1,z:m},{x:E-1,z:m},{x:E,z:m+1},{x:E,z:m-1}].map(n=>{const z=o.find(l=>l.x===n.x&&l.z===n.z);if(!z)return{...n,score:-1/0};if((k==="car"||k==="bus")&&z.type!==R.ROAD)return{...n,score:-1/0};if(k==="person"&&z.type===R.EMPTY)return{...n,score:-1/0};let C=100;return n.x===A&&n.z===_&&(C-=195),C+=Math.random()*20,{...n,score:C}}).filter(n=>n.score!==-1/0);return g.length>0?(g.sort((n,z)=>z.score-n.score),g[0]):null};return de((E,m)=>{[d,y,u,x,b,h,f,w,N].forEach(t=>{if(t.current)for(let g=0;g<(t.current.count||0);g++)t.current.setMatrixAt(g,Gr)});let A=0,_=0,k=0;M.current.forEach(t=>{const g=t.type==="car",n=t.type==="bus",z=t.type==="person";if((g||n)&&t.currentSpeed<.05){if(t.waitTimer+=m,t.waitTimer>Or){const S=t.currentPos.clone();t.currentPos.copy(t.targetPos),t.targetPos.copy(S),t.progress=1-t.progress,t.waitTimer=0}}else t.waitTimer=0;if(t.progress>=1){const S=Math.floor(t.targetPos.x+P/2),p=Math.floor(t.targetPos.z+P/2);if(n&&!t.isStoppedAtStation&&[{x:S+1,z:p},{x:S-1,z:p},{x:S,z:p+1},{x:S,z:p-1}].some(v=>o.find(j=>j.x===v.x&&j.z===v.z)?.type===R.BUS_STOP)&&(t.isStoppedAtStation=!0,t.waitTimer=Br),n&&t.isStoppedAtStation)if(t.waitTimer-=m,t.waitTimer<=0)t.isStoppedAtStation=!1;else return;const c=Math.floor(t.prevPos.x+P/2),a=Math.floor(t.prevPos.z+P/2),i=T(S,p,c,a,t.type);if(i){t.prevPos.copy(t.currentPos),t.currentPos.copy(t.targetPos);const O=o.find(j=>j.x===i.x&&j.z===i.z),v=new G(i.x-P/2+.5,n?.12:g?.08:.05,i.z-P/2+.5);if(g||n){const j=new G().subVectors(v,t.currentPos).normalize(),L=new G(-j.z,0,j.x).multiplyScalar(Z[t.laneIndex]);t.targetPos.copy(v.add(L))}else if(O?.type===R.ROAD){const j=new G().subVectors(v,t.currentPos).normalize(),L=new G(-j.z,0,j.x).multiplyScalar(zr*t.preferredSide);t.targetPos.copy(v.add(L))}else{const j=new G((Math.random()-.5)*.45,0,(Math.random()-.5)*.45);t.targetPos.copy(v.add(j))}t.progress=0}else if(g||n){const O=t.currentPos.clone();t.currentPos.copy(t.targetPos),t.targetPos.copy(O),t.progress=0}}let C=t.baseSpeed;if(g||n){t.laneChangeTimer=Math.max(0,t.laneChangeTimer-m);const S=new G().subVectors(t.targetPos,t.currentPos).normalize();let p=!1;for(const c of M.current)if((c.type==="car"||c.type==="bus")&&c.id!==t.id){const a=t.actualWorldPos.distanceTo(c.actualWorldPos);if(a<Re){const i=new G().subVectors(c.actualWorldPos,t.actualWorldPos).normalize();S.dot(i)>.6&&t.laneIndex===c.laneIndex&&(C=a<(n?1.2:Lr)?0:t.baseSpeed*.4,g&&a<Re*.8&&c.currentSpeed<t.baseSpeed*.6&&(p=!0))}}if(g&&p&&t.laneChangeTimer<=0){const c=(t.laneIndex+1)%Z.length;let a=!0;for(const i of M.current)if((i.type==="car"||i.type==="bus")&&i.id!==t.id&&i.laneIndex===c&&t.actualWorldPos.distanceTo(i.actualWorldPos)<Re){a=!1;break}if(a){t.laneIndex=c,t.laneChangeTimer=Ur;const i=new G().subVectors(t.targetPos,t.currentPos).normalize(),O=t.targetPos.clone().sub(new G(-i.z,0,i.x).multiplyScalar(Z[1-c]));t.targetPos.copy(O.add(new G(-i.z,0,i.x).multiplyScalar(Z[c])))}}t.visualLaneOffset=ke.lerp(t.visualLaneOffset,Z[t.laneIndex],.05)}else for(const S of M.current)S.type==="person"&&S.id!==t.id&&t.actualWorldPos.distanceTo(S.actualWorldPos)<.2&&(C*=.5);t.currentSpeed=ke.lerp(t.currentSpeed,C,.1),t.progress=Math.min(1,t.progress+m*t.currentSpeed);const l=new G().lerpVectors(t.currentPos,t.targetPos,t.progress);if(g||n){const S=new G().subVectors(t.targetPos,t.currentPos).normalize(),p=new G(-S.z,0,S.x).multiplyScalar(t.visualLaneOffset-Z[t.laneIndex]);t.actualWorldPos.copy(l.add(p))}else t.actualWorldPos.copy(l);W.position.copy(t.actualWorldPos);const s=new G().subVectors(t.targetPos,t.currentPos).normalize();if(s.lengthSq()>.001&&(W.lookAt(t.actualWorldPos.clone().add(s)),t.targetRotation.copy(W.quaternion),t.lastDirection.copy(s)),t.currentRotation.slerp(t.targetRotation,z?.3:.12),W.quaternion.copy(t.currentRotation),g&&A<te)W.updateMatrix(),d.current?.setMatrixAt(A,W.matrix),I.copy(W),I.position.y+=.07,I.translateZ(-.04),I.scale.set(.8,.7,.5),I.updateMatrix(),y.current?.setMatrixAt(A,I.matrix),I.scale.set(.85,.75,.55),I.updateMatrix(),u.current?.setMatrixAt(A,I.matrix),I.copy(W),I.scale.set(1,1,1),I.translateZ(.201),I.translateX(.06),I.updateMatrix(),x.current?.setMatrixAt(A*2,I.matrix),I.translateX(-.12),I.updateMatrix(),x.current?.setMatrixAt(A*2+1,I.matrix),I.copy(W),I.scale.set(1,1,1),I.translateZ(-.201),I.translateX(.06),I.updateMatrix(),b.current?.setMatrixAt(A*2,I.matrix),I.translateX(-.12),I.updateMatrix(),b.current?.setMatrixAt(A*2+1,I.matrix),A++;else if(n&&_<xe)W.updateMatrix(),h.current?.setMatrixAt(_,W.matrix),I.copy(W),I.position.y+=.08,I.scale.set(.9,.6,.85),I.updateMatrix(),f.current?.setMatrixAt(_,I.matrix),_++;else if(z&&k<pe){const S=Math.abs(Math.sin(E.clock.elapsedTime*10+t.id))*.03,p=t.scale||1;W.scale.set(p,p,p),W.position.y=t.actualWorldPos.y+S+.05*p,W.updateMatrix(),w.current?.setMatrixAt(k,W.matrix),I.copy(W),I.position.y+=.09*p,I.scale.set(p*.8,p*.8,p*.8),I.updateMatrix(),N.current?.setMatrixAt(k,I.matrix),k++}}),[d,y,u,x,b,h,f,w,N].forEach(t=>{t.current&&(t.current.instanceMatrix.needsUpdate=!0)})}),e.jsxs("group",{children:[e.jsxs("instancedMesh",{ref:d,args:[void 0,void 0,te],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{roughness:.3,metalness:.7})]}),e.jsxs("instancedMesh",{ref:y,args:[void 0,void 0,te],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{roughness:.3,metalness:.7})]}),e.jsxs("instancedMesh",{ref:u,args:[void 0,void 0,te],children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{color:"#050505",roughness:0,metalness:1})]}),e.jsxs("instancedMesh",{ref:x,args:[void 0,void 0,te*2],children:[e.jsx("boxGeometry",{args:[.05,.03,.01]}),e.jsx("meshStandardMaterial",{color:"#ffffff",emissive:"#ffffff",emissiveIntensity:3})]}),e.jsxs("instancedMesh",{ref:b,args:[void 0,void 0,te*2],children:[e.jsx("boxGeometry",{args:[.05,.03,.01]}),e.jsx("meshStandardMaterial",{color:"#ff0000",emissive:"#ff0000",emissiveIntensity:3})]}),e.jsxs("instancedMesh",{ref:h,args:[void 0,void 0,xe],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.35,.25,.8]}),e.jsx("meshStandardMaterial",{roughness:.4,metalness:.3})]}),e.jsxs("instancedMesh",{ref:f,args:[void 0,void 0,xe],children:[e.jsx("boxGeometry",{args:[.35,.25,.8]}),e.jsx("meshStandardMaterial",{color:"#0a0a0a",roughness:0,metalness:1})]}),e.jsxs("instancedMesh",{ref:w,args:[void 0,void 0,pe],castShadow:!0,children:[e.jsx("capsuleGeometry",{args:[.04,.08,4,8]}),e.jsx("meshStandardMaterial",{roughness:.8})]}),e.jsxs("instancedMesh",{ref:N,args:[void 0,void 0,pe],castShadow:!0,children:[e.jsx("sphereGeometry",{args:[.035,8,8]}),e.jsx("meshStandardMaterial",{roughness:.6})]})]})},tt=r.memo(({gameTime:o,lowQuality:d=!1,shadowMapSize:y=1024})=>{const u=(o-6)/24*Math.PI*2,x=25,b=r.useMemo(()=>new G(Math.cos(u)*x,Math.sin(u)*x,8),[u]),h=o<5.5||o>19.5,f=o>=5.5&&o<=7||o>=18&&o<=19.5,w=r.useMemo(()=>h?new le("#3b82f6"):f?new le("#ffaa44"):new le("#ffffff"),[h,f]),N=r.useMemo(()=>h?.2:f?.8:1.2,[h,f]),M=r.useMemo(()=>h?"#0f172a":f?"#fb923c":"#BAE6FD",[h,f]),T=d?Math.min(y,512):y;return e.jsxs("group",{children:[e.jsx("color",{attach:"background",args:[M]}),e.jsx("directionalLight",{position:b,intensity:N,color:w,castShadow:!d,"shadow-bias":-.001,"shadow-mapSize":[T,T],"shadow-camera-left":-15,"shadow-camera-right":15,"shadow-camera-top":15,"shadow-camera-bottom":-15,"shadow-camera-near":1,"shadow-camera-far":50}),e.jsx("ambientLight",{intensity:h?.4:.7,color:h?"#3b82f6":"#ffffff"})]})});tt.displayName="DayNightCycle";const Wr=new Xe(1,6,6),We=new Me(.2,.05,.05),Fr=new Ke({color:"white",opacity:.4,transparent:!0}),Fe=new Ke({color:"#333"}),we=r.memo(({position:o,scale:d,speed:y,seed:u})=>{const x=r.useRef(null),b=r.useRef(0);de((f,w)=>{x.current&&(b.current+=w,b.current>.033&&(x.current.position.x+=y*b.current,x.current.position.x>P*1.5&&(x.current.position.x=-P*1.5),b.current=0))});const h=r.useMemo(()=>{const f=N=>{const M=Math.sin(N)*1e4;return M-Math.floor(M)},w=3+Math.round(f(u)*2);return Array.from({length:w}).map((N,M)=>({pos:[(f(u+M*3)-.5)*2,f(u+M*3+1)-.5,(f(u+M*3+2)-.5)*2],scale:.5+f(u+M*4)*.7}))},[u]);return e.jsx("group",{ref:x,position:o,scale:d,children:h.map((f,w)=>e.jsx("mesh",{geometry:Wr,material:Fr,position:f.pos,scale:f.scale,castShadow:!1,receiveShadow:!1},w))})});we.displayName="Cloud";const Ce=r.memo(({position:o,speed:d,offset:y})=>{const u=r.useRef(null),x=r.useRef(null),b=r.useRef(null),h=r.useRef(0);return de(f=>{if(u.current){const w=f.clock.elapsedTime+y;h.current+=1;const N=Math.sin(w*d),M=Math.cos(w*d);if(u.current.position.x=o[0]+N*(P/2),u.current.position.z=o[1]+M*(P/2),u.current.rotation.y=-w*d+Math.PI,h.current%2===0){const T=1+Math.sin(w*15)*.3;x.current&&(x.current.scale.y=T),b.current&&(b.current.scale.y=T)}}}),e.jsxs("group",{ref:u,position:[o[0],o[2],o[1]],children:[e.jsx("mesh",{ref:x,geometry:We,material:Fe,position:[.1,0,0],rotation:[0,Math.PI/4,0]}),e.jsx("mesh",{ref:b,geometry:We,material:Fe,position:[-.1,0,0],rotation:[0,-Math.PI/4,0]})]})});Ce.displayName="Bird";const rt=r.memo(()=>e.jsxs("group",{raycast:()=>null,children:[e.jsx(we,{position:[-12,10,4],scale:1.5,speed:.3,seed:1}),e.jsx(we,{position:[5,12,-8],scale:1.2,speed:.4,seed:2}),e.jsx(we,{position:[15,9,10],scale:1.6,speed:.25,seed:3}),e.jsxs("group",{position:[0,0,0],scale:.8,children:[e.jsx(Ce,{position:[0,0,8],speed:.5,offset:0}),e.jsx(Ce,{position:[2,0,8],speed:.5,offset:1.5})]})]}));rt.displayName="EnvironmentEffects";const Hr=({messages:o,isVisible:d,onClear:y})=>{const[u,x]=r.useState(!1);return d?e.jsxs("div",{className:"fixed bottom-24 md:bottom-6 right-4 md:right-6 w-[calc(100%-2rem)] md:w-70 z-50 flex flex-col pointer-events-auto",children:[e.jsxs("div",{className:"bg-black/40 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10 bg-white/5",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-gray-400",children:"City Feed"})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:y,className:"text-slate-500 hover:text-red-400 transition-colors",title:"Clear all logs",children:e.jsx(Tt,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>x(!u),className:"text-slate-500 hover:text-white transition-colors",children:u?e.jsx(It,{className:"w-3 h-3"}):e.jsx(Ze,{className:"w-3 h-3"})}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] animate-pulse"})]})]}),!u&&e.jsx("div",{className:"h-40 md:h-64 overflow-y-auto p-4 space-y-3 custom-scrollbar",children:o.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-slate-600 italic text-xs font-mono",children:"Waiting for citizen feedback..."}):o.map(b=>e.jsx("div",{className:"relative group animate-in fade-in slide-in-from-bottom-2 duration-300",children:e.jsxs("div",{className:"bg-white/5 border-l-2 border-green-500/80 p-3 pl-4 rounded-r-lg hover:bg-white/10 transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("span",{className:"text-[10px] font-bold text-gray-500 font-mono tracking-tight",children:["@",b.user]}),e.jsx("span",{className:"text-[9px] text-gray-600 font-mono uppercase",children:b.timestamp})]}),e.jsx("p",{className:"text-xs text-gray-200 font-mono leading-relaxed pr-8",children:b.content})]})},b.id))})]}),e.jsx("style",{dangerouslySetInnerHTML:{__html:`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(71, 85, 105, 0.5);
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(100, 116, 139, 0.8);
        }
      `}})]}):null},Vr=({onStart:o,hasSavedGame:d})=>e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center z-50 text-white font-sans p-6 bg-black/30 backdrop-blur-sm transition-all duration-1000",children:e.jsxs("div",{className:"max-w-md w-full bg-slate-900/90 p-8 rounded-2xl border border-slate-700 shadow-2xl backdrop-blur-xl relative overflow-hidden animate-fade-in",children:[e.jsx("div",{className:"absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("div",{className:"absolute -bottom-24 -left-24 w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-black mb-2 bg-linear-to-br from-white via-cyan-200 to-blue-400 bg-clip-text text-transparent tracking-tight",children:"Neo City"}),e.jsx("p",{className:"text-slate-400 mb-8 text-sm font-medium uppercase tracking-widest",children:"Cyberpunk City Simulation"}),e.jsxs("div",{className:"space-y-3",children:[d&&e.jsxs("button",{onClick:()=>o(!0),className:"w-full py-4 bg-linear-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-green-900/20 transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide flex items-center justify-center gap-2",children:[e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),"Continue"]}),e.jsx("button",{onClick:()=>o(!1),className:`w-full py-4 text-white font-bold rounded-xl shadow-lg transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide ${d?"bg-linear-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 shadow-slate-900/20":"bg-linear-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 shadow-cyan-900/20"}`,children:d?"New Game":"Start Building"})]})]})]})}),Yr=()=>{const[o,d]=r.useState(!1),[y,u]=r.useState([]),[x,b]=r.useState(Le),[h,f]=r.useState("Neo City"),[w,N]=r.useState(null),[M,T]=r.useState(null),[E,m]=r.useState(null),[A,_]=r.useState(10),[k,t]=r.useState([]),[g,n]=r.useState(!0),{isVisible:z}=bt({considerFocus:!0}),C=Ve(),[l,s]=r.useState(_e.medium),[S,p]=r.useState(l.pixelRatio),[c,a]=r.useState({autoSaveEnabled:!0,lastSavedAt:null}),[i,O]=r.useState(!1),v=r.useRef(y),j=r.useRef(x),L=r.useRef(h),J=r.useRef(A),X=r.useRef(k),se=r.useRef(x.money);r.useEffect(()=>{v.current=y},[y]),r.useEffect(()=>{j.current=x},[x]),r.useEffect(()=>{L.current=h},[h]),r.useEffect(()=>{J.current=A},[A]),r.useEffect(()=>{X.current=k},[k]),r.useEffect(()=>{(async()=>{const U=await Se.hasSave();O(U)})()},[]);const oe=r.useCallback(async(D=!1)=>{const U=await Se.save(v.current,j.current,L.current,J.current,X.current);if(U&&(a(B=>({...B,lastSavedAt:Date.now()})),!D)){const Y=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t(F=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:"City data synchronized to neural network.",timestamp:Y,type:"positive"},...F])}return U},[t]),Q=r.useCallback(async()=>{const D=await Se.load();return D?(u(D.cityData),b(D.stats),f(D.cityName),_(D.gameTime),t(D.feedMessages),a(U=>({...U,lastSavedAt:D.savedAt})),!0):!1},[]),st=async(D=!1)=>{if(D)await Q();else{b(Le),_(10);const U=[];for(let Y=0;Y<P;Y++)for(let F=0;F<P;F++)U.push({x:Y,z:F,type:R.EMPTY,level:0});u(U);const B={id:"welcome",user:"SYSTEM",content:`Welcome to ${h}. Terrain generation complete. Ready for development.`,timestamp:"10:00 AM",type:"neutral"};t([B])}d(!0)},ot=()=>{a(D=>({...D,autoSaveEnabled:!D.autoSaveEnabled}))};r.useEffect(()=>{if(!o||!c.autoSaveEnabled||!z)return;const D=setInterval(()=>{oe(!0)},6e4);return()=>clearInterval(D)},[o,c.autoSaveEnabled,oe,z]),r.useEffect(()=>{if(!o||!z)return;const D=setInterval(()=>{u(U=>{const B=U.reduce((K,be)=>(K[be.type]=(K[be.type]||0)+1,K),{}),Y=(B[R.RESIDENTIAL]||0)*10,F=(B[R.COMMERCIAL]||0)*15+(B[R.INDUSTRIAL]||0)*25,ae=(B[R.ROAD]||0)*2+(B[R.PARK]||0)*10;return b(K=>({...K,population:Y,money:K.money+(F-ae),income:F,expense:ae})),U})},5e3);return()=>clearInterval(D)},[o]);const Ee=r.useRef(A);r.useEffect(()=>{if(!o||!z)return;const D=setInterval(()=>{_(U=>{const B=U+.08;return B>=24?0:B})},100);return()=>clearInterval(D)},[o,z]),r.useEffect(()=>{o&&(Ee.current>22&&A<2&&b(D=>({...D,day:D.day+1})),Ee.current=A)},[A,o]),r.useEffect(()=>{if(o){if(x.money<0&&se.current>=0){const U=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t(B=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:"Warning: City treasury is in deficit! Revenue generation required.",timestamp:U,type:"negative"},...B].slice(0,50))}se.current=x.money}},[x.money]);const at=r.useCallback((D,U)=>{o&&(m(null),u(B=>{const Y=B.findIndex(q=>q.x===D&&q.z===U);if(Y===-1)return B;const F=B[Y];if(w===null)return F.type!==R.EMPTY?T({x:D,z:U}):T(null),B;if(w===R.EMPTY){if(F.type===R.EMPTY)return B;const q=[...B],De=Math.floor(ve[F.type].cost*.8),dt=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t(ye=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:`Demolition complete: ${ve[F.type].label} removed. $${De} refunded to treasury.`,timestamp:dt,type:"positive"},...ye].slice(0,50)),b(ye=>({...ye,money:ye.money+De})),q[Y]={...F,type:R.EMPTY,level:0},T(null),q}if(F.type!==R.EMPTY)return T({x:D,z:U}),B;const ae=ve[w];if(j.current.money<ae.cost)return m("Insufficient budget!"),B;const K=[...B],be=Math.floor(Math.random()*3);K[Y]={...F,type:w,level:be};const lt=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t(q=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:`Construction complete: ${ae.label} deployed at [${D}, ${U}].`,timestamp:lt,type:"neutral"},...q].slice(0,50)),b(q=>({...q,money:q.money-ae.cost})),T({x:D,z:U}),K}))},[w,o]),nt=D=>{N(D),T(null),m(null)},it=y.find(D=>D.x===M?.x&&D.z===M?.z)||null,ct=r.useMemo(()=>({antialias:l.antialias,powerPreference:"high-performance",stencil:!1,depth:!0,alpha:!1}),[l.antialias]),Ae=r.useCallback(D=>{const U=_e[D];s(U),p(U.pixelRatio)},[]);return e.jsxs("div",{className:"relative w-full h-screen",children:[e.jsxs(ft,{shadows:l.shadows,camera:{position:[15,15,15],fov:C?50:40},dpr:S,gl:ct,frameloop:z?"always":"never",performance:{min:.5},onPointerMissed:()=>{N(null),T(null)},children:[e.jsx(xr,{pixelated:!0}),e.jsx(vr,{onDecline:()=>{p(Math.max(.5,S-.25))},onIncline:()=>{p(Math.min(l.pixelRatio,S+.25))},flipflops:3,onFallback:()=>Ae("low")}),l.environmentEffects&&e.jsx(rt,{}),e.jsx(tt,{gameTime:A,lowQuality:l.level==="low",shadowMapSize:l.shadowMapSize}),e.jsx(Ir,{cityData:y,onTileClick:at,selectedType:w,selectedBuilding:M,isMobile:C}),e.jsx($r,{cityData:y}),l.shadows&&e.jsx(pr,{position:[0,-.01,0],opacity:.25,scale:25,blur:2,far:4,resolution:l.level==="high"?512:256}),e.jsx(Nt,{preset:"city"}),e.jsx(mt,{makeDefault:!0,maxPolarAngle:Math.PI/2.1,minDistance:5,maxDistance:40,enableDamping:!0,dampingFactor:.05})]}),!o&&e.jsx(Vr,{onStart:st,hasSavedGame:i}),o&&e.jsxs(e.Fragment,{children:[C===!1&&e.jsx(Hr,{messages:k,isVisible:g,onClear:()=>t([])}),E&&e.jsxs("div",{className:"absolute top-24 left-1/2 -translate-x-1/2 z-50 bg-red-600/90 text-white px-6 py-2 rounded-full shadow-lg border border-red-400 animate-bounce pointer-events-none flex items-center",children:[e.jsx(Lt,{className:"w-5 h-5 mr-2"}),E]}),e.jsx(_r,{stats:x,cityName:h,onRenameCity:f,selectedType:w,onSelectType:nt,selectedBuildingInfo:it,onDeselect:()=>{T(null),N(null)},isFeedVisible:g,onToggleFeed:()=>n(!g),saveSettings:c,onSave:()=>oe(!1),onToggleAutoSave:ot,gameTime:A,performanceLevel:l.level,onPerformanceChange:Ae})]})]})},ms={fullscreen:!0};function ps(){return[{title:"Neo City"},{property:"og:title",content:"Neo City"},{name:"description",content:"Neo City - A city building simulation game with isometric 3D graphics."}]}const xs=ut(Yr);export{xs as default,ms as handle,ps as meta};
