import{r as o,j as e,w as Ae}from"./chunk-JMJ3UQ3L-DTa-kQyz.js";import{_ as Se,a as be,u as ye,C as Ie}from"./OrbitControls-DRK-Wmte.js";import{s as ke,g as ze,r as Le}from"./index-tSOQ2Rud.js";import{V as D,S as me,B as Oe,a as Ue,j as Te,k as _e,_ as je,h as Be,aq as We,C as ae,M as ve,ao as Ne,z as Ge,ar as ee}from"./three.module-DNtCYGiW.js";import{G as Fe}from"./Grid-Cn1Ie2V6.js";import{v as Ve,E as $e}from"./Environment-D3Xp-jp-.js";import{O as Ye}from"./OrbitControls-ClhYfUAP.js";import"./shaderMaterial-BL2Umirn.js";import"./constants-BCyxaF58.js";var He=Object.defineProperty,Ke=(r,s,a)=>s in r?He(r,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[s]=a,Me=(r,s,a)=>(Ke(r,typeof s!="symbol"?s+"":s,a),a);const qe=(()=>{const r={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new D},up:{value:new D(0,1,0)}},vertexShader:`
      uniform vec3 sunPosition;
      uniform float rayleigh;
      uniform float turbidity;
      uniform float mieCoefficient;
      uniform vec3 up;

      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      // constants for atmospheric scattering
      const float e = 2.71828182845904523536028747135266249775724709369995957;
      const float pi = 3.141592653589793238462643383279502884197169;

      // wavelength of used primaries, according to preetham
      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

      // mie stuff
      // K coefficient for the primaries
      const float v = 4.0;
      const vec3 K = vec3( 0.686, 0.678, 0.666 );
      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

      // earth shadow hack
      // cutoffAngle = pi / 1.95;
      const float cutoffAngle = 1.6110731556870734;
      const float steepness = 1.5;
      const float EE = 1000.0;

      float sunIntensity( float zenithAngleCos ) {
        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
      }

      vec3 totalMie( float T ) {
        float c = ( 0.2 * T ) * 10E-18;
        return 0.434 * c * MieConst;
      }

      void main() {

        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        gl_Position.z = gl_Position.w; // set z to camera.far

        vSunDirection = normalize( sunPosition );

        vSunE = sunIntensity( dot( vSunDirection, up ) );

        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

      // extinction (absorbtion + out scattering)
      // rayleigh coefficients
        vBetaR = totalRayleigh * rayleighCoefficient;

      // mie coefficients
        vBetaM = totalMie( turbidity ) * mieCoefficient;

      }
    `,fragmentShader:`
      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      uniform float mieDirectionalG;
      uniform vec3 up;

      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

      // constants for atmospheric scattering
      const float pi = 3.141592653589793238462643383279502884197169;

      const float n = 1.0003; // refractive index of air
      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

      // optical length at zenith for molecules
      const float rayleighZenithLength = 8.4E3;
      const float mieZenithLength = 1.25E3;
      // 66 arc seconds -> degrees, and the cosine of that
      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

      // 3.0 / ( 16.0 * pi )
      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
      // 1.0 / ( 4.0 * pi )
      const float ONE_OVER_FOURPI = 0.07957747154594767;

      float rayleighPhase( float cosTheta ) {
        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
      }

      float hgPhase( float cosTheta, float g ) {
        float g2 = pow( g, 2.0 );
        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
      }

      void main() {

        vec3 direction = normalize( vWorldPosition - cameraPos );

      // optical length
      // cutoff angle at 90 to avoid singularity in next formula.
        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
        float sR = rayleighZenithLength * inverse;
        float sM = mieZenithLength * inverse;

      // combined extinction factor
        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

      // in scattering
        float cosTheta = dot( direction, vSunDirection );

        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
        vec3 betaRTheta = vBetaR * rPhase;

        float mPhase = hgPhase( cosTheta, mieDirectionalG );
        vec3 betaMTheta = vBetaM * mPhase;

        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

      // nightsky
        float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
        float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
        vec3 L0 = vec3( 0.1 ) * Fex;

      // composition + solar disc
        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

        gl_FragColor = vec4( retColor, 1.0 );

      #include <tonemapping_fragment>
      #include <${Ve>=154?"colorspace_fragment":"encodings_fragment"}>

      }
    `},s=new me({name:"SkyShader",fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:Ue.clone(r.uniforms),side:Oe,depthWrite:!1});class a extends Te{constructor(){super(new _e(1,1,1),s)}}return Me(a,"SkyShader",r),Me(a,"material",s),a})(),Xe={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},Ze={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `};function ne(r,s){const a=r+"Geometry";return o.forwardRef(({args:c,children:n,...l},C)=>{const S=o.useRef(null);return o.useImperativeHandle(C,()=>S.current),o.useLayoutEffect(()=>{s?.(S.current)}),o.createElement("mesh",Se({ref:S},l),o.createElement(a,{attach:"geometry",args:c}),n)})}const y=ne("box"),he=ne("cone"),Y=ne("cylinder"),Je=ne("sphere"),Qe=ne("plane"),et=o.forwardRef(({scale:r=10,frames:s=1/0,opacity:a=1,width:c=1,height:n=1,blur:l=1,near:C=0,far:S=10,resolution:m=512,smooth:d=!0,color:w="#000000",depthWrite:z=!1,renderOrder:N,...L},x)=>{const A=o.useRef(null),j=be(O=>O.scene),t=be(O=>O.gl),p=o.useRef(null);c=c*(Array.isArray(r)?r[0]:r||1),n=n*(Array.isArray(r)?r[1]:r||1);const[g,P,k,i,u,f,v]=o.useMemo(()=>{const O=new je(m,m),B=new je(m,m);B.texture.generateMipmaps=O.texture.generateMipmaps=!1;const K=new Be(c,n).rotateX(Math.PI/2),ue=new Te(K),J=new We;J.depthTest=J.depthWrite=!1,J.onBeforeCompile=b=>{b.uniforms={...b.uniforms,ucolor:{value:new ae(w)}},b.fragmentShader=b.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),b.fragmentShader=b.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const ie=new me(Xe),le=new me(Ze);return le.depthTest=ie.depthTest=!1,[O,K,J,ue,ie,le,B]},[m,c,n,r,w]),E=O=>{i.visible=!0,i.material=u,u.uniforms.tDiffuse.value=g.texture,u.uniforms.h.value=O*1/256,t.setRenderTarget(v),t.render(i,p.current),i.material=f,f.uniforms.tDiffuse.value=v.texture,f.uniforms.v.value=O*1/256,t.setRenderTarget(g),t.render(i,p.current),i.visible=!1};let I=0,T,F;return ye(()=>{p.current&&(s===1/0||I<s)&&(I++,T=j.background,F=j.overrideMaterial,A.current.visible=!1,j.background=null,j.overrideMaterial=k,t.setRenderTarget(g),t.render(j,p.current),E(l),d&&E(l*.4),t.setRenderTarget(null),A.current.visible=!0,j.overrideMaterial=F,j.background=T)}),o.useImperativeHandle(x,()=>A.current,[]),o.createElement("group",Se({"rotation-x":Math.PI/2},L,{ref:A}),o.createElement("mesh",{renderOrder:N,geometry:P,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},o.createElement("meshBasicMaterial",{transparent:!0,map:g.texture,opacity:a,depthWrite:z})),o.createElement("orthographicCamera",{ref:p,args:[-c/2,c/2,n/2,-n/2,C,S]}))});function tt(r,s,a=new D){const c=Math.PI*(r-.5),n=2*Math.PI*(s-.5);return a.x=Math.cos(n),a.y=Math.sin(c),a.z=Math.sin(n),a}const rt=o.forwardRef(({inclination:r=.6,azimuth:s=.1,distance:a=1e3,mieCoefficient:c=.005,mieDirectionalG:n=.8,rayleigh:l=.5,turbidity:C=10,sunPosition:S=tt(r,s),...m},d)=>{const w=o.useMemo(()=>new D().setScalar(a),[a]),[z]=o.useState(()=>new qe);return o.createElement("primitive",Se({object:z,ref:d,"material-uniforms-mieCoefficient-value":c,"material-uniforms-mieDirectionalG-value":n,"material-uniforms-rayleigh-value":l,"material-uniforms-sunPosition-value":S,"material-uniforms-turbidity-value":C,scale:w},m))});var h=(r=>(r.EMPTY="EMPTY",r.ROAD="ROAD",r.RESIDENTIAL="RESIDENTIAL",r.COMMERCIAL="COMMERCIAL",r.INDUSTRIAL="INDUSTRIAL",r.PARK="PARK",r.BUS_STOP="BUS_STOP",r))(h||{});const R=16,we=1,ge={[h.EMPTY]:{type:h.EMPTY,cost:0,color:"#2d3748",label:"Bulldoze",icon:"fa-eraser",description:"Clear the land for new developments."},[h.ROAD]:{type:h.ROAD,cost:10,color:"#4a5568",label:"Road",icon:"fa-road",description:"Connect your city. Essential for cars and growth."},[h.RESIDENTIAL]:{type:h.RESIDENTIAL,cost:50,color:"#48bb78",label:"Residential",icon:"fa-home",description:"Where your citizens live. Provides population."},[h.COMMERCIAL]:{type:h.COMMERCIAL,cost:80,color:"#4299e1",label:"Commercial",icon:"fa-shopping-cart",description:"Stores and offices. Boosts city income and happiness."},[h.INDUSTRIAL]:{type:h.INDUSTRIAL,cost:120,color:"#ecc94b",label:"Industrial",icon:"fa-industry",description:"Factories and production. High income but low happiness."},[h.PARK]:{type:h.PARK,cost:200,color:"#38b2ac",label:"Park",icon:"fa-tree",description:"Green spaces for relaxation. Greatly improves happiness."},[h.BUS_STOP]:{type:h.BUS_STOP,cost:150,color:"#f6ad55",label:"Bus Stop",icon:"fa-bus",description:"Define routes. Buses stop at nearby roads to pick up citizens."}},st={money:5e3,population:0,happiness:80,income:0,expense:0},ot="neo-city-db",X="saves",te="current-save",at=1;class nt{db=null;dbReady;constructor(){this.dbReady=this.initDB()}initDB(){return new Promise((s,a)=>{if(typeof window>"u"||!window.indexedDB){s();return}const c=indexedDB.open(ot,1);c.onerror=()=>{console.error("Failed to open IndexedDB:",c.error),a(c.error)},c.onsuccess=()=>{this.db=c.result,s()},c.onupgradeneeded=n=>{const l=n.target.result;l.objectStoreNames.contains(X)||l.createObjectStore(X)}})}async save(s,a,c,n,l){await this.dbReady;const C={cityData:s,stats:a,cityName:c,gameTime:n,feedMessages:l,savedAt:Date.now(),version:at};return this.db?new Promise(S=>{const w=this.db.transaction([X],"readwrite").objectStore(X).put(C,te);w.onsuccess=()=>S(!0),w.onerror=()=>{console.error("IndexedDB save failed, trying localStorage"),S(this.saveToLocalStorage(C))}}):this.saveToLocalStorage(C)}saveToLocalStorage(s){try{return ke(te,s),!0}catch(a){return console.error("localStorage save failed:",a),!1}}async load(){if(await this.dbReady,this.db){const s=await new Promise(a=>{const l=this.db.transaction([X],"readonly").objectStore(X).get(te);l.onsuccess=()=>a(l.result||null),l.onerror=()=>{console.error("IndexedDB load failed, trying localStorage"),a(null)}});if(s)return s}return this.loadFromLocalStorage()}loadFromLocalStorage(){try{const s=ze(te,!0);if(s)return s}catch(s){console.error("localStorage load failed:",s)}return null}async deleteSave(){if(await this.dbReady,this.db)return new Promise(s=>{const n=this.db.transaction([X],"readwrite").objectStore(X).delete(te);n.onsuccess=()=>s(!0),n.onerror=()=>s(!1)});try{return Le(te),!0}catch{return!1}}async hasSave(){return await this.load()!==null}}const xe=new nt,it=({type:r,variant:s=0,position:a,isSelected:c,connections:n})=>{const l=o.useRef(null);ye(S=>{l.current&&c?l.current.position.y=Math.sin(S.clock.elapsedTime*4)*.1+.1:l.current&&(l.current.position.y=ve.lerp(l.current.position.y,0,.1))});const C=o.useMemo(()=>{const S=c?"#ffffff":"#000000",m=c?.5:0,d="#fbbf24",w="#ffffff",z="#1a1a1a",N="#a0aec0",L="#2d3748";switch(r){case h.ROAD:{const{n:x=!1,s:A=!1,e:j=!1,w:t=!1}=n||{},p=[x,A,j,t].filter(Boolean).length,g=x&&A&&!j&&!t,P=j&&t&&!x&&!A,k=p>2,i=({type:v="double",rotation:E=0,length:I=.5,position:T=[0,.081,0]})=>v==="double"?e.jsxs("group",{rotation:[0,E,0],position:T,children:[e.jsx(y,{args:[.02,.005,I],children:e.jsx("meshStandardMaterial",{color:d})}),e.jsx(y,{args:[.02,.005,I],position:[.04,0,0],children:e.jsx("meshStandardMaterial",{color:d})})]}):v==="dashed"?e.jsxs("group",{rotation:[0,E,0],position:T,children:[e.jsx(y,{args:[.02,.005,I*.3],position:[.02,0,I*.3],children:e.jsx("meshStandardMaterial",{color:d})}),e.jsx(y,{args:[.02,.005,I*.3],position:[.02,0,-I*.3],children:e.jsx("meshStandardMaterial",{color:d})})]}):e.jsx(y,{args:[.03,.005,I],rotation:[0,E,0],position:T,children:e.jsx("meshStandardMaterial",{color:d})}),u=({rotation:v=0,position:E=[0,.083,0]})=>e.jsx("group",{rotation:[0,v,0],position:E,children:[-.24,-.12,0,.12,.24].map((I,T)=>e.jsx(y,{args:[.08,.004,.22],position:[I,0,0],children:e.jsx("meshStandardMaterial",{color:w,roughness:.4})},T))}),f=({rotation:v=0,position:E=[0,0,0],args:I=[1,.03,.04]})=>e.jsx(y,{args:I,rotation:[0,v,0],position:E,children:e.jsx("meshStandardMaterial",{color:L,roughness:.7})});return e.jsxs("group",{children:[e.jsx(y,{args:[1,.08,1],position:[0,.04,0],children:e.jsx("meshStandardMaterial",{color:z,emissive:S,emissiveIntensity:m,roughness:.9})}),e.jsx(y,{args:[.1,.022,1],position:[-.45,.08,0],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:N})}),e.jsx(y,{args:[.1,.022,1],position:[.45,.08,0],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:N})}),e.jsx(y,{args:[1,.022,.1],position:[0,.08,-.45],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:N})}),e.jsx(y,{args:[1,.022,.1],position:[0,.08,.45],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:N})}),x&&(!g||k)&&e.jsx(u,{position:[0,.083,-.36]}),A&&(!g||k)&&e.jsx(u,{position:[0,.083,.36]}),t&&(!P||k)&&e.jsx(u,{rotation:Math.PI/2,position:[-.36,.083,0]}),j&&(!P||k)&&e.jsx(u,{rotation:Math.PI/2,position:[.36,.083,0]}),e.jsxs("group",{position:[-.01,0,0],children:[x&&e.jsx(i,{type:g?"dashed":"double",length:.4,position:[0,.081,-.25]}),A&&e.jsx(i,{type:g?"dashed":"double",length:.4,position:[0,.081,.25]}),t&&e.jsx(i,{type:P?"dashed":"double",rotation:Math.PI/2,length:.4,position:[-.25,.081,0]}),j&&e.jsx(i,{type:P?"dashed":"double",rotation:Math.PI/2,length:.4,position:[.25,.081,0]})]}),!x&&e.jsx(f,{position:[0,.09,-.48],args:[1,.04,.04]}),!A&&e.jsx(f,{position:[0,.09,.48],args:[1,.04,.04]}),!j&&e.jsx(f,{position:[.48,.09,0],args:[.04,.04,1]}),!t&&e.jsx(f,{position:[-.48,.09,0],args:[.04,.04,1]})]})}case h.RESIDENTIAL:{const x="#48bb78";return s===1?e.jsxs("group",{children:[e.jsx(y,{args:[.4,.7,.6],position:[-.15,.35,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(y,{args:[.4,.4,.6],position:[.15,.2,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#c6f6d5"})}),e.jsx(y,{args:[.8,.05,.7],position:[0,.7,0],children:e.jsx("meshStandardMaterial",{color:"#2d3748"})})]}):s===2?e.jsxs("group",{children:[e.jsx(y,{args:[.8,.35,.4],position:[0,.175,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(y,{args:[.9,.1,.5],position:[0,.35,0],rotation:[.05,0,0],children:e.jsx("meshStandardMaterial",{color:"#22543d"})})]}):e.jsxs("group",{children:[e.jsx(y,{args:[.6,.5,.6],position:[0,.25,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(he,{args:[.5,.4,4],position:[0,.7,0],rotation:[0,Math.PI/4,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#276749"})})]})}case h.COMMERCIAL:{const x="#4299e1";return s===1?e.jsxs("group",{children:[e.jsx(y,{args:[.6,1.2,.6],position:[0,.6,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m,transparent:!0,opacity:.9,metalness:1,roughness:0})}),e.jsx(y,{args:[.65,.05,.65],position:[0,1.2,0],children:e.jsx("meshStandardMaterial",{color:"#2b6cb0"})})]}):s===2?e.jsxs("group",{children:[e.jsx(y,{args:[.8,.4,.8],position:[0,.2,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(y,{args:[.2,.5,.1],position:[.2,.45,.35],children:e.jsx("meshStandardMaterial",{color:"#f6e05e",emissive:"#f6e05e",emissiveIntensity:.5})}),e.jsx(y,{args:[.9,.05,.9],position:[0,.4,0],children:e.jsx("meshStandardMaterial",{color:"#2c5282"})})]}):e.jsxs("group",{children:[e.jsx(y,{args:[.7,.8,.7],position:[0,.4,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(y,{args:[.75,.1,.75],position:[0,.85,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#2b6cb0"})})]})}case h.INDUSTRIAL:{const x="#ecc94b";return s===1?e.jsxs("group",{children:[e.jsx(Y,{args:[.2,.2,.5,12],position:[-.2,.25,-.2],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#cbd5e0",emissive:S,emissiveIntensity:m})}),e.jsx(Y,{args:[.2,.2,.5,12],position:[.2,.25,.2],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#cbd5e0"})}),e.jsx(y,{args:[.8,.1,.8],position:[0,.05,0],children:e.jsx("meshStandardMaterial",{color:"#4a5568"})})]}):s===2?e.jsxs("group",{children:[e.jsx(y,{args:[.7,.4,.7],position:[0,.2,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(Y,{args:[.05,.05,.8,6],position:[.2,.4,.2],children:e.jsx("meshStandardMaterial",{color:"#744210"})}),e.jsx(Y,{args:[.05,.05,.8,6],position:[-.2,.4,.2],children:e.jsx("meshStandardMaterial",{color:"#744210"})}),e.jsx(Y,{args:[.05,.05,.8,6],position:[0,.4,-.2],children:e.jsx("meshStandardMaterial",{color:"#744210"})})]}):e.jsxs("group",{children:[e.jsx(y,{args:[.8,.6,.8],position:[0,.3,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(Y,{args:[.1,.1,1,8],position:[.2,.6,.2],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#744210"})})]})}case h.PARK:{const x="#38b2ac";return s===1?e.jsxs("group",{children:[e.jsx(y,{args:[.9,.1,.9],position:[0,.05,0],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(Y,{args:[.3,.3,.05,16],position:[0,.1,0],children:e.jsx("meshStandardMaterial",{color:"#63b3ed",metalness:1,roughness:0})}),e.jsx(Je,{args:[.1,8,8],position:[0,.2,0],children:e.jsx("meshStandardMaterial",{color:"#ebf8ff",transparent:!0,opacity:.6})})]}):s===2?e.jsxs("group",{children:[e.jsx(y,{args:[.9,.1,.9],position:[0,.05,0],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(y,{args:[.2,.2,.2],position:[-.2,.2,.2],children:e.jsx("meshStandardMaterial",{color:"#f56565"})}),e.jsx(Y,{args:[.02,.2,.4,4],position:[.2,.2,-.2],rotation:[0,0,.5],children:e.jsx("meshStandardMaterial",{color:"#4299e1"})})]}):e.jsxs("group",{children:[e.jsx(y,{args:[.9,.1,.9],position:[0,.05,0],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:x,emissive:S,emissiveIntensity:m})}),e.jsx(he,{args:[.2,.5,8],position:[0,.4,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#234e52"})}),e.jsx(he,{args:[.15,.3,8],position:[.25,.25,.2],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#2d6a4f"})})]})}case h.BUS_STOP:return e.jsxs("group",{children:[e.jsx(y,{args:[.8,.05,.8],position:[0,.025,0],receiveShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#718096",emissive:S,emissiveIntensity:m})}),e.jsx(y,{args:[.6,.5,.05],position:[0,.25,-.3],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#4a5568",transparent:!0,opacity:.8})}),e.jsx(y,{args:[.7,.05,.4],position:[0,.5,-.15],rotation:[.1,0,0],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#2d3748"})}),e.jsx(y,{args:[.4,.1,.15],position:[0,.1,-.15],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#744210"})}),e.jsx(Y,{args:[.02,.02,.6,8],position:[.3,.3,.2],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#a0aec0"})}),e.jsx(y,{args:[.15,.1,.02],position:[.3,.55,.2],castShadow:!0,children:e.jsx("meshStandardMaterial",{color:"#f6ad55"})})]});default:return null}},[r,s,c,n]);return e.jsx("group",{position:a,ref:l,children:C})},lt=({cityData:r,onTileClick:s,selectedType:a,selectedBuilding:c})=>{const[n,l]=o.useState(null),C=d=>{d.stopPropagation();const w=Math.floor(d.point.x+R/2),z=Math.floor(d.point.z+R/2);w>=0&&w<R&&z>=0&&z<R?l({x:w,z}):l(null)},S=d=>{d.stopPropagation(),n&&s(n.x,n.z)},m=(d,w)=>r.some(z=>z.x===d&&z.z===w&&z.type===h.ROAD);return e.jsxs("group",{children:[e.jsxs("group",{position:[0,-.25,0],children:[e.jsx(y,{args:[R,.5,R],children:e.jsx("meshStandardMaterial",{color:"#38a169"})}),e.jsx(y,{args:[R,1.5,R],position:[0,-1,0],children:e.jsx("meshStandardMaterial",{color:"#4a3728"})})]}),e.jsx(Fe,{infiniteGrid:!1,args:[R,R],fadeDistance:30,sectionSize:we,sectionThickness:1.5,sectionColor:"#2d3748",cellSize:we,cellThickness:.5,cellColor:"#2d3748",position:[0,.01,0]}),e.jsx(Qe,{args:[R,R],rotation:[-Math.PI/2,0,0],position:[0,.02,0],onPointerMove:C,onPointerOut:()=>l(null),onClick:S,receiveShadow:!0,children:e.jsx("meshStandardMaterial",{transparent:!0,opacity:0})}),r.map(d=>{if(d.type===h.EMPTY)return null;const w=d.type===h.ROAD?{n:m(d.x,d.z-1),s:m(d.x,d.z+1),e:m(d.x+1,d.z),w:m(d.x-1,d.z)}:void 0;return e.jsx(it,{type:d.type,variant:d.level,isSelected:c?.x===d.x&&c?.z===d.z,position:[d.x-R/2+.5,0,d.z-R/2+.5],connections:w},`${d.x}-${d.z}`)}),n&&e.jsxs("mesh",{position:[n.x-R/2+.5,.03,n.z-R/2+.5],rotation:[-Math.PI/2,0,0],children:[e.jsx("planeGeometry",{args:[.95,.95]}),e.jsx("meshStandardMaterial",{color:a===h.EMPTY?"#f56565":"#ffffff",transparent:!0,opacity:.3})]})]})},ct=({stats:r,cityName:s,onRenameCity:a,selectedType:c,onSelectType:n,selectedBuildingInfo:l,onDeselect:C,isFeedVisible:S,onToggleFeed:m,saveSettings:d,onSave:w,onToggleAutoSave:z})=>{const[N,L]=o.useState(!1),[x,A]=o.useState(s),j=o.useRef(null),t=l?l.type:c,p=t!==h.EMPTY?ge[t]:null;o.useEffect(()=>{N&&j.current&&(j.current.focus(),j.current.select())},[N]);const g=P=>{P?.preventDefault();const k=x.trim()||s;a(k),A(k),L(!1)};return e.jsxs("div",{className:"absolute inset-0 pointer-events-none flex flex-col justify-between p-6",children:[e.jsxs("div",{className:"flex flex-col space-y-4 items-start w-full relative",children:[e.jsx("div",{className:"pointer-events-auto group",children:N?e.jsx("form",{onSubmit:g,className:"flex items-center",children:e.jsx("input",{ref:j,type:"text",value:x,onChange:P=>A(P.target.value),onBlur:()=>g(),className:"bg-gray-800/80 backdrop-blur-md border-2 border-blue-500 rounded-lg px-4 py-1 text-2xl font-black text-white shadow-[0_0_15px_rgba(59,130,246,0.5)] focus:outline-none tracking-tight",maxLength:24})}):e.jsxs("div",{onClick:()=>L(!0),className:"flex items-center space-x-3 cursor-pointer hover:translate-x-1 transition-transform duration-200",children:[e.jsx("h1",{className:"text-3xl font-black italic tracking-tighter drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] text-white bg-linear-to-br from-white to-gray-400 bg-clip-text",children:s}),e.jsx("i",{className:"fas fa-pen text-xs text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"})]})}),e.jsx("div",{className:"flex justify-start items-start pointer-events-auto w-full",children:e.jsxs("div",{className:"bg-gray-900/80 backdrop-blur-md border border-gray-700 p-4 rounded-xl shadow-2xl flex space-x-8",children:[e.jsx(de,{icon:"fa-wallet",label:"Budget",value:`$${r.money.toLocaleString()}`,color:"text-yellow-400"}),e.jsx(de,{icon:"fa-users",label:"Population",value:r.population.toLocaleString(),color:"text-green-400"}),e.jsx(de,{icon:"fa-smile",label:"Happiness",value:`${r.happiness}%`,color:"text-blue-400"}),e.jsx(de,{icon:"fa-chart-line",label:"Cashflow",value:`$${r.income-r.expense}/m`,color:r.income-r.expense>=0?"text-green-400":"text-red-400"})]})}),e.jsxs("div",{className:"flex items-center space-x-3 pointer-events-auto",children:[e.jsxs("button",{onClick:w,className:"bg-blue-600/80 hover:bg-blue-500 backdrop-blur-md text-white px-4 py-2 rounded-lg border border-blue-400/50 transition-all flex items-center space-x-2 text-sm font-bold shadow-lg shadow-blue-900/20",children:[e.jsx("i",{className:"fas fa-save"}),e.jsx("span",{children:"Save City"})]}),e.jsxs("button",{onClick:z,className:`backdrop-blur-md px-4 py-2 rounded-lg border transition-all flex items-center space-x-2 text-sm font-bold shadow-lg ${d.autoSaveEnabled?"bg-green-600/80 border-green-400/50 text-white shadow-green-900/20":"bg-gray-700/80 border-gray-500/50 text-gray-300 shadow-black/20"}`,children:[e.jsx("i",{className:`fas ${d.autoSaveEnabled?"fa-sync fa-spin":"fa-sync"}`}),e.jsxs("span",{children:["Auto-save: ",d.autoSaveEnabled?"ON":"OFF"]})]}),d.lastSavedAt&&e.jsxs("span",{className:"text-[10px] text-gray-400 font-mono uppercase tracking-tighter",children:["Last Sync: ",new Date(d.lastSavedAt).toLocaleTimeString()]})]})]}),p&&e.jsxs("div",{className:"absolute top-1/2 left-6 -translate-y-1/2 w-72 bg-gray-900/95 backdrop-blur-xl border border-blue-500/30 rounded-2xl shadow-2xl p-6 pointer-events-auto animate-in slide-in-from-left duration-300",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:"p-3 rounded-lg bg-gray-800",children:e.jsx("i",{className:`fas ${p.icon} text-2xl`,style:{color:p.color}})}),l&&e.jsx("button",{onClick:C,className:"text-gray-500 hover:text-white transition-colors",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx("h3",{className:"text-xl font-bold mb-1",children:p.label}),e.jsx("p",{className:"text-xs text-gray-500 mb-4 uppercase tracking-widest",children:l?"Building Inspector":"Construction Tool"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-gray-300 leading-relaxed italic",children:['"',p.description,'"']}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 border-t border-gray-800 pt-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Cost"}),e.jsxs("p",{className:`text-sm ${r.money>=p.cost?"text-green-400":"text-red-400"}`,children:["$",p.cost.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Status"}),e.jsx("p",{className:"text-sm text-green-400",children:l?"Operational":"Ready"})]}),l&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Coordinates"}),e.jsxs("p",{className:"text-sm text-gray-400",children:["X: ",l.x,", Z: ",l.z]})]})]})]})]}),e.jsx("div",{className:"flex justify-start pointer-events-auto",children:e.jsx("div",{className:"bg-gray-900/90 backdrop-blur-md border border-gray-700 p-2 rounded-2xl shadow-2xl flex space-x-2",children:Object.values(ge).map(P=>e.jsxs("button",{onClick:()=>n(P.type),className:`flex flex-col items-center justify-center w-20 h-20 rounded-xl transition-all ${c===P.type?"bg-blue-600 ring-2 ring-white scale-105":"bg-gray-800 hover:bg-gray-700"}`,children:[e.jsx("i",{className:`fas ${P.icon} text-2xl mb-1`}),e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-tighter",children:P.label}),e.jsxs("span",{className:"text-[10px] opacity-70",children:["$",P.cost]})]},P.type))})})]})},de=({icon:r,label:s,value:a,color:c})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] uppercase font-bold text-gray-400 tracking-widest",children:s}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("i",{className:`fas ${r} ${c}`}),e.jsx("span",{className:"text-xl font-bold tabular-nums",children:a})]})]}),H=[.14,.32],dt=.42,ut=.85,pe=1.6,Z=24,re=40,se=6,ft=3,ht=2,xt=2.5,W=new Ne,M=new Ne,oe=new ae,pt=new Ge().makeScale(0,0,0),Pe=["#f56565","#4299e1","#f6e05e","#ffffff","#2d3748","#38b2ac","#9f7aea"],Ce=["#f6ad55","#4fd1c5","#6366f1"],Re=["#8d5524","#c68642","#e0ac69","#f1c27d","#ffdbac"],Ee=["#2563eb","#dc2626","#16a34a","#d97706","#7c3aed","#db2777","#4b5563","#1e293b","#f97316","#06b6d4","#84cc16","#6366f1"],mt=({cityData:r})=>{const s=o.useRef(null),a=o.useRef(null),c=o.useRef(null),n=o.useRef(null),l=o.useRef(null),C=o.useRef(null),S=o.useRef(null),m=o.useRef(null),d=o.useRef(null),w=o.useRef([]);o.useEffect(()=>{const N=r.filter(i=>i.type===h.ROAD),L=r.filter(i=>i.type===h.BUS_STOP),x=r.filter(i=>i.type!==h.EMPTY&&i.type!==h.ROAD),A=w.current.filter(i=>i.type==="car"),j=w.current.filter(i=>i.type==="person"),t=w.current.filter(i=>i.type==="bus");let p=[...w.current];p=p.filter(i=>{const u=Math.floor(i.targetPos.x+R/2),f=Math.floor(i.targetPos.z+R/2),v=r.find(E=>E.x===u&&E.z===f);return i.type==="car"||i.type==="bus"?v&&v.type===h.ROAD:v&&v.type!==h.EMPTY});const g=Math.min(Z,N.length)-A.length;if(g>0)for(let i=0;i<g;i++){const u=N[Math.floor(Math.random()*N.length)],f=new D(u.x-R/2+.5,.08,u.z-R/2+.5),v=Math.floor(Math.random()*H.length);p.push({id:Math.random(),type:"car",prevPos:f.clone(),currentPos:f.clone(),targetPos:f.clone(),actualWorldPos:f.clone(),progress:1,baseSpeed:.5+Math.random()*.4,currentSpeed:.5,color:Pe[Math.floor(Math.random()*Pe.length)],waitTimer:0,lastDirection:new D(0,0,1),targetRotation:new ee,currentRotation:new ee,laneIndex:v,visualLaneOffset:H[v],laneChangeTimer:0,preferredSide:0,isStoppedAtStation:!1})}const P=Math.min(se,L.length*2)-t.length;if(P>0&&N.length>0)for(let i=0;i<P;i++){const u=N[Math.floor(Math.random()*N.length)],f=new D(u.x-R/2+.5,.12,u.z-R/2+.5);p.push({id:Math.random(),type:"bus",prevPos:f.clone(),currentPos:f.clone(),targetPos:f.clone(),actualWorldPos:f.clone(),progress:1,baseSpeed:.35,currentSpeed:.35,color:Ce[Math.floor(Math.random()*Ce.length)],waitTimer:0,lastDirection:new D(0,0,1),targetRotation:new ee,currentRotation:new ee,laneIndex:1,visualLaneOffset:H[1],laneChangeTimer:0,preferredSide:0,isStoppedAtStation:!1})}const k=Math.min(re,x.length)-j.length;if(k>0)for(let i=0;i<k;i++){const u=x[Math.floor(Math.random()*x.length)],f=new D(u.x-R/2+.5,.05,u.z-R/2+.5);p.push({id:Math.random(),type:"person",prevPos:f.clone(),currentPos:f.clone(),targetPos:f.clone(),actualWorldPos:f.clone(),progress:1,baseSpeed:.12+Math.random()*.1,currentSpeed:.12,color:Ee[Math.floor(Math.random()*Ee.length)],headColor:Re[Math.floor(Math.random()*Re.length)],scale:.85+Math.random()*.3,waitTimer:0,lastDirection:new D(0,0,1),targetRotation:new ee,currentRotation:new ee,laneIndex:0,visualLaneOffset:0,laneChangeTimer:0,preferredSide:Math.random()>.5?1:-1,isStoppedAtStation:!1})}if(w.current=p,s.current){const i=p.filter(u=>u.type==="car");for(let u=0;u<Z;u++)u<i.length&&(s.current.setColorAt(u,oe.set(i[u].color)),a.current?.setColorAt(u,oe.set(i[u].color)));s.current.instanceColor&&(s.current.instanceColor.needsUpdate=!0),a.current?.instanceColor&&(a.current.instanceColor.needsUpdate=!0)}if(C.current){const i=p.filter(u=>u.type==="bus");for(let u=0;u<se;u++)u<i.length&&C.current.setColorAt(u,oe.set(i[u].color));C.current.instanceColor&&(C.current.instanceColor.needsUpdate=!0)}if(m.current){const i=p.filter(u=>u.type==="person");for(let u=0;u<re;u++)u<i.length&&(m.current.setColorAt(u,oe.set(i[u].color)),d.current?.setColorAt(u,oe.set(i[u].headColor)));m.current.instanceColor&&(m.current.instanceColor.needsUpdate=!0),d.current?.instanceColor&&(d.current.instanceColor.needsUpdate=!0)}},[r]);const z=(N,L,x,A,j)=>{const p=[{x:N+1,z:L},{x:N-1,z:L},{x:N,z:L+1},{x:N,z:L-1}].map(g=>{const P=r.find(i=>i.x===g.x&&i.z===g.z);if(!P)return{...g,score:-1/0};if((j==="car"||j==="bus")&&P.type!==h.ROAD)return{...g,score:-1/0};if(j==="person"&&P.type===h.EMPTY)return{...g,score:-1/0};let k=100;return g.x===x&&g.z===A&&(k-=195),k+=Math.random()*20,{...g,score:k}}).filter(g=>g.score!==-1/0);return p.length>0?(p.sort((g,P)=>P.score-g.score),p[0]):null};return ye((N,L)=>{[s,a,c,n,l,C,S,m,d].forEach(t=>{if(t.current)for(let p=0;p<(t.current.count||0);p++)t.current.setMatrixAt(p,pt)});let x=0,A=0,j=0;w.current.forEach(t=>{const p=t.type==="car",g=t.type==="bus",P=t.type==="person";if((p||g)&&t.currentSpeed<.05){if(t.waitTimer+=L,t.waitTimer>ft){const f=t.currentPos.clone();t.currentPos.copy(t.targetPos),t.targetPos.copy(f),t.progress=1-t.progress,t.waitTimer=0}}else t.waitTimer=0;if(t.progress>=1){const f=Math.floor(t.targetPos.x+R/2),v=Math.floor(t.targetPos.z+R/2);if(g&&!t.isStoppedAtStation&&[{x:f+1,z:v},{x:f-1,z:v},{x:f,z:v+1},{x:f,z:v-1}].some(O=>r.find(B=>B.x===O.x&&B.z===O.z)?.type===h.BUS_STOP)&&(t.isStoppedAtStation=!0,t.waitTimer=xt),g&&t.isStoppedAtStation)if(t.waitTimer-=L,t.waitTimer<=0)t.isStoppedAtStation=!1;else return;const E=Math.floor(t.prevPos.x+R/2),I=Math.floor(t.prevPos.z+R/2),T=z(f,v,E,I,t.type);if(T){t.prevPos.copy(t.currentPos),t.currentPos.copy(t.targetPos);const F=r.find(B=>B.x===T.x&&B.z===T.z),O=new D(T.x-R/2+.5,g?.12:p?.08:.05,T.z-R/2+.5);if(p||g){const B=new D().subVectors(O,t.currentPos).normalize(),K=new D(-B.z,0,B.x).multiplyScalar(H[t.laneIndex]);t.targetPos.copy(O.add(K))}else if(F?.type===h.ROAD){const B=new D().subVectors(O,t.currentPos).normalize(),K=new D(-B.z,0,B.x).multiplyScalar(dt*t.preferredSide);t.targetPos.copy(O.add(K))}else{const B=new D((Math.random()-.5)*.45,0,(Math.random()-.5)*.45);t.targetPos.copy(O.add(B))}t.progress=0}else if(p||g){const F=t.currentPos.clone();t.currentPos.copy(t.targetPos),t.targetPos.copy(F),t.progress=0}}let k=t.baseSpeed;if(p||g){t.laneChangeTimer=Math.max(0,t.laneChangeTimer-L);const f=new D().subVectors(t.targetPos,t.currentPos).normalize();let v=!1;for(const E of w.current)if((E.type==="car"||E.type==="bus")&&E.id!==t.id){const I=t.actualWorldPos.distanceTo(E.actualWorldPos);if(I<pe){const T=new D().subVectors(E.actualWorldPos,t.actualWorldPos).normalize();f.dot(T)>.6&&t.laneIndex===E.laneIndex&&(k=I<(g?1.2:ut)?0:t.baseSpeed*.4,p&&I<pe*.8&&E.currentSpeed<t.baseSpeed*.6&&(v=!0))}}if(p&&v&&t.laneChangeTimer<=0){const E=(t.laneIndex+1)%H.length;let I=!0;for(const T of w.current)if((T.type==="car"||T.type==="bus")&&T.id!==t.id&&T.laneIndex===E&&t.actualWorldPos.distanceTo(T.actualWorldPos)<pe){I=!1;break}if(I){t.laneIndex=E,t.laneChangeTimer=ht;const T=new D().subVectors(t.targetPos,t.currentPos).normalize(),F=t.targetPos.clone().sub(new D(-T.z,0,T.x).multiplyScalar(H[1-E]));t.targetPos.copy(F.add(new D(-T.z,0,T.x).multiplyScalar(H[E])))}}t.visualLaneOffset=ve.lerp(t.visualLaneOffset,H[t.laneIndex],.05)}else for(const f of w.current)f.type==="person"&&f.id!==t.id&&t.actualWorldPos.distanceTo(f.actualWorldPos)<.2&&(k*=.5);t.currentSpeed=ve.lerp(t.currentSpeed,k,.1),t.progress=Math.min(1,t.progress+L*t.currentSpeed);const i=new D().lerpVectors(t.currentPos,t.targetPos,t.progress);if(p||g){const f=new D().subVectors(t.targetPos,t.currentPos).normalize(),v=new D(-f.z,0,f.x).multiplyScalar(t.visualLaneOffset-H[t.laneIndex]);t.actualWorldPos.copy(i.add(v))}else t.actualWorldPos.copy(i);W.position.copy(t.actualWorldPos);const u=new D().subVectors(t.targetPos,t.currentPos).normalize();if(u.lengthSq()>.001&&(W.lookAt(t.actualWorldPos.clone().add(u)),t.targetRotation.copy(W.quaternion),t.lastDirection.copy(u)),t.currentRotation.slerp(t.targetRotation,P?.3:.12),W.quaternion.copy(t.currentRotation),p&&x<Z){W.updateMatrix(),s.current?.setMatrixAt(x,W.matrix),M.copy(W),M.position.y+=.07,M.position.add(t.lastDirection.clone().multiplyScalar(-.04)),M.scale.set(.8,.7,.5),M.updateMatrix(),a.current?.setMatrixAt(x,M.matrix),M.scale.set(.85,.75,.55),M.updateMatrix(),c.current?.setMatrixAt(x,M.matrix);const f=new D(-t.lastDirection.z,0,t.lastDirection.x).normalize();M.copy(W),M.position.add(t.lastDirection.clone().multiplyScalar(.201)).add(f.clone().multiplyScalar(.06)),M.scale.set(1,1,1),M.updateMatrix(),n.current?.setMatrixAt(x*2,M.matrix),M.position.add(f.clone().multiplyScalar(-.12)),M.updateMatrix(),n.current?.setMatrixAt(x*2+1,M.matrix),M.copy(W),M.position.add(t.lastDirection.clone().multiplyScalar(-.201)).add(f.clone().multiplyScalar(.06)),M.updateMatrix(),l.current?.setMatrixAt(x*2,M.matrix),M.position.add(f.clone().multiplyScalar(-.12)),M.updateMatrix(),l.current?.setMatrixAt(x*2+1,M.matrix),x++}else if(g&&A<se)W.updateMatrix(),C.current?.setMatrixAt(A,W.matrix),M.copy(W),M.position.y+=.08,M.scale.set(.9,.6,.85),M.updateMatrix(),S.current?.setMatrixAt(A,M.matrix),A++;else if(P&&j<re){const f=Math.abs(Math.sin(N.clock.elapsedTime*10+t.id))*.03,v=t.scale||1;W.scale.set(v,v,v),W.position.y=t.actualWorldPos.y+f+.05*v,W.updateMatrix(),m.current?.setMatrixAt(j,W.matrix),M.copy(W),M.position.y+=.09*v,M.scale.set(v*.8,v*.8,v*.8),M.updateMatrix(),d.current?.setMatrixAt(j,M.matrix),j++}}),[s,a,c,n,l,C,S,m,d].forEach(t=>{t.current&&(t.current.instanceMatrix.needsUpdate=!0)})}),e.jsxs("group",{children:[e.jsxs("instancedMesh",{ref:s,args:[void 0,void 0,Z],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{roughness:.3,metalness:.7})]}),e.jsxs("instancedMesh",{ref:a,args:[void 0,void 0,Z],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{roughness:.3,metalness:.7})]}),e.jsxs("instancedMesh",{ref:c,args:[void 0,void 0,Z],children:[e.jsx("boxGeometry",{args:[.2,.1,.4]}),e.jsx("meshStandardMaterial",{color:"#050505",roughness:0,metalness:1})]}),e.jsxs("instancedMesh",{ref:n,args:[void 0,void 0,Z*2],children:[e.jsx("boxGeometry",{args:[.05,.03,.01]}),e.jsx("meshStandardMaterial",{color:"#ffffff",emissive:"#ffffff",emissiveIntensity:3})]}),e.jsxs("instancedMesh",{ref:l,args:[void 0,void 0,Z*2],children:[e.jsx("boxGeometry",{args:[.05,.03,.01]}),e.jsx("meshStandardMaterial",{color:"#ff0000",emissive:"#ff0000",emissiveIntensity:3})]}),e.jsxs("instancedMesh",{ref:C,args:[void 0,void 0,se],castShadow:!0,children:[e.jsx("boxGeometry",{args:[.35,.25,.8]}),e.jsx("meshStandardMaterial",{roughness:.4,metalness:.3})]}),e.jsxs("instancedMesh",{ref:S,args:[void 0,void 0,se],children:[e.jsx("boxGeometry",{args:[.35,.25,.8]}),e.jsx("meshStandardMaterial",{color:"#0a0a0a",roughness:0,metalness:1})]}),e.jsxs("instancedMesh",{ref:m,args:[void 0,void 0,re],castShadow:!0,children:[e.jsx("capsuleGeometry",{args:[.04,.08,4,8]}),e.jsx("meshStandardMaterial",{roughness:.8})]}),e.jsxs("instancedMesh",{ref:d,args:[void 0,void 0,re],castShadow:!0,children:[e.jsx("sphereGeometry",{args:[.035,8,8]}),e.jsx("meshStandardMaterial",{roughness:.6})]})]})},vt=({gameTime:r})=>{const s=(r-6)/24*Math.PI*2,a=25,c=o.useMemo(()=>new D(Math.cos(s)*a,Math.sin(s)*a,8),[s]),n=r<5.5||r>19.5,l=r>=5.5&&r<=7||r>=18&&r<=19.5,C=o.useMemo(()=>n?new ae("#3b82f6"):l?new ae("#ffaa44"):new ae("#ffffff"),[n,l]),S=o.useMemo(()=>n?.2:l?.8:1.2,[n,l]);return e.jsxs("group",{children:[e.jsx(rt,{sunPosition:c,turbidity:n?.1:.5,rayleigh:n?.1:2}),e.jsx("directionalLight",{position:c,intensity:S,color:C,castShadow:!0,"shadow-bias":-5e-4,"shadow-mapSize":[2048,2048]}),e.jsx("ambientLight",{intensity:n?.1:.4,color:n?"#1e3a8a":"#ffffff"})]})},gt=({messages:r,isVisible:s,onClear:a})=>{const[c,n]=o.useState(!1);return s?e.jsxs("div",{className:"fixed bottom-6 right-6 w-70 z-50 flex flex-col pointer-events-auto",children:[e.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl border border-slate-700/50 rounded-2xl shadow-2xl overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-700/50 bg-slate-800/30",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-slate-400",children:"City Feed"})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:a,className:"text-slate-500 hover:text-red-400 transition-colors",title:"Clear all logs",children:e.jsx("i",{className:"fas fa-trash-can text-xs"})}),e.jsx("button",{onClick:()=>n(!c),className:"text-slate-500 hover:text-white transition-colors",children:e.jsx("i",{className:`fas ${c?"fa-chevron-up":"fa-chevron-down"} text-xs`})}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] animate-pulse"})]})]}),!c&&e.jsx("div",{className:"h-64 overflow-y-auto p-4 space-y-3 custom-scrollbar",children:r.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-slate-600 italic text-xs font-mono",children:"Waiting for citizen feedback..."}):r.map(l=>e.jsx("div",{className:"relative group animate-in fade-in slide-in-from-bottom-2 duration-300",children:e.jsxs("div",{className:"bg-slate-800/40 border-l-2 border-green-500/80 p-3 pl-4 rounded-r-lg hover:bg-slate-800/60 transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("span",{className:"text-[10px] font-bold text-slate-500 font-mono tracking-tight",children:["@",l.user]}),e.jsx("span",{className:"text-[9px] text-slate-600 font-mono uppercase",children:l.timestamp})]}),e.jsx("p",{className:"text-xs text-slate-200 font-mono leading-relaxed pr-8",children:l.content})]})},l.id))})]}),e.jsx("style",{dangerouslySetInnerHTML:{__html:`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(71, 85, 105, 0.5);
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(100, 116, 139, 0.8);
        }
      `}})]}):null},St=({onStart:r,hasSavedGame:s})=>e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center z-50 text-white font-sans p-6 bg-black/30 backdrop-blur-sm transition-all duration-1000",children:e.jsxs("div",{className:"max-w-md w-full bg-slate-900/90 p-8 rounded-2xl border border-slate-700 shadow-2xl backdrop-blur-xl relative overflow-hidden animate-fade-in",children:[e.jsx("div",{className:"absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("div",{className:"absolute -bottom-24 -left-24 w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("h1",{className:"text-5xl font-black mb-2 bg-linear-to-br from-white via-cyan-200 to-blue-400 bg-clip-text text-transparent tracking-tight",children:"Neo City"}),e.jsx("p",{className:"text-slate-400 mb-8 text-sm font-medium uppercase tracking-widest",children:"Cyberpunk City Simulation"}),e.jsxs("div",{className:"space-y-3",children:[s&&e.jsxs("button",{onClick:()=>r(!0),className:"w-full py-4 bg-linear-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-green-900/20 transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide flex items-center justify-center gap-2",children:[e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),"Continue"]}),e.jsx("button",{onClick:()=>r(!1),className:`w-full py-4 text-white font-bold rounded-xl shadow-lg transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide ${s?"bg-linear-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 shadow-slate-900/20":"bg-linear-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 shadow-cyan-900/20"}`,children:s?"New Game":"Start Building"})]})]})]})}),yt=()=>{const[r,s]=o.useState(!1),[a,c]=o.useState([]),[n,l]=o.useState(st),[C,S]=o.useState("Neo City"),[m,d]=o.useState(h.ROAD),[w,z]=o.useState(null),[N,L]=o.useState(null),[x,A]=o.useState(10),[j,t]=o.useState([]),[p,g]=o.useState(!0),[P,k]=o.useState({autoSaveEnabled:!0,lastSavedAt:null}),[i,u]=o.useState(!1),f=o.useRef(a),v=o.useRef(n),E=o.useRef(C),I=o.useRef(x),T=o.useRef(j),F=o.useRef(n.money);o.useEffect(()=>{f.current=a},[a]),o.useEffect(()=>{v.current=n},[n]),o.useEffect(()=>{E.current=C},[C]),o.useEffect(()=>{I.current=x},[x]),o.useEffect(()=>{T.current=j},[j]),o.useEffect(()=>{(async()=>{const _=await xe.hasSave();u(_)})()},[]);const O=o.useCallback(async(b=!1)=>{const _=await xe.save(f.current,v.current,E.current,I.current,T.current);if(_&&(k(U=>({...U,lastSavedAt:Date.now()})),!b)){const V=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t(G=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:"City data synchronized to neural network.",timestamp:V,type:"positive"},...G])}return _},[t]),B=o.useCallback(async()=>{const b=await xe.load();return b?(c(b.cityData),l(b.stats),S(b.cityName),A(b.gameTime),t(b.feedMessages),k(_=>({..._,lastSavedAt:b.savedAt})),!0):!1},[]),K=async(b=!1)=>{if(b)await B();else{const _=[];for(let V=0;V<R;V++)for(let G=0;G<R;G++)_.push({x:V,z:G,type:h.EMPTY,level:0});c(_);const U={id:"welcome",user:"SYSTEM",content:`Welcome to ${C}. Terrain generation complete. Ready for development.`,timestamp:"11:30 PM",type:"neutral"};t([U])}s(!0)},ue=()=>{k(b=>({...b,autoSaveEnabled:!b.autoSaveEnabled}))};o.useEffect(()=>{if(!r||!P.autoSaveEnabled)return;const b=setInterval(()=>{O(!0)},6e4);return()=>clearInterval(b)},[r,P.autoSaveEnabled,O]),o.useEffect(()=>{if(!r)return;const b=setInterval(()=>{c(_=>{const U=_.reduce((q,fe)=>(q[fe.type]=(q[fe.type]||0)+1,q),{}),V=(U[h.RESIDENTIAL]||0)*10,G=(U[h.COMMERCIAL]||0)*15+(U[h.INDUSTRIAL]||0)*25,Q=(U[h.ROAD]||0)*2+(U[h.PARK]||0)*10,ce=Math.min(100,Math.max(0,70+(U[h.PARK]||0)*2));return l(q=>({...q,population:V,money:q.money+(G-Q),income:G,expense:Q,happiness:Math.round(ce)})),_}),A(_=>(_+.1)%24)},5e3);return()=>clearInterval(b)},[r]),o.useEffect(()=>{if(r){if(n.money<0&&F.current>=0){const _=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t(U=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:"Warning: City treasury is in deficit! Revenue generation required.",timestamp:_,type:"negative"},...U].slice(0,50))}F.current=n.money}},[n.money]);const J=o.useCallback((b,_)=>{r&&(L(null),c(U=>{const V=U.findIndex($=>$.x===b&&$.z===_);if(V===-1)return U;const G=U[V];if(m===h.EMPTY){if(G.type===h.EMPTY)return U;const $=[...U];return $[V]={...G,type:h.EMPTY,level:0},z(null),$}if(G.type!==h.EMPTY)return z({x:b,z:_}),U;const Q=ge[m];if(v.current.money<Q.cost)return L(""),U;const ce=[...U],q=Math.floor(Math.random()*3);ce[V]={...G,type:m,level:q};const De=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t($=>[{id:Math.random().toString(36).substr(2,9),user:"SYSTEM",content:`Construction complete: ${Q.label} deployed at [${b}, ${_}].`,timestamp:De,type:"neutral"},...$].slice(0,50)),l($=>({...$,money:$.money-Q.cost})),z({x:b,z:_}),ce}))},[m,r]),ie=b=>{d(b),z(null),L(null)},le=a.find(b=>b.x===w?.x&&b.z===w?.z)||null;return e.jsxs("div",{className:"relative w-full h-screen",children:[e.jsxs(Ie,{shadows:!0,camera:{position:[15,15,15],fov:40},children:[e.jsx(vt,{gameTime:x}),e.jsx(lt,{cityData:a,onTileClick:J,selectedType:m,selectedBuilding:w}),e.jsx(mt,{cityData:a}),e.jsx(et,{position:[0,-.01,0],opacity:.3,scale:30,blur:2.5,far:5}),e.jsx($e,{preset:"city"}),e.jsx(Ye,{makeDefault:!0,maxPolarAngle:Math.PI/2.1,minDistance:5,maxDistance:40})]}),!r&&e.jsx(St,{onStart:K,hasSavedGame:i}),r&&e.jsxs(e.Fragment,{children:[e.jsx(gt,{messages:j,isVisible:p,onClear:()=>t([])}),N&&e.jsxs("div",{className:"absolute top-24 left-1/2 -translate-x-1/2 z-50 bg-red-600/90 text-white px-6 py-2 rounded-full shadow-lg border border-red-400 animate-bounce pointer-events-none",children:[e.jsx("i",{className:"fas fa-exclamation-triangle mr-2"}),N]}),e.jsx(ct,{stats:n,cityName:C,onRenameCity:S,selectedType:m,onSelectType:ie,selectedBuildingInfo:le,onDeselect:()=>z(null),isFeedVisible:p,onToggleFeed:()=>g(!p),saveSettings:P,onSave:()=>O(!1),onToggleAutoSave:ue})]})]})},Nt={fullscreen:!0};function Dt(){return[{title:"Neo City"},{property:"og:title",content:"Neo City"},{name:"description",content:"Neo City - A city building simulation game with isometric 3D graphics."}]}const At=Ae(yt);export{At as default,Nt as handle,Dt as meta};
