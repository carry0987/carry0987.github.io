import{a as x,R as gt,p as u,w as dn}from"./chunk-FGUA77HG-BxeL2Wrr.js";import{u as pe,e as pr,a as St,_ as Ct,v as hn,b as ze,M as pn,c as Et,d as mn,C as fn}from"./constants-D7oXvinL.js";import{R as gn,V as be,a as vn,e as Tt,I as wn,j as Nt,D as mr,k as fr,H as Me,l as Oe,m as Je,L as ke,n as pt,o as xn,U as yn,p as _n,q as It,r as bn,s as gr,t as Mn,u as Sn,g as qe,v as Gt,w as En,x as yt,y as We,S as vr,z as In,d as Ht,E as Rt,W as Rn,J as Cn,K as Dt,N as et,M as Tn,Q as Nn,X as kn,Y as An,Z as Fn,_ as Pt,$ as Un,a0 as jn,a1 as or,a2 as Bn,a3 as Mt,a4 as On,a5 as Dn,a6 as Pn,a7 as Ln,a8 as zn,f as Gn,a9 as Hn,aa as Zn,ab as $n,ac as Ce,ad as wr,ae as xr}from"./three.module-iQVXO5hy.js";var z=(n=>(n.None="None",n.Road="Road",n.Residential="Residential",n.Commercial="Commercial",n.Industrial="Industrial",n.Park="Park",n))(z||{});const Se=15,Wn=2e3,Yn=1e6,mt={[z.None]:{type:z.None,cost:0,name:"Bulldoze",description:"Clear a tile",color:"#ef4444",popGen:0,incomeGen:0},[z.Road]:{type:z.Road,cost:10,name:"Road",description:"Connects buildings.",color:"#374151",popGen:0,incomeGen:0},[z.Residential]:{type:z.Residential,cost:100,name:"House",description:"+5 Pop/day",color:"#f87171",popGen:5,incomeGen:0},[z.Commercial]:{type:z.Commercial,cost:200,name:"Shop",description:"+$15/day",color:"#60a5fa",popGen:0,incomeGen:15},[z.Industrial]:{type:z.Industrial,cost:400,name:"Factory",description:"+$40/day",color:"#facc15",popGen:0,incomeGen:40},[z.Park]:{type:z.Park,cost:50,name:"Park",description:"Looks nice.",color:"#4ade80",popGen:1,incomeGen:0}},yr=parseInt(gn.replace(/\D+/g,""));function Xn(n,t=Math.PI/3){const a=Math.cos(t),i=(1+1e-10)*100,o=[new be,new be,new be],s=new be,c=new be,h=new be,p=new be;function d(B){const N=~~(B.x*i),A=~~(B.y*i),E=~~(B.z*i);return`${N},${A},${E}`}const w=n.index?n.toNonIndexed():n,y=w.attributes.position,v={};for(let B=0,N=y.count/3;B<N;B++){const A=3*B,E=o[0].fromBufferAttribute(y,A+0),j=o[1].fromBufferAttribute(y,A+1),Z=o[2].fromBufferAttribute(y,A+2);s.subVectors(Z,j),c.subVectors(E,j);const k=new be().crossVectors(s,c).normalize();for(let D=0;D<3;D++){const W=o[D],M=d(W);M in v||(v[M]=[]),v[M].push(k)}}const _=new Float32Array(y.count*3),U=new vn(_,3,!1);for(let B=0,N=y.count/3;B<N;B++){const A=3*B,E=o[0].fromBufferAttribute(y,A+0),j=o[1].fromBufferAttribute(y,A+1),Z=o[2].fromBufferAttribute(y,A+2);s.subVectors(Z,j),c.subVectors(E,j),h.crossVectors(s,c).normalize();for(let k=0;k<3;k++){const D=o[k],W=d(D),M=v[W];p.set(0,0,0);for(let F=0,Y=M.length;F<Y;F++){const G=M[F];h.dot(G)>a&&p.add(G)}p.normalize(),U.setXYZ(A+k,p.x,p.y,p.z)}}return w.setAttribute("normal",U),w}var Ne=Uint8Array,Ye=Uint16Array,Lt=Uint32Array,_r=new Ne([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),br=new Ne([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Vn=new Ne([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Mr=function(n,t){for(var a=new Ye(31),i=0;i<31;++i)a[i]=t+=1<<n[i-1];for(var o=new Lt(a[30]),i=1;i<30;++i)for(var s=a[i];s<a[i+1];++s)o[s]=s-a[i]<<5|i;return[a,o]},Sr=Mr(_r,2),Er=Sr[0],qn=Sr[1];Er[28]=258,qn[258]=28;var Kn=Mr(br,0),Qn=Kn[0],zt=new Ye(32768);for(var ie=0;ie<32768;++ie){var Ze=(ie&43690)>>>1|(ie&21845)<<1;Ze=(Ze&52428)>>>2|(Ze&13107)<<2,Ze=(Ze&61680)>>>4|(Ze&3855)<<4,zt[ie]=((Ze&65280)>>>8|(Ze&255)<<8)>>>1}var ht=(function(n,t,a){for(var i=n.length,o=0,s=new Ye(t);o<i;++o)++s[n[o]-1];var c=new Ye(t);for(o=0;o<t;++o)c[o]=c[o-1]+s[o-1]<<1;var h;if(a){h=new Ye(1<<t);var p=15-t;for(o=0;o<i;++o)if(n[o])for(var d=o<<4|n[o],w=t-n[o],y=c[n[o]-1]++<<w,v=y|(1<<w)-1;y<=v;++y)h[zt[y]>>>p]=d}else for(h=new Ye(i),o=0;o<i;++o)n[o]&&(h[o]=zt[c[n[o]-1]++]>>>15-n[o]);return h}),vt=new Ne(288);for(var ie=0;ie<144;++ie)vt[ie]=8;for(var ie=144;ie<256;++ie)vt[ie]=9;for(var ie=256;ie<280;++ie)vt[ie]=7;for(var ie=280;ie<288;++ie)vt[ie]=8;var Ir=new Ne(32);for(var ie=0;ie<32;++ie)Ir[ie]=5;var Jn=ht(vt,9,1),ea=ht(Ir,5,1),Ft=function(n){for(var t=n[0],a=1;a<n.length;++a)n[a]>t&&(t=n[a]);return t},Ue=function(n,t,a){var i=t/8|0;return(n[i]|n[i+1]<<8)>>(t&7)&a},Ut=function(n,t){var a=t/8|0;return(n[a]|n[a+1]<<8|n[a+2]<<16)>>(t&7)},ta=function(n){return(n/8|0)+(n&7&&1)},ra=function(n,t,a){(a==null||a>n.length)&&(a=n.length);var i=new(n instanceof Ye?Ye:n instanceof Lt?Lt:Ne)(a-t);return i.set(n.subarray(t,a)),i},na=function(n,t,a){var i=n.length;if(!i||a&&!a.l&&i<5)return t||new Ne(0);var o=!t||a,s=!a||a.i;a||(a={}),t||(t=new Ne(i*3));var c=function(ee){var De=t.length;if(ee>De){var Pe=new Ne(Math.max(De*2,ee));Pe.set(t),t=Pe}},h=a.f||0,p=a.p||0,d=a.b||0,w=a.l,y=a.d,v=a.m,_=a.n,U=i*8;do{if(!w){a.f=h=Ue(n,p,1);var B=Ue(n,p+1,3);if(p+=3,B)if(B==1)w=Jn,y=ea,v=9,_=5;else if(B==2){var j=Ue(n,p,31)+257,Z=Ue(n,p+10,15)+4,k=j+Ue(n,p+5,31)+1;p+=14;for(var D=new Ne(k),W=new Ne(19),M=0;M<Z;++M)W[Vn[M]]=Ue(n,p+M*3,7);p+=Z*3;for(var F=Ft(W),Y=(1<<F)-1,G=ht(W,F,1),M=0;M<k;){var q=G[Ue(n,p,Y)];p+=q&15;var N=q>>>4;if(N<16)D[M++]=N;else{var Q=0,H=0;for(N==16?(H=3+Ue(n,p,3),p+=2,Q=D[M-1]):N==17?(H=3+Ue(n,p,7),p+=3):N==18&&(H=11+Ue(n,p,127),p+=7);H--;)D[M++]=Q}}var le=D.subarray(0,j),V=D.subarray(j);v=Ft(le),_=Ft(V),w=ht(le,v,1),y=ht(V,_,1)}else throw"invalid block type";else{var N=ta(p)+4,A=n[N-4]|n[N-3]<<8,E=N+A;if(E>i){if(s)throw"unexpected EOF";break}o&&c(d+A),t.set(n.subarray(N,E),d),a.b=d+=A,a.p=p=E*8;continue}if(p>U){if(s)throw"unexpected EOF";break}}o&&c(d+131072);for(var Ae=(1<<v)-1,Xe=(1<<_)-1,Fe=p;;Fe=p){var Q=w[Ut(n,p)&Ae],oe=Q>>>4;if(p+=Q&15,p>U){if(s)throw"unexpected EOF";break}if(!Q)throw"invalid length/literal";if(oe<256)t[d++]=oe;else if(oe==256){Fe=p,w=null;break}else{var Ge=oe-254;if(oe>264){var M=oe-257,ce=_r[M];Ge=Ue(n,p,(1<<ce)-1)+Er[M],p+=ce}var ge=y[Ut(n,p)&Xe],je=ge>>>4;if(!ge)throw"invalid distance";p+=ge&15;var V=Qn[je];if(je>3){var ce=br[je];V+=Ut(n,p)&(1<<ce)-1,p+=ce}if(p>U){if(s)throw"unexpected EOF";break}o&&c(d+131072);for(var nt=d+Ge;d<nt;d+=4)t[d]=t[d-V],t[d+1]=t[d+1-V],t[d+2]=t[d+2-V],t[d+3]=t[d+3-V];d=nt}}a.l=w,a.p=Fe,a.b=d,w&&(h=1,a.m=v,a.d=y,a.n=_)}while(!h);return d==t.length?t:ra(t,0,d)},aa=new Ne(0),oa=function(n){if((n[0]&15)!=8||n[0]>>>4>7||(n[0]<<8|n[1])%31)throw"invalid zlib data";if(n[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function _t(n,t){return na((oa(n),n.subarray(2,-4)),t)}var sa=typeof TextDecoder<"u"&&new TextDecoder,ia=0;try{sa.decode(aa,{stream:!0}),ia=1}catch{}const la=n=>n&&n.isCubeTexture;class ca extends Tt{constructor(t,a){var i,o;const s=la(t),h=((o=s?(i=t.image[0])==null?void 0:i.width:t.image.width)!=null?o:1024)/4,p=Math.floor(Math.log2(h)),d=Math.pow(2,p),w=3*Math.max(d,112),y=4*d,v=[s?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/w}`,`#define CUBEUV_TEXEL_HEIGHT ${1/y}`,`#define CUBEUV_MAX_MIP ${p}.0`],_=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,U=v.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${yr>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,B={map:{value:t},height:{value:a?.height||15},radius:{value:a?.radius||100}},N=new wn(1,16),A=new Nt({uniforms:B,fragmentShader:U,vertexShader:_,side:mr});super(N,A)}set radius(t){this.material.uniforms.radius.value=t}get radius(){return this.material.uniforms.radius.value}set height(t){this.material.uniforms.height.value=t}get height(){return this.material.uniforms.height.value}}class ua extends fr{constructor(t){super(t),this.type=Me}parse(t){const c=function(M,F){switch(M){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(F||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(F||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(F||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(F||""))}},y=function(M,F,Y){F=F||1024;let q=M.pos,Q=-1,H=0,le="",V=String.fromCharCode.apply(null,new Uint16Array(M.subarray(q,q+128)));for(;0>(Q=V.indexOf(`
`))&&H<F&&q<M.byteLength;)le+=V,H+=V.length,q+=128,V+=String.fromCharCode.apply(null,new Uint16Array(M.subarray(q,q+128)));return-1<Q?(M.pos+=H+Q+1,le+V.slice(0,Q)):!1},v=function(M){const F=/^#\?(\S+)/,Y=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,G=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,q=/^\s*FORMAT=(\S+)\s*$/,Q=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,H={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let le,V;for((M.pos>=M.byteLength||!(le=y(M)))&&c(1,"no header found"),(V=le.match(F))||c(3,"bad initial token"),H.valid|=1,H.programtype=V[1],H.string+=le+`
`;le=y(M),le!==!1;){if(H.string+=le+`
`,le.charAt(0)==="#"){H.comments+=le+`
`;continue}if((V=le.match(Y))&&(H.gamma=parseFloat(V[1])),(V=le.match(G))&&(H.exposure=parseFloat(V[1])),(V=le.match(q))&&(H.valid|=2,H.format=V[1]),(V=le.match(Q))&&(H.valid|=4,H.height=parseInt(V[1],10),H.width=parseInt(V[2],10)),H.valid&2&&H.valid&4)break}return H.valid&2||c(3,"missing format specifier"),H.valid&4||c(3,"missing image size specifier"),H},_=function(M,F,Y){const G=F;if(G<8||G>32767||M[0]!==2||M[1]!==2||M[2]&128)return new Uint8Array(M);G!==(M[2]<<8|M[3])&&c(3,"wrong scanline width");const q=new Uint8Array(4*F*Y);q.length||c(4,"unable to allocate buffer space");let Q=0,H=0;const le=4*G,V=new Uint8Array(4),Ae=new Uint8Array(le);let Xe=Y;for(;Xe>0&&H<M.byteLength;){H+4>M.byteLength&&c(1),V[0]=M[H++],V[1]=M[H++],V[2]=M[H++],V[3]=M[H++],(V[0]!=2||V[1]!=2||(V[2]<<8|V[3])!=G)&&c(3,"bad rgbe scanline format");let Fe=0,oe;for(;Fe<le&&H<M.byteLength;){oe=M[H++];const ce=oe>128;if(ce&&(oe-=128),(oe===0||Fe+oe>le)&&c(3,"bad scanline data"),ce){const ge=M[H++];for(let je=0;je<oe;je++)Ae[Fe++]=ge}else Ae.set(M.subarray(H,H+oe),Fe),Fe+=oe,H+=oe}const Ge=G;for(let ce=0;ce<Ge;ce++){let ge=0;q[Q]=Ae[ce+ge],ge+=G,q[Q+1]=Ae[ce+ge],ge+=G,q[Q+2]=Ae[ce+ge],ge+=G,q[Q+3]=Ae[ce+ge],Q+=4}Xe--}return q},U=function(M,F,Y,G){const q=M[F+3],Q=Math.pow(2,q-128)/255;Y[G+0]=M[F+0]*Q,Y[G+1]=M[F+1]*Q,Y[G+2]=M[F+2]*Q,Y[G+3]=1},B=function(M,F,Y,G){const q=M[F+3],Q=Math.pow(2,q-128)/255;Y[G+0]=Je.toHalfFloat(Math.min(M[F+0]*Q,65504)),Y[G+1]=Je.toHalfFloat(Math.min(M[F+1]*Q,65504)),Y[G+2]=Je.toHalfFloat(Math.min(M[F+2]*Q,65504)),Y[G+3]=Je.toHalfFloat(1)},N=new Uint8Array(t);N.pos=0;const A=v(N),E=A.width,j=A.height,Z=_(N.subarray(N.pos),E,j);let k,D,W;switch(this.type){case Oe:W=Z.length/4;const M=new Float32Array(W*4);for(let Y=0;Y<W;Y++)U(Z,Y*4,M,Y*4);k=M,D=Oe;break;case Me:W=Z.length/4;const F=new Uint16Array(W*4);for(let Y=0;Y<W;Y++)B(Z,Y*4,F,Y*4);k=F,D=Me;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:E,height:j,data:k,header:A.string,gamma:A.gamma,exposure:A.exposure,type:D}}setDataType(t){return this.type=t,this}load(t,a,i,o){function s(c,h){switch(c.type){case Oe:case Me:"colorSpace"in c?c.colorSpace="srgb-linear":c.encoding=3e3,c.minFilter=ke,c.magFilter=ke,c.generateMipmaps=!1,c.flipY=!0;break}a&&a(c,h)}return super.load(t,s,i,o)}}const ct=yr>=152;class da extends fr{constructor(t){super(t),this.type=Me}parse(t){const F=Math.pow(2.7182818,2.2);function Y(e,r){for(var l=0,m=0;m<65536;++m)(m==0||e[m>>3]&1<<(m&7))&&(r[l++]=m);for(var f=l-1;l<65536;)r[l++]=0;return f}function G(e){for(var r=0;r<16384;r++)e[r]={},e[r].len=0,e[r].lit=0,e[r].p=null}const q={l:0,c:0,lc:0};function Q(e,r,l,m,f){for(;l<e;)r=r<<8|nr(m,f),l+=8;l-=e,q.l=r>>l&(1<<e)-1,q.c=r,q.lc=l}const H=new Array(59);function le(e){for(var r=0;r<=58;++r)H[r]=0;for(var r=0;r<65537;++r)H[e[r]]+=1;for(var l=0,r=58;r>0;--r){var m=l+H[r]>>1;H[r]=l,l=m}for(var r=0;r<65537;++r){var f=e[r];f>0&&(e[r]=f|H[f]++<<6)}}function V(e,r,l,m,f,g,S){for(var b=l,C=0,R=0;f<=g;f++){if(b.value-l.value>m)return!1;Q(6,C,R,e,b);var T=q.l;if(C=q.c,R=q.lc,S[f]=T,T==63){if(b.value-l.value>m)throw"Something wrong with hufUnpackEncTable";Q(8,C,R,e,b);var I=q.l+6;if(C=q.c,R=q.lc,f+I>g+1)throw"Something wrong with hufUnpackEncTable";for(;I--;)S[f++]=0;f--}else if(T>=59){var I=T-59+2;if(f+I>g+1)throw"Something wrong with hufUnpackEncTable";for(;I--;)S[f++]=0;f--}}le(S)}function Ae(e){return e&63}function Xe(e){return e>>6}function Fe(e,r,l,m){for(;r<=l;r++){var f=Xe(e[r]),g=Ae(e[r]);if(f>>g)throw"Invalid table entry";if(g>14){var S=m[f>>g-14];if(S.len)throw"Invalid table entry";if(S.lit++,S.p){var b=S.p;S.p=new Array(S.lit);for(var C=0;C<S.lit-1;++C)S.p[C]=b[C]}else S.p=new Array(1);S.p[S.lit-1]=r}else if(g)for(var R=0,C=1<<14-g;C>0;C--){var S=m[(f<<14-g)+R];if(S.len||S.p)throw"Invalid table entry";S.len=g,S.lit=r,R++}}return!0}const oe={c:0,lc:0};function Ge(e,r,l,m){e=e<<8|nr(l,m),r+=8,oe.c=e,oe.lc=r}const ce={c:0,lc:0};function ge(e,r,l,m,f,g,S,b,C,R){if(e==r){m<8&&(Ge(l,m,f,S),l=oe.c,m=oe.lc),m-=8;var T=l>>m,T=new Uint8Array([T])[0];if(C.value+T>R)return!1;for(var I=b[C.value-1];T-- >0;)b[C.value++]=I}else if(C.value<R)b[C.value++]=e;else return!1;ce.c=l,ce.lc=m}function je(e){return e&65535}function nt(e){var r=je(e);return r>32767?r-65536:r}const ee={a:0,b:0};function De(e,r){var l=nt(e),m=nt(r),f=m,g=l+(f&1)+(f>>1),S=g,b=g-f;ee.a=S,ee.b=b}function Pe(e,r){var l=je(e),m=je(r),f=l-(m>>1)&65535,g=m+f-32768&65535;ee.a=g,ee.b=f}function Ur(e,r,l,m,f,g,S){for(var b=S<16384,C=l>f?f:l,R=1,T;R<=C;)R<<=1;for(R>>=1,T=R,R>>=1;R>=1;){for(var I=0,de=I+g*(f-T),P=g*R,L=g*T,$=m*R,X=m*T,te,ne,me,xe;I<=de;I+=L){for(var ae=I,Be=I+m*(l-T);ae<=Be;ae+=X){var se=ae+$,fe=ae+P,Le=fe+$;b?(De(e[ae+r],e[fe+r]),te=ee.a,me=ee.b,De(e[se+r],e[Le+r]),ne=ee.a,xe=ee.b,De(te,ne),e[ae+r]=ee.a,e[se+r]=ee.b,De(me,xe),e[fe+r]=ee.a,e[Le+r]=ee.b):(Pe(e[ae+r],e[fe+r]),te=ee.a,me=ee.b,Pe(e[se+r],e[Le+r]),ne=ee.a,xe=ee.b,Pe(te,ne),e[ae+r]=ee.a,e[se+r]=ee.b,Pe(me,xe),e[fe+r]=ee.a,e[Le+r]=ee.b)}if(l&R){var fe=ae+P;b?De(e[ae+r],e[fe+r]):Pe(e[ae+r],e[fe+r]),te=ee.a,e[fe+r]=ee.b,e[ae+r]=te}}if(f&R)for(var ae=I,Be=I+m*(l-T);ae<=Be;ae+=X){var se=ae+$;b?De(e[ae+r],e[se+r]):Pe(e[ae+r],e[se+r]),te=ee.a,e[se+r]=ee.b,e[ae+r]=te}T=R,R>>=1}return I}function jr(e,r,l,m,f,g,S,b,C,R){for(var T=0,I=0,de=b,P=Math.trunc(f.value+(g+7)/8);f.value<P;)for(Ge(T,I,l,f),T=oe.c,I=oe.lc;I>=14;){var L=T>>I-14&16383,$=r[L];if($.len)I-=$.len,ge($.lit,S,T,I,l,m,f,C,R,de),T=ce.c,I=ce.lc;else{if(!$.p)throw"hufDecode issues";var X;for(X=0;X<$.lit;X++){for(var te=Ae(e[$.p[X]]);I<te&&f.value<P;)Ge(T,I,l,f),T=oe.c,I=oe.lc;if(I>=te&&Xe(e[$.p[X]])==(T>>I-te&(1<<te)-1)){I-=te,ge($.p[X],S,T,I,l,m,f,C,R,de),T=ce.c,I=ce.lc;break}}if(X==$.lit)throw"hufDecode issues"}}var ne=8-g&7;for(T>>=ne,I-=ne;I>0;){var $=r[T<<14-I&16383];if($.len)I-=$.len,ge($.lit,S,T,I,l,m,f,C,R,de),T=ce.c,I=ce.lc;else throw"hufDecode issues"}return!0}function Kt(e,r,l,m,f,g){var S={value:0},b=l.value,C=ye(r,l),R=ye(r,l);l.value+=4;var T=ye(r,l);if(l.value+=4,C<0||C>=65537||R<0||R>=65537)throw"Something wrong with HUF_ENCSIZE";var I=new Array(65537),de=new Array(16384);G(de);var P=m-(l.value-b);if(V(e,r,l,P,C,R,I),T>8*(m-(l.value-b)))throw"Something wrong with hufUncompress";Fe(I,C,R,de),jr(I,de,e,r,l,T,R,g,f,S)}function Br(e,r,l){for(var m=0;m<l;++m)r[m]=e[r[m]]}function Qt(e){for(var r=1;r<e.length;r++){var l=e[r-1]+e[r]-128;e[r]=l}}function Jt(e,r){for(var l=0,m=Math.floor((e.length+1)/2),f=0,g=e.length-1;!(f>g||(r[f++]=e[l++],f>g));)r[f++]=e[m++]}function er(e){for(var r=e.byteLength,l=new Array,m=0,f=new DataView(e);r>0;){var g=f.getInt8(m++);if(g<0){var S=-g;r-=S+1;for(var b=0;b<S;b++)l.push(f.getUint8(m++))}else{var S=g;r-=2;for(var C=f.getUint8(m++),b=0;b<S+1;b++)l.push(C)}}return l}function Or(e,r,l,m,f,g){var se=new DataView(g.buffer),S=l[e.idx[0]].width,b=l[e.idx[0]].height,C=3,R=Math.floor(S/8),T=Math.ceil(S/8),I=Math.ceil(b/8),de=S-(T-1)*8,P=b-(I-1)*8,L={value:0},$=new Array(C),X=new Array(C),te=new Array(C),ne=new Array(C),me=new Array(C);for(let re=0;re<C;++re)me[re]=r[e.idx[re]],$[re]=re<1?0:$[re-1]+T*I,X[re]=new Float32Array(64),te[re]=new Uint16Array(64),ne[re]=new Uint16Array(T*64);for(let re=0;re<I;++re){var xe=8;re==I-1&&(xe=P);var ae=8;for(let ue=0;ue<T;++ue){ue==T-1&&(ae=de);for(let J=0;J<C;++J)te[J].fill(0),te[J][0]=f[$[J]++],Dr(L,m,te[J]),Pr(te[J],X[J]),Lr(X[J]);zr(X);for(let J=0;J<C;++J)Gr(X[J],ne[J],ue*64)}let we=0;for(let ue=0;ue<C;++ue){const J=l[e.idx[ue]].type;for(let Re=8*re;Re<8*re+xe;++Re){we=me[ue][Re];for(let Ve=0;Ve<R;++Ve){const _e=Ve*64+(Re&7)*8;se.setUint16(we+0*J,ne[ue][_e+0],!0),se.setUint16(we+2*J,ne[ue][_e+1],!0),se.setUint16(we+4*J,ne[ue][_e+2],!0),se.setUint16(we+6*J,ne[ue][_e+3],!0),se.setUint16(we+8*J,ne[ue][_e+4],!0),se.setUint16(we+10*J,ne[ue][_e+5],!0),se.setUint16(we+12*J,ne[ue][_e+6],!0),se.setUint16(we+14*J,ne[ue][_e+7],!0),we+=16*J}}if(R!=T)for(let Re=8*re;Re<8*re+xe;++Re){const Ve=me[ue][Re]+8*R*2*J,_e=R*64+(Re&7)*8;for(let He=0;He<ae;++He)se.setUint16(Ve+He*2*J,ne[ue][_e+He],!0)}}}for(var Be=new Uint16Array(S),se=new DataView(g.buffer),fe=0;fe<C;++fe){l[e.idx[fe]].decoded=!0;var Le=l[e.idx[fe]].type;if(l[fe].type==2)for(var lt=0;lt<b;++lt){const re=me[fe][lt];for(var Ie=0;Ie<S;++Ie)Be[Ie]=se.getUint16(re+Ie*2*Le,!0);for(var Ie=0;Ie<S;++Ie)se.setFloat32(re+Ie*2*Le,O(Be[Ie]),!0)}}}function Dr(e,r,l){for(var m,f=1;f<64;)m=r[e.value],m==65280?f=64:m>>8==255?f+=m&255:(l[f]=m,f++),e.value++}function Pr(e,r){r[0]=O(e[0]),r[1]=O(e[1]),r[2]=O(e[5]),r[3]=O(e[6]),r[4]=O(e[14]),r[5]=O(e[15]),r[6]=O(e[27]),r[7]=O(e[28]),r[8]=O(e[2]),r[9]=O(e[4]),r[10]=O(e[7]),r[11]=O(e[13]),r[12]=O(e[16]),r[13]=O(e[26]),r[14]=O(e[29]),r[15]=O(e[42]),r[16]=O(e[3]),r[17]=O(e[8]),r[18]=O(e[12]),r[19]=O(e[17]),r[20]=O(e[25]),r[21]=O(e[30]),r[22]=O(e[41]),r[23]=O(e[43]),r[24]=O(e[9]),r[25]=O(e[11]),r[26]=O(e[18]),r[27]=O(e[24]),r[28]=O(e[31]),r[29]=O(e[40]),r[30]=O(e[44]),r[31]=O(e[53]),r[32]=O(e[10]),r[33]=O(e[19]),r[34]=O(e[23]),r[35]=O(e[32]),r[36]=O(e[39]),r[37]=O(e[45]),r[38]=O(e[52]),r[39]=O(e[54]),r[40]=O(e[20]),r[41]=O(e[22]),r[42]=O(e[33]),r[43]=O(e[38]),r[44]=O(e[46]),r[45]=O(e[51]),r[46]=O(e[55]),r[47]=O(e[60]),r[48]=O(e[21]),r[49]=O(e[34]),r[50]=O(e[37]),r[51]=O(e[47]),r[52]=O(e[50]),r[53]=O(e[56]),r[54]=O(e[59]),r[55]=O(e[61]),r[56]=O(e[35]),r[57]=O(e[36]),r[58]=O(e[48]),r[59]=O(e[49]),r[60]=O(e[57]),r[61]=O(e[58]),r[62]=O(e[62]),r[63]=O(e[63])}function Lr(e){const r=.5*Math.cos(.7853975),l=.5*Math.cos(3.14159/16),m=.5*Math.cos(3.14159/8),f=.5*Math.cos(3*3.14159/16),g=.5*Math.cos(5*3.14159/16),S=.5*Math.cos(3*3.14159/8),b=.5*Math.cos(7*3.14159/16);for(var C=new Array(4),R=new Array(4),T=new Array(4),I=new Array(4),de=0;de<8;++de){var P=de*8;C[0]=m*e[P+2],C[1]=S*e[P+2],C[2]=m*e[P+6],C[3]=S*e[P+6],R[0]=l*e[P+1]+f*e[P+3]+g*e[P+5]+b*e[P+7],R[1]=f*e[P+1]-b*e[P+3]-l*e[P+5]-g*e[P+7],R[2]=g*e[P+1]-l*e[P+3]+b*e[P+5]+f*e[P+7],R[3]=b*e[P+1]-g*e[P+3]+f*e[P+5]-l*e[P+7],T[0]=r*(e[P+0]+e[P+4]),T[3]=r*(e[P+0]-e[P+4]),T[1]=C[0]+C[3],T[2]=C[1]-C[2],I[0]=T[0]+T[1],I[1]=T[3]+T[2],I[2]=T[3]-T[2],I[3]=T[0]-T[1],e[P+0]=I[0]+R[0],e[P+1]=I[1]+R[1],e[P+2]=I[2]+R[2],e[P+3]=I[3]+R[3],e[P+4]=I[3]-R[3],e[P+5]=I[2]-R[2],e[P+6]=I[1]-R[1],e[P+7]=I[0]-R[0]}for(var L=0;L<8;++L)C[0]=m*e[16+L],C[1]=S*e[16+L],C[2]=m*e[48+L],C[3]=S*e[48+L],R[0]=l*e[8+L]+f*e[24+L]+g*e[40+L]+b*e[56+L],R[1]=f*e[8+L]-b*e[24+L]-l*e[40+L]-g*e[56+L],R[2]=g*e[8+L]-l*e[24+L]+b*e[40+L]+f*e[56+L],R[3]=b*e[8+L]-g*e[24+L]+f*e[40+L]-l*e[56+L],T[0]=r*(e[L]+e[32+L]),T[3]=r*(e[L]-e[32+L]),T[1]=C[0]+C[3],T[2]=C[1]-C[2],I[0]=T[0]+T[1],I[1]=T[3]+T[2],I[2]=T[3]-T[2],I[3]=T[0]-T[1],e[0+L]=I[0]+R[0],e[8+L]=I[1]+R[1],e[16+L]=I[2]+R[2],e[24+L]=I[3]+R[3],e[32+L]=I[3]-R[3],e[40+L]=I[2]-R[2],e[48+L]=I[1]-R[1],e[56+L]=I[0]-R[0]}function zr(e){for(var r=0;r<64;++r){var l=e[0][r],m=e[1][r],f=e[2][r];e[0][r]=l+1.5747*f,e[1][r]=l-.1873*m-.4682*f,e[2][r]=l+1.8556*m}}function Gr(e,r,l){for(var m=0;m<64;++m)r[l+m]=Je.toHalfFloat(Hr(e[m]))}function Hr(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(F,Math.abs(e)-1)}function tr(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function Zr(e){var r=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),l=new Uint8Array(er(r)),m=new Uint8Array(l.length);return Qt(l),Jt(l,m),new DataView(m.buffer)}function At(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),l=_t(r),m=new Uint8Array(l.length);return Qt(l),Jt(l,m),new DataView(m.buffer)}function $r(e){for(var r=e.viewer,l={value:e.offset.value},m=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),f=new Uint8Array(8192),g=0,S=new Array(e.channels),b=0;b<e.channels;b++)S[b]={},S[b].start=g,S[b].end=S[b].start,S[b].nx=e.width,S[b].ny=e.lines,S[b].size=e.type,g+=S[b].nx*S[b].ny*S[b].size;var C=ot(r,l),R=ot(r,l);if(R>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(C<=R)for(var b=0;b<R-C+1;b++)f[b+C]=Ke(r,l);var T=new Uint16Array(65536),I=Y(f,T),de=ye(r,l);Kt(e.array,r,l,de,m,g);for(var b=0;b<e.channels;++b)for(var P=S[b],L=0;L<S[b].size;++L)Ur(m,P.start+L,P.nx,P.size,P.ny,P.nx*P.size,I);Br(T,m,g);for(var $=0,X=new Uint8Array(m.buffer.byteLength),te=0;te<e.lines;te++)for(var ne=0;ne<e.channels;ne++){var P=S[ne],me=P.nx*P.size,xe=new Uint8Array(m.buffer,P.end*2,me*2);X.set(xe,$),$+=me*2,P.end+=me}return new DataView(X.buffer)}function Wr(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),l=_t(r);const m=e.lines*e.channels*e.width,f=e.type==1?new Uint16Array(m):new Uint32Array(m);let g=0,S=0;const b=new Array(4);for(let C=0;C<e.lines;C++)for(let R=0;R<e.channels;R++){let T=0;switch(e.type){case 1:b[0]=g,b[1]=b[0]+e.width,g=b[1]+e.width;for(let I=0;I<e.width;++I){const de=l[b[0]++]<<8|l[b[1]++];T+=de,f[S]=T,S++}break;case 2:b[0]=g,b[1]=b[0]+e.width,b[2]=b[1]+e.width,g=b[2]+e.width;for(let I=0;I<e.width;++I){const de=l[b[0]++]<<24|l[b[1]++]<<16|l[b[2]++]<<8;T+=de,f[S]=T,S++}break}}return new DataView(f.buffer)}function rr(e){var r=e.viewer,l={value:e.offset.value},m=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),f={version:Ee(r,l),unknownUncompressedSize:Ee(r,l),unknownCompressedSize:Ee(r,l),acCompressedSize:Ee(r,l),dcCompressedSize:Ee(r,l),rleCompressedSize:Ee(r,l),rleUncompressedSize:Ee(r,l),rleRawSize:Ee(r,l),totalAcUncompressedCount:Ee(r,l),totalDcUncompressedCount:Ee(r,l),acCompression:Ee(r,l)};if(f.version<2)throw"EXRLoader.parse: "+it.compression+" version "+f.version+" is unsupported";for(var g=new Array,S=ot(r,l)-2;S>0;){var b=wt(r.buffer,l),C=Ke(r,l),R=C>>2&3,T=(C>>4)-1,I=new Int8Array([T])[0],de=Ke(r,l);g.push({name:b,index:I,type:de,compression:R}),S-=b.length+3}for(var P=it.channels,L=new Array(e.channels),$=0;$<e.channels;++$){var X=L[$]={},te=P[$];X.name=te.name,X.compression=0,X.decoded=!1,X.type=te.pixelType,X.pLinear=te.pLinear,X.width=e.width,X.height=e.lines}for(var ne={idx:new Array(3)},me=0;me<e.channels;++me)for(var X=L[me],$=0;$<g.length;++$){var xe=g[$];X.name==xe.name&&(X.compression=xe.compression,xe.index>=0&&(ne.idx[xe.index]=me),X.offset=me)}if(f.acCompressedSize>0)switch(f.acCompression){case 0:var se=new Uint16Array(f.totalAcUncompressedCount);Kt(e.array,r,l,f.acCompressedSize,se,f.totalAcUncompressedCount);break;case 1:var ae=e.array.slice(l.value,l.value+f.totalAcUncompressedCount),Be=_t(ae),se=new Uint16Array(Be.buffer);l.value+=f.totalAcUncompressedCount;break}if(f.dcCompressedSize>0){var fe={array:e.array,offset:l,size:f.dcCompressedSize},Le=new Uint16Array(At(fe).buffer);l.value+=f.dcCompressedSize}if(f.rleRawSize>0){var ae=e.array.slice(l.value,l.value+f.rleCompressedSize),Be=_t(ae),lt=er(Be.buffer);l.value+=f.rleCompressedSize}for(var Ie=0,re=new Array(L.length),$=0;$<re.length;++$)re[$]=new Array;for(var we=0;we<e.lines;++we)for(var ue=0;ue<L.length;++ue)re[ue].push(Ie),Ie+=L[ue].width*e.type*2;Or(ne,re,L,se,Le,m);for(var $=0;$<L.length;++$){var X=L[$];if(!X.decoded)switch(X.compression){case 2:for(var J=0,Re=0,we=0;we<e.lines;++we){for(var Ve=re[$][J],_e=0;_e<X.width;++_e){for(var He=0;He<2*X.type;++He)m[Ve++]=lt[Re+He*X.width*X.height];Re++}J++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(m.buffer)}function wt(e,r){for(var l=new Uint8Array(e),m=0;l[r.value+m]!=0;)m+=1;var f=new TextDecoder().decode(l.slice(r.value,r.value+m));return r.value=r.value+m+1,f}function Yr(e,r,l){var m=new TextDecoder().decode(new Uint8Array(e).slice(r.value,r.value+l));return r.value=r.value+l,m}function Xr(e,r){var l=at(e,r),m=ye(e,r);return[l,m]}function Vr(e,r){var l=ye(e,r),m=ye(e,r);return[l,m]}function at(e,r){var l=e.getInt32(r.value,!0);return r.value=r.value+4,l}function ye(e,r){var l=e.getUint32(r.value,!0);return r.value=r.value+4,l}function nr(e,r){var l=e[r.value];return r.value=r.value+1,l}function Ke(e,r){var l=e.getUint8(r.value);return r.value=r.value+1,l}const Ee=function(e,r){let l;return"getBigInt64"in DataView.prototype?l=Number(e.getBigInt64(r.value,!0)):l=e.getUint32(r.value+4,!0)+Number(e.getUint32(r.value,!0)<<32),r.value+=8,l};function ve(e,r){var l=e.getFloat32(r.value,!0);return r.value+=4,l}function qr(e,r){return Je.toHalfFloat(ve(e,r))}function O(e){var r=(e&31744)>>10,l=e&1023;return(e>>15?-1:1)*(r?r===31?l?NaN:1/0:Math.pow(2,r-15)*(1+l/1024):6103515625e-14*(l/1024))}function ot(e,r){var l=e.getUint16(r.value,!0);return r.value+=2,l}function Kr(e,r){return O(ot(e,r))}function Qr(e,r,l,m){for(var f=l.value,g=[];l.value<f+m-1;){var S=wt(r,l),b=at(e,l),C=Ke(e,l);l.value+=3;var R=at(e,l),T=at(e,l);g.push({name:S,pixelType:b,pLinear:C,xSampling:R,ySampling:T})}return l.value+=1,g}function Jr(e,r){var l=ve(e,r),m=ve(e,r),f=ve(e,r),g=ve(e,r),S=ve(e,r),b=ve(e,r),C=ve(e,r),R=ve(e,r);return{redX:l,redY:m,greenX:f,greenY:g,blueX:S,blueY:b,whiteX:C,whiteY:R}}function en(e,r){var l=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],m=Ke(e,r);return l[m]}function tn(e,r){var l=ye(e,r),m=ye(e,r),f=ye(e,r),g=ye(e,r);return{xMin:l,yMin:m,xMax:f,yMax:g}}function rn(e,r){var l=["INCREASING_Y"],m=Ke(e,r);return l[m]}function nn(e,r){var l=ve(e,r),m=ve(e,r);return[l,m]}function an(e,r){var l=ve(e,r),m=ve(e,r),f=ve(e,r);return[l,m,f]}function on(e,r,l,m,f){if(m==="string"||m==="stringvector"||m==="iccProfile")return Yr(r,l,f);if(m==="chlist")return Qr(e,r,l,f);if(m==="chromaticities")return Jr(e,l);if(m==="compression")return en(e,l);if(m==="box2i")return tn(e,l);if(m==="lineOrder")return rn(e,l);if(m==="float")return ve(e,l);if(m==="v2f")return nn(e,l);if(m==="v3f")return an(e,l);if(m==="int")return at(e,l);if(m==="rational")return Xr(e,l);if(m==="timecode")return Vr(e,l);if(m==="preview")return l.value+=f,"skipped";l.value+=f}function sn(e,r,l){const m={};if(e.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";m.version=e.getUint8(4);const f=e.getUint8(5);m.spec={singleTile:!!(f&2),longName:!!(f&4),deepFormat:!!(f&8),multiPart:!!(f&16)},l.value=8;for(var g=!0;g;){var S=wt(r,l);if(S==0)g=!1;else{var b=wt(r,l),C=ye(e,l),R=on(e,r,l,b,C);R===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${b}'.`):m[S]=R}}if((f&-5)!=0)throw console.error("EXRHeader:",m),"THREE.EXRLoader: provided file is currently unsupported.";return m}function ln(e,r,l,m,f){const g={size:0,viewer:r,array:l,offset:m,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[ct?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":g.lines=1,g.uncompress=tr;break;case"RLE_COMPRESSION":g.lines=1,g.uncompress=Zr;break;case"ZIPS_COMPRESSION":g.lines=1,g.uncompress=At;break;case"ZIP_COMPRESSION":g.lines=16,g.uncompress=At;break;case"PIZ_COMPRESSION":g.lines=32,g.uncompress=$r;break;case"PXR24_COMPRESSION":g.lines=16,g.uncompress=Wr;break;case"DWAA_COMPRESSION":g.lines=32,g.uncompress=rr;break;case"DWAB_COMPRESSION":g.lines=256,g.uncompress=rr;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(g.scanlineBlockSize=g.lines,g.type==1)switch(f){case Oe:g.getter=Kr,g.inputSize=2;break;case Me:g.getter=ot,g.inputSize=2;break}else if(g.type==2)switch(f){case Oe:g.getter=ve,g.inputSize=4;break;case Me:g.getter=qr,g.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+g.type+" for "+e.compression+".";g.blockCount=(e.dataWindow.yMax+1)/g.scanlineBlockSize;for(var S=0;S<g.blockCount;S++)Ee(r,m);g.outputChannels=g.channels==3?4:g.channels;const b=g.width*g.height*g.outputChannels;switch(f){case Oe:g.byteArray=new Float32Array(b),g.channels<g.outputChannels&&g.byteArray.fill(1,0,b);break;case Me:g.byteArray=new Uint16Array(b),g.channels<g.outputChannels&&g.byteArray.fill(15360,0,b);break;default:console.error("THREE.EXRLoader: unsupported type: ",f);break}return g.bytesPerLine=g.width*g.inputSize*g.channels,g.outputChannels==4?g.format=pt:g.format=xn,ct?g.colorSpace="srgb-linear":g.encoding=3e3,g}const xt=new DataView(t),cn=new Uint8Array(t),st={value:0},it=sn(xt,t,st),K=ln(it,xt,cn,st,this.type),ar={value:0},un={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<K.height/K.scanlineBlockSize;e++){const r=ye(xt,st);K.size=ye(xt,st),K.lines=r+K.scanlineBlockSize>K.height?K.height-r:K.scanlineBlockSize;const m=K.size<K.lines*K.bytesPerLine?K.uncompress(K):tr(K);st.value+=K.size;for(let f=0;f<K.scanlineBlockSize;f++){const g=f+e*K.scanlineBlockSize;if(g>=K.height)break;for(let S=0;S<K.channels;S++){const b=un[it.channels[S].name];for(let C=0;C<K.width;C++){ar.value=(f*(K.channels*K.width)+S*K.width+C)*K.inputSize;const R=(K.height-1-g)*(K.width*K.outputChannels)+C*K.outputChannels+b;K.byteArray[R]=K.getter(m,ar)}}}}return{header:it,width:K.width,height:K.height,data:K.byteArray,format:K.format,[ct?"colorSpace":"encoding"]:K[ct?"colorSpace":"encoding"],type:this.type}}setDataType(t){return this.type=t,this}load(t,a,i,o){function s(c,h){ct?c.colorSpace=h.colorSpace:c.encoding=h.encoding,c.minFilter=ke,c.magFilter=ke,c.generateMipmaps=!1,c.flipY=!1,a&&a(c,h)}return super.load(t,s,i,o)}}function ha(n,t,a,i){var o;return o=class extends Nt{constructor(s){super({vertexShader:t,fragmentShader:a,...s});for(const c in n)this.uniforms[c]=new yn(n[c]),Object.defineProperty(this,c,{get(){return this.uniforms[c].value},set(h){this.uniforms[c].value=h}});this.uniforms=_n.clone(this.uniforms)}},o.key=It.generateUUID(),o}const sr=ha({screenspace:!1,color:new qe("black"),opacity:1,thickness:.05,size:new gr},`#include <common>
   #include <morphtarget_pars_vertex>
   #include <skinning_pars_vertex>
   #include <clipping_planes_pars_vertex>
   uniform float thickness;
   uniform bool screenspace;
   uniform vec2 size;
   void main() {
     #if defined (USE_SKINNING)
	     #include <beginnormal_vertex>
       #include <morphnormal_vertex>
       #include <skinbase_vertex>
       #include <skinnormal_vertex>
       #include <defaultnormal_vertex>
     #endif
     #include <begin_vertex>
	   #include <morphtarget_vertex>
	   #include <skinning_vertex>
     #include <project_vertex>
     #include <clipping_planes_vertex>
     vec4 tNormal = vec4(normal, 0.0);
     vec4 tPosition = vec4(transformed, 1.0);
     #ifdef USE_INSTANCING
       tNormal = instanceMatrix * tNormal;
       tPosition = instanceMatrix * tPosition;
     #endif
     if (screenspace) {
       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;
       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); 
     } else {
       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;
       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;
       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;
       clipPosition.xy += offset;
       gl_Position = clipPosition;
     }
   }`,`uniform vec3 color;
   uniform float opacity;
   #include <clipping_planes_pars_fragment>
   void main(){
     #include <clipping_planes_fragment>
     gl_FragColor = vec4(color, opacity);
     #include <tonemapping_fragment>
     #include <${hn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`);function pa({color:n="black",opacity:t=1,transparent:a=!1,screenspace:i=!1,toneMapped:o=!0,polygonOffset:s=!1,polygonOffsetFactor:c=0,renderOrder:h=0,thickness:p=.05,angle:d=Math.PI,clippingPlanes:w,...y}){const v=x.useRef(null),[_]=x.useState(()=>new sr({side:bn})),{gl:U}=pe(),B=U.getDrawingBufferSize(new gr);x.useMemo(()=>pr({OutlinesMaterial:sr}),[]);const N=x.useRef(0),A=x.useRef(null);return x.useLayoutEffect(()=>{const E=v.current;if(!E)return;const j=E.parent;if(j&&j.geometry&&(N.current!==d||A.current!==j.geometry)){var Z;N.current=d,A.current=j.geometry;let k=(Z=E.children)==null?void 0:Z[0];k&&(d&&k.geometry.dispose(),E.remove(k)),j.skeleton?(k=new Mn,k.material=_,k.bind(j.skeleton,j.bindMatrix),E.add(k)):j.isInstancedMesh?(k=new Sn(j.geometry,_,j.count),k.instanceMatrix=j.instanceMatrix,E.add(k)):(k=new Tt,k.material=_,E.add(k)),k.geometry=d?Xn(j.geometry,d):j.geometry,k.morphTargetInfluences=j.morphTargetInfluences,k.morphTargetDictionary=j.morphTargetDictionary}}),x.useLayoutEffect(()=>{const E=v.current;if(!E)return;const j=E.children[0];if(j){j.renderOrder=h;const Z=E.parent;St(j,{morphTargetInfluences:Z.morphTargetInfluences,morphTargetDictionary:Z.morphTargetDictionary}),St(j.material,{transparent:a,thickness:p,color:n,opacity:t,size:B,screenspace:i,toneMapped:o,polygonOffset:s,polygonOffsetFactor:c,clippingPlanes:w,clipping:w&&w.length>0})}}),x.useEffect(()=>()=>{const E=v.current;if(!E)return;const j=E.children[0];j&&(d&&j.geometry.dispose(),E.remove(j))},[]),x.createElement("group",Ct({ref:v},y))}function ma(n,t,a){const i=pe(_=>_.size),o=pe(_=>_.viewport),s=typeof n=="number"?n:i.width*o.dpr,c=i.height*o.dpr,h=(typeof n=="number"?a:n)||{},{samples:p=0,depth:d,...w}=h,y=d??h.depthBuffer,v=x.useMemo(()=>{const _=new Gt(s,c,{minFilter:ke,magFilter:ke,type:Me,...w});return y&&(_.depthTexture=new En(s,c,Oe)),_.samples=p,_},[]);return x.useLayoutEffect(()=>{v.setSize(s,c),p&&(v.samples=p)},[p,v,s,c]),x.useEffect(()=>()=>v.dispose(),[]),v}const fa=n=>typeof n=="function",ga=x.forwardRef(({envMap:n,resolution:t=256,frames:a=1/0,children:i,makeDefault:o,...s},c)=>{const h=pe(({set:N})=>N),p=pe(({camera:N})=>N),d=pe(({size:N})=>N),w=x.useRef(null);x.useImperativeHandle(c,()=>w.current,[]);const y=x.useRef(null),v=ma(t);x.useLayoutEffect(()=>{s.manual||w.current.updateProjectionMatrix()},[d,s]),x.useLayoutEffect(()=>{w.current.updateProjectionMatrix()}),x.useLayoutEffect(()=>{if(o){const N=p;return h(()=>({camera:w.current})),()=>h(()=>({camera:N}))}},[w,o,h]);let _=0,U=null;const B=fa(i);return ze(N=>{B&&(a===1/0||_<a)&&(y.current.visible=!1,N.gl.setRenderTarget(v),U=N.scene.background,n&&(N.scene.background=n),N.gl.render(N.scene,w.current),N.scene.background=U,N.gl.setRenderTarget(null),y.current.visible=!0,_++)}),x.createElement(x.Fragment,null,x.createElement("orthographicCamera",Ct({left:d.width/-2,right:d.width/2,top:d.height/2,bottom:d.height/-2,ref:w},s),!B&&i),x.createElement("group",{ref:y},B&&i(v.texture)))}),va=x.forwardRef((n={enableDamping:!0},t)=>{const{domElement:a,camera:i,makeDefault:o,onChange:s,onStart:c,onEnd:h,...p}=n,d=pe(E=>E.invalidate),w=pe(E=>E.camera),y=pe(E=>E.gl),v=pe(E=>E.events),_=pe(E=>E.set),U=pe(E=>E.get),B=a||v.connected||y.domElement,N=i||w,A=x.useMemo(()=>new pn(N),[N]);return x.useEffect(()=>{A.connect(B);const E=j=>{d(),s&&s(j)};return A.addEventListener("change",E),c&&A.addEventListener("start",c),h&&A.addEventListener("end",h),()=>{A.dispose(),A.removeEventListener("change",E),c&&A.removeEventListener("start",c),h&&A.removeEventListener("end",h)}},[s,c,h,A,d,B]),x.useEffect(()=>{if(o){const E=U().controls;return _({controls:A}),()=>_({controls:E})}},[o,A]),ze(()=>A.update(),-1),x.createElement("primitive",Ct({ref:t,object:A,enableDamping:!0},p))}),wa=({focus:n=0,size:t=25,samples:a=10}={})=>`
#define PENUMBRA_FILTER_SIZE float(${t})
#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))
vec3 randRGB(vec2 uv) {
  return vec3(
    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),
    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),
    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)
  );
}

vec3 lowPassRandRGB(vec2 uv) {
  // 3x3 convolution (average)
  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9
  vec3 result = vec3(0);
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));
  result *= 0.111111111; // 1.0 / 9.0
  return result;
}
vec3 highPassRandRGB(vec2 uv) {
  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal
  // hp(x) = x - lp(x)
  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;
}


vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {
  const float goldenAngle = 2.399963f; // radians
  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));
  float theta = float(sampleIndex) * goldenAngle + angle;
  float sine = sin(theta);
  float cosine = cos(theta);
  return vec2(cosine, sine) * r;
}
float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
  return (zReceiver - zBlocker) / zBlocker;
}
float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float blockerDepthSum = float(${n});
  float blockers = 0.0;

  int j = 0;
  vec2 offset = vec2(0.);
  float depth = 0.;

  #pragma unroll_loop_start
  for(int i = 0; i < ${a}; i ++) {
    offset = (vogelDiskSample(j, ${a}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;
    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));
    if (depth < compare) {
      blockerDepthSum += depth;
      blockers++;
    }
    j++;
  }
  #pragma unroll_loop_end

  if (blockers > 0.0) {
    return blockerDepthSum / blockers;
  }
  return -1.0;
}

        
float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float shadow = 0.0f;
  int j = 0;
  vec2 vogelSample = vec2(0.0);
  vec2 offset = vec2(0.0);
  #pragma unroll_loop_start
  for (int i = 0; i < ${a}; i++) {
    vogelSample = vogelDiskSample(j, ${a}, angle) * texelSize;
    offset = vogelSample * (1.0 + filterRadius * float(${t}));
    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );
    j++;
  }
  #pragma unroll_loop_end
  return shadow * 1.0 / ${a}.0;
}

float PCSS (sampler2D shadowMap, vec4 coords) {
  vec2 uv = coords.xy;
  float zReceiver = coords.z; // Assumed to be eye-space z in this code
  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;
  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);
  if (avgBlockerDepth == -1.0) {
    return 1.0;
  }
  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);
  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);
}`;function ir(n,t,a){t.traverse(i=>{i.material&&(n.properties.remove(i.material),i.material.dispose==null||i.material.dispose())}),n.info.programs.length=0,n.compile(t,a)}function xa({focus:n=0,samples:t=10,size:a=25}){const i=pe(c=>c.gl),o=pe(c=>c.scene),s=pe(c=>c.camera);return x.useEffect(()=>{const c=yt.shadowmap_pars_fragment;return yt.shadowmap_pars_fragment=yt.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
`+wa({size:a,samples:t,focus:n})).replace("#if defined( SHADOWMAP_TYPE_PCF )",`
return PCSS(shadowMap, shadowCoord);
#if defined( SHADOWMAP_TYPE_PCF )`),ir(i,o,s),()=>{yt.shadowmap_pars_fragment=c,ir(i,o,s)}},[n,a,t]),null}const ya=x.forwardRef(({children:n,enabled:t=!0,speed:a=1,rotationIntensity:i=1,floatIntensity:o=1,floatingRange:s=[-.1,.1],autoInvalidate:c=!1,...h},p)=>{const d=x.useRef(null);x.useImperativeHandle(p,()=>d.current,[]);const w=x.useRef(Math.random()*1e4);return ze(y=>{var v,_;if(!t||a===0)return;c&&y.invalidate();const U=w.current+y.clock.elapsedTime;d.current.rotation.x=Math.cos(U/4*a)/8*i,d.current.rotation.y=Math.sin(U/4*a)/8*i,d.current.rotation.z=Math.sin(U/4*a)/20*i;let B=Math.sin(U/4*a)/10;B=It.mapLinear(B,-.1,.1,(v=s?.[0])!==null&&v!==void 0?v:-.1,(_=s?.[1])!==null&&_!==void 0?_:.1),d.current.position.y=B*o,d.current.updateMatrix()}),x.createElement("group",h,x.createElement("group",{ref:d,matrixAutoUpdate:!1},n))}),Rr=(n,t,a)=>{let i;switch(n){case Pt:i=new Uint8ClampedArray(t*a*4);break;case Me:i=new Uint16Array(t*a*4);break;case Fn:i=new Uint32Array(t*a*4);break;case An:i=new Int8Array(t*a*4);break;case kn:i=new Int16Array(t*a*4);break;case Nn:i=new Int32Array(t*a*4);break;case Oe:i=new Float32Array(t*a*4);break;default:throw new Error("Unsupported data type")}return i};let bt;const _a=(n,t,a,i)=>{if(bt!==void 0)return bt;const o=new Gt(1,1,i);t.setRenderTarget(o);const s=new Tt(new Ht,new Tn({color:16777215}));t.render(s,a),t.setRenderTarget(null);const c=Rr(n,o.width,o.height);return t.readRenderTargetPixels(o,0,0,o.width,o.height,c),o.dispose(),s.geometry.dispose(),s.material.dispose(),bt=c[0]!==0,bt};class Zt{_renderer;_rendererIsDisposable=!1;_material;_scene;_camera;_quad;_renderTarget;_width;_height;_type;_colorSpace;_supportsReadPixels=!0;constructor(t){this._width=t.width,this._height=t.height,this._type=t.type,this._colorSpace=t.colorSpace;const a={format:pt,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:t.renderTargetOptions?.anisotropy!==void 0?t.renderTargetOptions?.anisotropy:1,generateMipmaps:t.renderTargetOptions?.generateMipmaps!==void 0?t.renderTargetOptions?.generateMipmaps:!1,magFilter:t.renderTargetOptions?.magFilter!==void 0?t.renderTargetOptions?.magFilter:ke,minFilter:t.renderTargetOptions?.minFilter!==void 0?t.renderTargetOptions?.minFilter:ke,samples:t.renderTargetOptions?.samples!==void 0?t.renderTargetOptions?.samples:void 0,wrapS:t.renderTargetOptions?.wrapS!==void 0?t.renderTargetOptions?.wrapS:We,wrapT:t.renderTargetOptions?.wrapT!==void 0?t.renderTargetOptions?.wrapT:We};if(this._material=t.material,t.renderer?this._renderer=t.renderer:(this._renderer=Zt.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new vr,this._camera=new In,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!_a(this._type,this._renderer,this._camera,a)){let i;switch(this._type){case Me:i=this._renderer.extensions.has("EXT_color_buffer_float")?Oe:void 0;break}i!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${Oe}`),this._type=i):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new Tt(new Ht,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new Gt(this.width,this.height,a),this._renderTarget.texture.mapping=t.renderTargetOptions?.mapping!==void 0?t.renderTargetOptions?.mapping:Rt}static instantiateRenderer(){const t=new Rn;return t.setSize(128,128),t}render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(t){throw this._renderer.setRenderTarget(null),t}this._renderer.setRenderTarget(null)};toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const t=Rr(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,t),t}toDataTexture(t){const a=new Cn(this.toArray(),this.width,this.height,pt,this._type,t?.mapping||Rt,t?.wrapS||We,t?.wrapT||We,t?.magFilter||ke,t?.minFilter||ke,t?.anisotropy||1,Dt);return a.generateMipmaps=t?.generateMipmaps!==void 0?t?.generateMipmaps:!1,a}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(t){this.disposeOnDemandRenderer(),t&&this.renderTarget.dispose(),this.material instanceof Nt&&Object.values(this.material.uniforms).forEach(a=>{a.value instanceof et&&a.value.dispose()}),Object.values(this.material).forEach(a=>{a instanceof et&&a.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(t){this._width=t,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(t){this._height=t,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t,this._width=t.width,this._height=t.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}class Cr extends Error{}class Tr extends Error{}const ut=(n,t,a)=>{const i=new RegExp(`${t}="([^"]*)"`,"i").exec(n);if(i)return i[1];const o=new RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(n);if(o){const s=o[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return s&&s.length===3?s.map(c=>c.replace(/<\/?rdf:li>/g,"")):o[1].trim()}if(a!==void 0)return a;throw new Error(`Can't find ${t} in gainmap metadata`)},ba=n=>{let t;typeof TextDecoder<"u"?t=new TextDecoder().decode(n):t=n.toString();let a=t.indexOf("<x:xmpmeta");for(;a!==-1;){const i=t.indexOf("x:xmpmeta>",a),o=t.slice(a,i+10);try{const s=ut(o,"hdrgm:GainMapMin","0"),c=ut(o,"hdrgm:GainMapMax"),h=ut(o,"hdrgm:Gamma","1"),p=ut(o,"hdrgm:OffsetSDR","0.015625"),d=ut(o,"hdrgm:OffsetHDR","0.015625"),w=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(o),y=w?w[1]:"0",v=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(o);if(!v)throw new Error("Incomplete gainmap metadata");const _=v[1];return{gainMapMin:Array.isArray(s)?s.map(U=>parseFloat(U)):[parseFloat(s),parseFloat(s),parseFloat(s)],gainMapMax:Array.isArray(c)?c.map(U=>parseFloat(U)):[parseFloat(c),parseFloat(c),parseFloat(c)],gamma:Array.isArray(h)?h.map(U=>parseFloat(U)):[parseFloat(h),parseFloat(h),parseFloat(h)],offsetSdr:Array.isArray(p)?p.map(U=>parseFloat(U)):[parseFloat(p),parseFloat(p),parseFloat(p)],offsetHdr:Array.isArray(d)?d.map(U=>parseFloat(U)):[parseFloat(d),parseFloat(d),parseFloat(d)],hdrCapacityMin:parseFloat(y),hdrCapacityMax:parseFloat(_)}}catch{}a=t.indexOf("<x:xmpmeta",i)}};class Ma{options;constructor(t){this.options={debug:t&&t.debug!==void 0?t.debug:!1,extractFII:t&&t.extractFII!==void 0?t.extractFII:!0,extractNonFII:t&&t.extractNonFII!==void 0?t.extractNonFII:!0}}extract(t){return new Promise((a,i)=>{const o=this.options.debug,s=new DataView(t.buffer);if(s.getUint16(0)!==65496){i(new Error("Not a valid jpeg"));return}const c=s.byteLength;let h=2,p=0,d;for(;h<c;){if(++p>250){i(new Error(`Found no marker after ${p} loops ðŸ˜µ`));return}if(s.getUint8(h)!==255){i(new Error(`Not a valid marker at offset 0x${h.toString(16)}, found: 0x${s.getUint8(h).toString(16)}`));return}if(d=s.getUint8(h+1),o&&console.log(`Marker: ${d.toString(16)}`),d===226){o&&console.log("Found APP2 marker (0xffe2)");const w=h+4;if(s.getUint32(w)===1297106432){const y=w+4;let v;if(s.getUint16(y)===18761)v=!1;else if(s.getUint16(y)===19789)v=!0;else{i(new Error("No valid endianness marker found in TIFF header"));return}if(s.getUint16(y+2,!v)!==42){i(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const _=s.getUint32(y+4,!v);if(_<8){i(new Error("Not valid TIFF data! (First offset less than 8)"));return}const U=y+_,B=s.getUint16(U,!v),N=U+2;let A=0;for(let k=N;k<N+12*B;k+=12)s.getUint16(k,!v)===45057&&(A=s.getUint32(k+8,!v));const j=U+2+B*12+4,Z=[];for(let k=j;k<j+A*16;k+=16){const D={MPType:s.getUint32(k,!v),size:s.getUint32(k+4,!v),dataOffset:s.getUint32(k+8,!v),dependantImages:s.getUint32(k+12,!v),start:-1,end:-1,isFII:!1};D.dataOffset?(D.start=y+D.dataOffset,D.isFII=!1):(D.start=0,D.isFII=!0),D.end=D.start+D.size,Z.push(D)}if(this.options.extractNonFII&&Z.length){const k=new Blob([s]),D=[];for(const W of Z){if(W.isFII&&!this.options.extractFII)continue;const M=k.slice(W.start,W.end+1,"image/jpeg");D.push(M)}a(D)}}}h+=2+s.getUint16(h+2)}})}}const Sa=async n=>{const t=ba(n);if(!t)throw new Tr("Gain map XMP metadata not found");const i=await new Ma({extractFII:!0,extractNonFII:!0}).extract(n);if(i.length!==2)throw new Cr("Gain map recovery image not found");return{sdr:new Uint8Array(await i[0].arrayBuffer()),gainMap:new Uint8Array(await i[1].arrayBuffer()),metadata:t}},lr=n=>new Promise((t,a)=>{const i=document.createElement("img");i.onload=()=>{t(i)},i.onerror=o=>{a(o)},i.src=URL.createObjectURL(n)});class Ea extends Un{_renderer;_renderTargetOptions;_internalLoadingManager;_config;constructor(t,a){super(a),this._config=t,t.renderer&&(this._renderer=t.renderer),this._internalLoadingManager=new jn}setRenderer(t){return this._renderer=t,this}setRenderTargetOptions(t){return this._renderTargetOptions=t,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: A Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const t=this._config.createMaterial({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new et,sdr:new et});return this._config.createQuadRenderer({width:16,height:16,type:Me,colorSpace:Dt,material:t,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async processImages(t,a,i){const o=a?new Blob([a],{type:"image/jpeg"}):void 0,s=new Blob([t],{type:"image/jpeg"});let c,h,p=!1;if(typeof createImageBitmap>"u"){const d=await Promise.all([o?lr(o):Promise.resolve(void 0),lr(s)]);h=d[0],c=d[1],p=i==="flipY"}else{const d=await Promise.all([o?createImageBitmap(o,{imageOrientation:i||"flipY"}):Promise.resolve(void 0),createImageBitmap(s,{imageOrientation:i||"flipY"})]);h=d[0],c=d[1]}return{sdrImage:c,gainMapImage:h,needsFlip:p}}createTextures(t,a,i){const o=new et(a||new ImageData(2,2),Rt,We,We,ke,or,pt,Pt,1,Dt);o.flipY=i,o.needsUpdate=!0;const s=new et(t,Rt,We,We,ke,or,pt,Pt,1,Bn);return s.flipY=i,s.needsUpdate=!0,{gainMap:o,sdr:s}}updateQuadRenderer(t,a,i,o,s){t.width=a.width,t.height=a.height,t.material.gainMap=i,t.material.sdr=o,t.material.gainMapMin=s.gainMapMin,t.material.gainMapMax=s.gainMapMax,t.material.offsetHdr=s.offsetHdr,t.material.offsetSdr=s.offsetSdr,t.material.gamma=s.gamma,t.material.hdrCapacityMin=s.hdrCapacityMin,t.material.hdrCapacityMax=s.hdrCapacityMax,t.material.maxDisplayBoost=Math.pow(2,s.hdrCapacityMax),t.material.needsUpdate=!0}}const Ia=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,Ra=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class Ca extends Nt{_maxDisplayBoost;_hdrCapacityMin;_hdrCapacityMax;constructor({gamma:t,offsetHdr:a,offsetSdr:i,gainMapMin:o,gainMapMax:s,maxDisplayBoost:c,hdrCapacityMin:h,hdrCapacityMax:p,sdr:d,gainMap:w}){super({name:"GainMapDecoderMaterial",vertexShader:Ia,fragmentShader:Ra,uniforms:{sdr:{value:d},gainMap:{value:w},gamma:{value:new be(1/t[0],1/t[1],1/t[2])},offsetHdr:{value:new be().fromArray(a)},offsetSdr:{value:new be().fromArray(i)},gainMapMin:{value:new be().fromArray(o)},gainMapMax:{value:new be().fromArray(s)},weightFactor:{value:(Math.log2(c)-h)/(p-h)}},blending:On,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=c,this._hdrCapacityMin=h,this._hdrCapacityMax=p,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(t){this.uniforms.sdr.value=t}get gainMap(){return this.uniforms.gainMap.value}set gainMap(t){this.uniforms.gainMap.value=t}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(t){this.uniforms.offsetHdr.value.fromArray(t)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(t){this.uniforms.offsetSdr.value.fromArray(t)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(t){this.uniforms.gainMapMin.value.fromArray(t)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(t){this.uniforms.gainMapMax.value.fromArray(t)}get gamma(){const t=this.uniforms.gamma.value;return[1/t.x,1/t.y,1/t.z]}set gamma(t){const a=this.uniforms.gamma.value;a.x=1/t[0],a.y=1/t[1],a.z=1/t[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(t){this._hdrCapacityMin=t,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(t){this._hdrCapacityMax=t,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(t){this._maxDisplayBoost=Math.max(1,Math.min(65504,t)),this.calculateWeight()}calculateWeight(){const t=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,t))}}class Nr extends Ea{constructor(t,a){super({renderer:t,createMaterial:i=>new Ca(i),createQuadRenderer:i=>new Zt(i)},a)}async render(t,a,i,o){const{sdrImage:s,gainMapImage:c,needsFlip:h}=await this.processImages(i,o,"flipY"),{gainMap:p,sdr:d}=this.createTextures(s,c,h);this.updateQuadRenderer(t,s,p,d,a),t.render()}}class Ta extends Nr{load([t,a,i],o,s,c){const h=this.prepareQuadRenderer();let p,d,w;const y=async()=>{if(p&&d&&w){try{await this.render(h,w,p,d)}catch(F){this.manager.itemError(t),this.manager.itemError(a),this.manager.itemError(i),typeof c=="function"&&c(F),h.disposeOnDemandRenderer();return}typeof o=="function"&&o(h),this.manager.itemEnd(t),this.manager.itemEnd(a),this.manager.itemEnd(i),h.disposeOnDemandRenderer()}};let v=!0,_=0,U=0,B=!0,N=0,A=0,E=!0,j=0,Z=0;const k=()=>{if(typeof s=="function"){const F=_+N+j,Y=U+A+Z,G=v&&B&&E;s(new ProgressEvent("progress",{lengthComputable:G,loaded:Y,total:F}))}};this.manager.itemStart(t),this.manager.itemStart(a),this.manager.itemStart(i);const D=new Mt(this._internalLoadingManager);D.setResponseType("arraybuffer"),D.setRequestHeader(this.requestHeader),D.setPath(this.path),D.setWithCredentials(this.withCredentials),D.load(t,async F=>{if(typeof F=="string")throw new Error("Invalid sdr buffer");p=F,await y()},F=>{v=F.lengthComputable,U=F.loaded,_=F.total,k()},F=>{this.manager.itemError(t),typeof c=="function"&&c(F)});const W=new Mt(this._internalLoadingManager);W.setResponseType("arraybuffer"),W.setRequestHeader(this.requestHeader),W.setPath(this.path),W.setWithCredentials(this.withCredentials),W.load(a,async F=>{if(typeof F=="string")throw new Error("Invalid gainmap buffer");d=F,await y()},F=>{B=F.lengthComputable,A=F.loaded,N=F.total,k()},F=>{this.manager.itemError(a),typeof c=="function"&&c(F)});const M=new Mt(this._internalLoadingManager);return M.setRequestHeader(this.requestHeader),M.setPath(this.path),M.setWithCredentials(this.withCredentials),M.load(i,async F=>{if(typeof F!="string")throw new Error("Invalid metadata string");w=JSON.parse(F),await y()},F=>{E=F.lengthComputable,Z=F.loaded,j=F.total,k()},F=>{this.manager.itemError(i),typeof c=="function"&&c(F)}),h}}class Na extends Nr{load(t,a,i,o){const s=this.prepareQuadRenderer(),c=new Mt(this._internalLoadingManager);return c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setPath(this.path),c.setWithCredentials(this.withCredentials),this.manager.itemStart(t),c.load(t,async h=>{if(typeof h=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const p=new Uint8Array(h);let d,w,y;try{const v=await Sa(p);d=v.sdr,w=v.gainMap,y=v.metadata}catch(v){if(v instanceof Tr||v instanceof Cr)console.warn(`Failure to reconstruct an HDR image from ${t}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),y={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},d=p;else throw v}try{await this.render(s,y,d.buffer,w?.buffer)}catch(v){this.manager.itemError(t),typeof o=="function"&&o(v),s.disposeOnDemandRenderer();return}typeof a=="function"&&a(s),this.manager.itemEnd(t),s.disposeOnDemandRenderer()},i,h=>{this.manager.itemError(t),typeof o=="function"&&o(h)}),s}}const ft={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},kr="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",tt=n=>Array.isArray(n),$t=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function kt({files:n=$t,path:t="",preset:a=void 0,colorSpace:i=void 0,extensions:o}={}){a&&(Wt(a),n=ft[a],t=kr);const s=tt(n),{extension:c,isCubemap:h}=Yt(n),p=Xt(c);if(!p)throw new Error("useEnvironment: Unrecognized file extension: "+n);const d=pe(_=>_.gl);x.useLayoutEffect(()=>{if(c!=="webp"&&c!=="jpg"&&c!=="jpeg")return;function _(){Et.clear(p,s?[n]:n)}d.domElement.addEventListener("webglcontextlost",_,{once:!0})},[n,d.domElement]);const w=Et(p,s?[n]:n,_=>{(c==="webp"||c==="jpg"||c==="jpeg")&&_.setRenderer(d),_.setPath==null||_.setPath(t),o&&o(_)});let y=s?w[0]:w;if(c==="jpg"||c==="jpeg"||c==="webp"){var v;y=(v=y.renderTarget)==null?void 0:v.texture}return y.mapping=h?Dn:Pn,y.colorSpace=i??(h?"srgb":"srgb-linear"),y}const ka={files:$t,path:"",preset:void 0,extensions:void 0};kt.preload=n=>{const t={...ka,...n};let{files:a,path:i=""}=t;const{preset:o,extensions:s}=t;o&&(Wt(o),a=ft[o],i=kr);const{extension:c}=Yt(a);if(c==="webp"||c==="jpg"||c==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const h=Xt(c);if(!h)throw new Error("useEnvironment: Unrecognized file extension: "+a);Et.preload(h,tt(a)?[a]:a,p=>{p.setPath==null||p.setPath(i),s&&s(p)})};const Aa={files:$t,preset:void 0};kt.clear=n=>{const t={...Aa,...n};let{files:a}=t;const{preset:i}=t;i&&(Wt(i),a=ft[i]);const{extension:o}=Yt(a),s=Xt(o);if(!s)throw new Error("useEnvironment: Unrecognized file extension: "+a);Et.clear(s,tt(a)?[a]:a)};function Wt(n){if(!(n in ft))throw new Error("Preset must be one of: "+Object.keys(ft).join(", "))}function Yt(n){var t;const a=tt(n)&&n.length===6,i=tt(n)&&n.length===3&&n.some(c=>c.endsWith("json")),o=tt(n)?n[0]:n;return{extension:a?"cube":i?"webp":o.startsWith("data:application/exr")?"exr":o.startsWith("data:application/hdr")?"hdr":o.startsWith("data:image/jpeg")?"jpg":(t=o.split(".").pop())==null||(t=t.split("?"))==null||(t=t.shift())==null?void 0:t.toLowerCase(),isCubemap:a,isGainmap:i}}function Xt(n){return n==="cube"?Ln:n==="hdr"?ua:n==="exr"?da:n==="jpg"||n==="jpeg"?Na:n==="webp"?Ta:null}const Fa=n=>n.current&&n.current.isScene,Ua=n=>Fa(n)?n.current:n;function Vt(n,t,a,i,o={}){var s,c,h,p;o={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...o};const d=Ua(t||a),w=d.background,y=d.environment,v={backgroundBlurriness:d.backgroundBlurriness,backgroundIntensity:d.backgroundIntensity,backgroundRotation:(s=(c=d.backgroundRotation)==null||c.clone==null?void 0:c.clone())!==null&&s!==void 0?s:[0,0,0],environmentIntensity:d.environmentIntensity,environmentRotation:(h=(p=d.environmentRotation)==null||p.clone==null?void 0:p.clone())!==null&&h!==void 0?h:[0,0,0]};return n!=="only"&&(d.environment=i),n&&(d.background=i),St(d,o),()=>{n!=="only"&&(d.environment=y),n&&(d.background=w),St(d,v)}}function qt({scene:n,background:t=!1,map:a,...i}){const o=pe(s=>s.scene);return x.useLayoutEffect(()=>{if(a)return Vt(t,n,o,a,i)}),null}function Ar({background:n=!1,scene:t,blur:a,backgroundBlurriness:i,backgroundIntensity:o,backgroundRotation:s,environmentIntensity:c,environmentRotation:h,...p}){const d=kt(p),w=pe(y=>y.scene);return x.useLayoutEffect(()=>Vt(n,t,w,d,{backgroundBlurriness:a??i,backgroundIntensity:o,backgroundRotation:s,environmentIntensity:c,environmentRotation:h})),x.useEffect(()=>()=>{d.dispose()},[d]),null}function ja({children:n,near:t=.1,far:a=1e3,resolution:i=256,frames:o=1,map:s,background:c=!1,blur:h,backgroundBlurriness:p,backgroundIntensity:d,backgroundRotation:w,environmentIntensity:y,environmentRotation:v,scene:_,files:U,path:B,preset:N=void 0,extensions:A}){const E=pe(M=>M.gl),j=pe(M=>M.scene),Z=x.useRef(null),[k]=x.useState(()=>new vr),D=x.useMemo(()=>{const M=new zn(i);return M.texture.type=Me,M},[i]);x.useEffect(()=>()=>{D.dispose()},[D]),x.useLayoutEffect(()=>{if(o===1){const M=E.autoClear;E.autoClear=!0,Z.current.update(E,k),E.autoClear=M}return Vt(c,_,j,D.texture,{backgroundBlurriness:h??p,backgroundIntensity:d,backgroundRotation:w,environmentIntensity:y,environmentRotation:v})},[n,k,D.texture,_,j,c,o,E]);let W=1;return ze(()=>{if(o===1/0||W<o){const M=E.autoClear;E.autoClear=!0,Z.current.update(E,k),E.autoClear=M,W++}}),x.createElement(x.Fragment,null,mn(x.createElement(x.Fragment,null,n,x.createElement("cubeCamera",{ref:Z,args:[t,a,D]}),U||N?x.createElement(Ar,{background:!0,files:U,preset:N,path:B,extensions:A}):s?x.createElement(qt,{background:!0,map:s,extensions:A}):null),k))}function Ba(n){var t,a,i,o;const s=kt(n),c=n.map||s;x.useMemo(()=>pr({GroundProjectedEnvImpl:ca}),[]),x.useEffect(()=>()=>{s.dispose()},[s]);const h=x.useMemo(()=>[c],[c]),p=(t=n.ground)==null?void 0:t.height,d=(a=n.ground)==null?void 0:a.radius,w=(i=(o=n.ground)==null?void 0:o.scale)!==null&&i!==void 0?i:1e3;return x.createElement(x.Fragment,null,x.createElement(qt,Ct({},n,{map:c})),x.createElement("groundProjectedEnvImpl",{args:h,scale:w,height:p,radius:d}))}function Oa(n){return n.ground?x.createElement(Ba,n):n.map?x.createElement(qt,n):n.children?x.createElement(ja,n):x.createElement(Ar,n)}const cr=Se/2-.5,rt=(n,t)=>[n-cr,0,t-cr],dt=(n,t)=>Math.abs(Math.sin(n*12.9898+t*78.233)*43758.5453)%1,Te=(n,t)=>Math.random()*(t-n)+n,he=new Gn(1,1,1),Qe=new Hn(1,1,1,8),jt=new Zn(1,1,4),Fr=new $n(1,8,8),$e=gt.memo(({position:n,scale:t})=>u.jsx("mesh",{geometry:he,position:n,scale:t,children:u.jsx("meshStandardMaterial",{color:"#bfdbfe",emissive:"#bfdbfe",emissiveIntensity:.2,roughness:.1,metalness:.8})})),Da=({position:n})=>{const t=x.useRef(null);return ze(a=>{t.current&&t.current.children.forEach((i,o)=>{const s=i;s.position.y+=.01+o*.005,s.scale.addScalar(.005);const c=s.material;c&&(c.opacity-=.005,s.position.y>1.5&&(s.position.y=0,s.scale.setScalar(.1+Math.random()*.1),c.opacity=.6))})}),u.jsxs("group",{position:n,children:[u.jsx("mesh",{geometry:Qe,castShadow:!0,receiveShadow:!0,position:[0,.5,0],scale:[.2,1,.2],children:u.jsx("meshStandardMaterial",{color:"#4b5563"})}),u.jsx("group",{ref:t,position:[0,1,0],children:[0,1,2].map(a=>u.jsx("mesh",{geometry:Fr,position:[Math.random()*.1,a*.4,Math.random()*.1],scale:.2,children:u.jsx("meshStandardMaterial",{color:"#d1d5db",transparent:!0,opacity:.6,flatShading:!0})},a))})]})},ur=gt.memo(({type:n,baseColor:t,x:a,y:i,opacity:o=1,transparent:s=!1})=>{const c=dt(a,i),h=Math.floor(c*100),p=Math.floor(c*4)*(Math.PI/2),d=x.useMemo(()=>{const B=new qe(t);return B.offsetHSL(c*.1-.05,0,c*.2-.1),B},[t,c]),w=x.useMemo(()=>new Ce({color:d,flatShading:!0,opacity:o,transparent:s,roughness:.8}),[d,o,s]),y=x.useMemo(()=>new Ce({color:new qe(d).multiplyScalar(.7),flatShading:!0,opacity:o,transparent:s}),[d,o,s]),v=x.useMemo(()=>new Ce({color:new qe(d).multiplyScalar(.5).offsetHSL(0,0,-.1),flatShading:!0,opacity:o,transparent:s}),[d,o,s]),_={castShadow:!0,receiveShadow:!0},U=-.3;return u.jsx("group",{rotation:[0,p,0],position:[0,U,0],children:(()=>{switch(n){case z.Residential:return h<33?u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[0,.3,0],scale:[.7,.6,.6]}),u.jsx("mesh",{..._,material:v,geometry:jt,position:[0,.75,0],scale:[.6,.4,.6],rotation:[0,Math.PI/4,0]}),u.jsx($e,{position:[.2,.3,.31],scale:[.15,.2,.05]}),u.jsx($e,{position:[-.2,.3,.31],scale:[.15,.2,.05]}),u.jsx("mesh",{..._,material:y,geometry:he,position:[0,.1,.32],scale:[.15,.2,.05]})]}):h<66?u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[-.1,.35,0],scale:[.6,.7,.8]}),u.jsx("mesh",{..._,material:y,geometry:he,position:[.25,.25,.1],scale:[.4,.5,.6]}),u.jsx($e,{position:[-.1,.5,.41],scale:[.4,.2,.05]})]}):u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[0,.5,0],scale:[.5,1,.6]}),u.jsx("mesh",{..._,material:v,geometry:he,position:[0,1.05,0],scale:[.55,.1,.65]}),u.jsx($e,{position:[0,.7,.31],scale:[.3,.2,.05]}),u.jsx($e,{position:[0,.3,.31],scale:[.3,.2,.05]})]});case z.Commercial:if(h<40){const A=1.5+c*1.5;return u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[0,A/2,0],scale:[.7,A,.7]}),Array.from({length:Math.floor(A*3)}).map((E,j)=>u.jsx($e,{position:[0,.2+j*.3,0],scale:[.72,.15,.72]},j)),u.jsx("mesh",{..._,material:y,geometry:he,position:[0,A+.1,0],scale:[.5,.2,.5]})]})}else return h<70?u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[0,.4,0],scale:[.9,.8,.8]}),u.jsx($e,{position:[0,.3,.41],scale:[.8,.4,.05]}),u.jsx("mesh",{..._,material:new Ce({color:c>.5?"#ef4444":"#3b82f6"}),geometry:he,position:[0,.55,.5],scale:[.9,.1,.2],rotation:[Math.PI/6,0,0]})]}):u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[-.2,.5,-.2],scale:[.5,1,.5]}),u.jsx("mesh",{..._,material:y,geometry:he,position:[.1,.3,.1],scale:[.7,.6,.7]}),u.jsx($e,{position:[.1,.3,.46],scale:[.6,.3,.05]}),u.jsx("mesh",{..._,material:new Ce({color:"#9ca3af"}),geometry:he,position:[.2,.65,.2],scale:[.2,.1,.2]})]});case z.Industrial:return h<50?u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[0,.4,0],scale:[.9,.8,.8]}),u.jsx("mesh",{..._,material:v,geometry:he,position:[-.2,.9,0],scale:[.4,.2,.8],rotation:[0,0,Math.PI/4]}),u.jsx("mesh",{..._,material:v,geometry:he,position:[.2,.9,0],scale:[.4,.2,.8],rotation:[0,0,Math.PI/4]}),u.jsx(Da,{position:[.3,.4,.3]})]}):u.jsxs(u.Fragment,{children:[u.jsx("mesh",{..._,material:w,geometry:he,position:[-.2,.3,0],scale:[.5,.6,.9]}),u.jsx("mesh",{..._,material:y,geometry:Qe,position:[.25,.4,-.2],scale:[.2,.8,.2]}),u.jsx("mesh",{..._,material:y,geometry:Qe,position:[.25,.4,.25],scale:[.2,.8,.2]}),u.jsx("mesh",{..._,material:new Ce({color:"#6b7280"}),geometry:he,position:[.25,.7,0],scale:[.05,.05,.5]})]});case z.Park:const B=1+Math.floor(c*3),N=[[-.2,-.2],[.2,.2],[-.2,.2],[.2,-.2]];return u.jsxs("group",{position:[0,-U-.29,0],children:[" ",u.jsxs("mesh",{receiveShadow:!0,rotation:[-Math.PI/2,0,0],position:[0,.01,0],children:[u.jsx("planeGeometry",{args:[.9,.9]}),u.jsx("meshStandardMaterial",{color:"#86efac"})]}),h<30&&u.jsxs("group",{position:[0,.05,0],children:[u.jsx("mesh",{material:new Ce({color:"#cbd5e1"}),geometry:Qe,scale:[.4,.1,.4],castShadow:!0,receiveShadow:!0}),u.jsx("mesh",{material:new Ce({color:"#3b82f6",roughness:.1}),geometry:Qe,position:[0,.06,0],scale:[.3,.05,.3]})]}),Array.from({length:B}).map((A,E)=>{const j=N[E%N.length],Z=.5+dt(a+E,i-E)*.5,k=new qe("#166534").offsetHSL(0,0,dt(a,i+E)*.2);return u.jsxs("group",{position:[j[0],0,j[1]],scale:Z,rotation:[0,dt(E,a)*Math.PI,0],children:[u.jsx("mesh",{castShadow:!0,receiveShadow:!0,material:new Ce({color:"#78350f"}),geometry:Qe,position:[0,.15,0],scale:[.1,.3,.1]}),u.jsx("mesh",{castShadow:!0,receiveShadow:!0,material:new Ce({color:k,flatShading:!0}),geometry:jt,position:[0,.4,0],scale:[.4,.5,.4]}),u.jsx("mesh",{castShadow:!0,receiveShadow:!0,material:new Ce({color:k,flatShading:!0}),geometry:jt,position:[0,.65,0],scale:[.3,.4,.3]})]},E)})]});case z.Road:return null;default:return null}})()})}),dr=["#ef4444","#3b82f6","#eab308","#ffffff","#1f2937","#f97316"],Pa=({grid:n})=>{const t=x.useMemo(()=>{const c=[];return n.forEach(h=>h.forEach(p=>{p.buildingType===z.Road&&c.push({x:p.x,y:p.y})})),c},[n]),a=Math.min(t.length,30),i=x.useRef(null),o=x.useRef(new Float32Array(0)),s=x.useMemo(()=>new wr,[]);return x.useMemo(()=>new Float32Array(0),[]),x.useEffect(()=>{if(t.length<2)return;o.current=new Float32Array(a*6);const c=new Float32Array(a*3);for(let h=0;h<a;h++){const p=t[Math.floor(Math.random()*t.length)];o.current[h*6+0]=p.x,o.current[h*6+1]=p.y,o.current[h*6+2]=p.x,o.current[h*6+3]=p.y,o.current[h*6+4]=1,o.current[h*6+5]=Te(.01,.03);const d=new qe(dr[Math.floor(Math.random()*dr.length)]);c[h*3]=d.r,c[h*3+1]=d.g,c[h*3+2]=d.b}i.current&&(i.current.instanceColor=new xr(c,3))},[t,a]),ze(()=>{if(!(!i.current||t.length<2||o.current.length===0)){for(let c=0;c<a;c++){const h=c*6;let p=o.current[h],d=o.current[h+1],w=o.current[h+2],y=o.current[h+3],v=o.current[h+4];const _=o.current[h+5];if(v+=_,v>=1){p=w,d=y,v=0;const Y=t.filter(G=>Math.abs(G.x-p)===1&&G.y===d||Math.abs(G.y-d)===1&&G.x===p);if(Y.length>0){const G=Y.length>1?Y.filter(Q=>Math.abs(Q.x-o.current[h])>.1||Math.abs(Q.y-o.current[h+1])>.1):Y,q=G.length>0?G[Math.floor(Math.random()*G.length)]:Y[0];w=q.x,y=q.y}else{const G=t[Math.floor(Math.random()*t.length)];p=G.x,d=G.y,w=G.x,y=G.y}}o.current[h]=p,o.current[h+1]=d,o.current[h+2]=w,o.current[h+3]=y,o.current[h+4]=v;const U=It.lerp(p,w,v),B=It.lerp(d,y,v),N=w-p,A=y-d,E=Math.atan2(A,N),j=.15,Z=Math.sqrt(N*N+A*A)||1,k=-A/Z*j,D=N/Z*j,[W,M,F]=rt(U+k,B+D);s.position.set(W,-.3+.075,F),s.rotation.set(0,-E,0),s.scale.set(.5,.15,.3),s.updateMatrix(),i.current.setMatrixAt(c,s.matrix)}i.current.instanceMatrix.needsUpdate=!0}}),t.length<2?null:u.jsx("instancedMesh",{ref:i,args:[he,void 0,a],castShadow:!0,children:u.jsx("meshStandardMaterial",{roughness:.5,metalness:.3})})},hr=["#ef4444","#3b82f6","#10b981","#f59e0b","#8b5cf6","#ec4899","#ffffff"],La=({population:n,grid:t})=>{const a=Math.min(Math.floor(n/2),300),i=x.useRef(null),o=x.useMemo(()=>{const h=[];return t.forEach(p=>p.forEach(d=>{(d.buildingType===z.Road||d.buildingType===z.Park||d.buildingType===z.None)&&h.push({x:d.x,y:d.y})})),h},[t]),s=x.useRef(new Float32Array(0)),c=x.useMemo(()=>new wr,[]);return x.useEffect(()=>{if(a===0||o.length===0)return;s.current=new Float32Array(a*6);const h=new Float32Array(a*3);for(let p=0;p<a;p++){const d=o[Math.floor(Math.random()*o.length)],w=d.x+Te(-.4,.4),y=d.y+Te(-.4,.4);s.current[p*6+0]=w,s.current[p*6+1]=y;const v=o[Math.floor(Math.random()*o.length)];s.current[p*6+2]=v.x+Te(-.4,.4),s.current[p*6+3]=v.y+Te(-.4,.4),s.current[p*6+4]=Te(.005,.015),s.current[p*6+5]=Math.random()*Math.PI*2;const _=new qe(hr[Math.floor(Math.random()*hr.length)]);h[p*3]=_.r,h[p*3+1]=_.g,h[p*3+2]=_.b}i.current&&(i.current.instanceColor=new xr(h,3))},[a,o]),ze(h=>{if(!i.current||a===0||s.current.length===0)return;const p=h.clock.elapsedTime;for(let d=0;d<a;d++){const w=d*6;let y=s.current[w],v=s.current[w+1],_=s.current[w+2],U=s.current[w+3];const B=s.current[w+4],N=s.current[w+5],A=_-y,E=U-v,j=Math.sqrt(A*A+E*E);if(j<.1){if(o.length>0){const G=o[Math.floor(Math.random()*o.length)];_=G.x+Te(-.4,.4),U=G.y+Te(-.4,.4),s.current[w+2]=_,s.current[w+3]=U}}else y+=A/j*B,v+=E/j*B,s.current[w]=y,s.current[w+1]=v;const[Z,k,D]=rt(y,v),W=Math.abs(Math.sin(p*10+N))*.03,M=.2,F=.08;c.position.set(Z,-.35+M/2+W,D),c.rotation.set(0,-Math.atan2(E,A),0),c.scale.set(F,M,F),c.updateMatrix(),i.current.setMatrixAt(d,c.matrix)}i.current.instanceMatrix.needsUpdate=!0}),a===0?null:u.jsx("instancedMesh",{ref:i,args:[he,void 0,a],castShadow:!0,children:u.jsx("meshStandardMaterial",{roughness:.8})})},Bt=({position:n,scale:t,speed:a})=>{const i=x.useRef(null);ze((s,c)=>{i.current&&(i.current.position.x+=a*c,i.current.position.x>Se*1.5&&(i.current.position.x=-Se*1.5))});const o=x.useMemo(()=>Array.from({length:5+Math.random()*5}).map(()=>({pos:[Te(-1,1),Te(-.5,.5),Te(-1,1)],scale:Te(.5,1.2)})),[]);return u.jsx("group",{ref:i,position:n,scale:t,children:o.map((s,c)=>u.jsx("mesh",{geometry:Fr,position:s.pos,scale:s.scale,castShadow:!0,children:u.jsx("meshStandardMaterial",{color:"white",flatShading:!0,opacity:.9,transparent:!0})},c))})},Ot=({position:n,speed:t,offset:a})=>{const i=x.useRef(null);return ze(o=>{if(i.current){const s=o.clock.elapsedTime+a;i.current.position.x=n[0]+Math.sin(s*t)*Se,i.current.position.z=n[1]+Math.cos(s*t)*Se/2,i.current.rotation.y=-s*t+Math.PI,i.current.scale.y=1+Math.sin(s*15)*.3}}),u.jsxs("group",{ref:i,position:[n[0],n[2],n[1]],children:[u.jsx("mesh",{geometry:he,scale:[.2,.05,.05],position:[.1,0,0],rotation:[0,Math.PI/4,0],children:u.jsx("meshBasicMaterial",{color:"#333"})}),u.jsx("mesh",{geometry:he,scale:[.2,.05,.05],position:[-.1,0,0],rotation:[0,-Math.PI/4,0],children:u.jsx("meshBasicMaterial",{color:"#333"})})]})},za=()=>u.jsxs("group",{raycast:()=>null,children:[u.jsx(Bt,{position:[-12,8,4],scale:1.5,speed:.3}),u.jsx(Bt,{position:[5,9,-8],scale:1.2,speed:.5}),u.jsx(Bt,{position:[15,7,10],scale:1.8,speed:.2}),u.jsxs("group",{position:[0,0,0],scale:.8,children:[u.jsx(Ot,{position:[0,0,10],speed:.6,offset:0}),u.jsx(Ot,{position:[0,0,10],speed:.6,offset:1.2}),u.jsx(Ot,{position:[0,0,10],speed:.6,offset:2.5})]}),u.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,-.6,0],receiveShadow:!0,children:[u.jsx("planeGeometry",{args:[Se*4,Se*4]}),u.jsx("meshStandardMaterial",{color:"#3b82f6",roughness:.1,metalness:.5,opacity:.8,transparent:!0})]})]}),Ga=gt.memo(({x:n,y:t,grid:a,yOffset:i})=>{const o=x.useMemo(()=>new Ce({color:"#fbbf24"}),[]),s=x.useMemo(()=>new Ht(.1,.5),[]),c=t>0&&a[t-1][n].buildingType===z.Road,h=t<Se-1&&a[t+1][n].buildingType===z.Road,p=n>0&&a[t][n-1].buildingType===z.Road,d=n<Se-1&&a[t][n+1].buildingType===z.Road;return[c,h,p,d].filter(Boolean).length===0?u.jsx("mesh",{rotation:[-Math.PI/2,0,0],position:[0,i,0],geometry:s,material:o}):u.jsxs("group",{rotation:[-Math.PI/2,0,0],position:[0,i,0],children:[(c||h)&&(p||d)&&u.jsx("mesh",{position:[0,0,.005],material:o,children:u.jsx("planeGeometry",{args:[.12,.12]})}),c&&u.jsx("mesh",{position:[0,.25,0],geometry:s,material:o}),h&&u.jsx("mesh",{position:[0,-.25,0],geometry:s,material:o}),p&&u.jsx("mesh",{position:[-.25,0,0],rotation:[0,0,Math.PI/2],geometry:s,material:o}),d&&u.jsx("mesh",{position:[.25,0,0],rotation:[0,0,Math.PI/2],geometry:s,material:o})]})}),Ha=gt.memo(({type:n,x:t,y:a,grid:i,onHover:o,onLeave:s,onClick:c})=>{const[h,p,d]=rt(t,a);let w="#10b981",y=-.3,v=.5;if(n===z.None){const U=dt(t,a);w=U>.7?"#059669":U>.3?"#10b981":"#34d399",y=-.3-U*.1}else n===z.Road?(w="#374151",y=-.29):(w="#d1d5db",y=-.28);const _=y-v/2;return u.jsxs("mesh",{position:[h,_,d],receiveShadow:!0,castShadow:!0,onPointerEnter:U=>{U.stopPropagation(),o(t,a)},onPointerOut:U=>{U.stopPropagation(),s()},onPointerDown:U=>{U.stopPropagation(),U.button===0&&c(t,a)},children:[u.jsx("boxGeometry",{args:[1,v,1]}),u.jsx("meshStandardMaterial",{color:w,flatShading:!0,roughness:1}),n===z.Road&&u.jsx(Ga,{x:t,y:a,grid:i,yOffset:v/2+.001})]})}),Za=({x:n,y:t,color:a})=>{const[i,o,s]=rt(n,t);return u.jsxs("mesh",{position:[i,-.25,s],rotation:[-Math.PI/2,0,0],raycast:()=>null,children:[u.jsx("planeGeometry",{args:[1,1]}),u.jsx("meshBasicMaterial",{color:a,transparent:!0,opacity:.4,side:mr,depthTest:!1}),u.jsx(pa,{thickness:.05,color:"white"})]})},$a=({grid:n,onTileClick:t,hoveredTool:a,population:i})=>{const[o,s]=x.useState(null),c=x.useCallback((v,_)=>{s({x:v,y:_})},[]),h=x.useCallback(()=>{s(null)},[]),p=o&&n[o.y][o.x].buildingType===z.None&&a!==z.None,d=p?mt[a].color:"white",w=a===z.None,y=o?rt(o.x,o.y):[0,0,0];return u.jsx("div",{className:"absolute inset-0 bg-sky-900 touch-none",children:u.jsxs(fn,{shadows:!0,dpr:[1,1.5],gl:{antialias:!0},children:[u.jsx(ga,{makeDefault:!0,zoom:45,position:[20,20,20],near:-100,far:200}),u.jsx(va,{enableRotate:!0,enableZoom:!0,minZoom:20,maxZoom:120,maxPolarAngle:Math.PI/2.2,minPolarAngle:.1,target:[0,-.5,0]}),u.jsx("ambientLight",{intensity:.5,color:"#cceeff"}),u.jsx("directionalLight",{castShadow:!0,position:[15,20,10],intensity:2,color:"#fffbeb","shadow-mapSize":[2048,2048],"shadow-camera-left":-15,"shadow-camera-right":15,"shadow-camera-top":15,"shadow-camera-bottom":-15}),u.jsx(Oa,{preset:"city"}),u.jsx(za,{}),u.jsxs("group",{children:[n.map((v,_)=>v.map((U,B)=>{const[N,A,E]=rt(B,_);return u.jsxs(gt.Fragment,{children:[u.jsx(Ha,{type:U.buildingType,x:B,y:_,grid:n,onHover:c,onLeave:h,onClick:t}),u.jsx("group",{position:[N,0,E],raycast:()=>null,children:U.buildingType!==z.None&&U.buildingType!==z.Road&&u.jsx(ur,{type:U.buildingType,baseColor:mt[U.buildingType].color,x:B,y:_})})]},`${B}-${_}`)})),u.jsxs("group",{raycast:()=>null,children:[u.jsx(Pa,{grid:n}),u.jsx(La,{population:i,grid:n}),p&&o&&u.jsx("group",{position:[y[0],0,y[2]],children:u.jsx(ya,{speed:3,rotationIntensity:0,floatIntensity:.1,floatingRange:[0,.1],children:u.jsx(ur,{type:a,baseColor:d,x:o.x,y:o.y,transparent:!0,opacity:.7})})}),o&&u.jsx(Za,{x:o.x,y:o.y,color:w?"#ef4444":p?"#ffffff":"#000000"})]})]}),u.jsx(xa,{size:10,samples:8})]})})},Wa=[z.None,z.Road,z.Residential,z.Commercial,z.Industrial,z.Park],Ya=({type:n,isSelected:t,onClick:a,money:i})=>{const o=mt[n],s=i>=o.cost,c=n===z.None,h=o.color;return u.jsxs("button",{onClick:a,disabled:!c&&!s,className:`
        relative flex flex-col items-center justify-center rounded-lg border-2 transition-all shadow-lg backdrop-blur-sm shrink-0
        w-14 h-14 md:w-16 md:h-16
        ${t?"border-white bg-white/20 scale-110 z-10":"border-gray-600 bg-gray-900/80 hover:bg-gray-800"}
        ${!c&&!s?"opacity-50 cursor-not-allowed":"cursor-pointer"}
      `,title:o.description,children:[u.jsxs("div",{className:"w-6 h-6 md:w-8 md:h-8 rounded mb-0.5 md:mb-1 border border-black/30 shadow-inner flex items-center justify-center overflow-hidden",style:{backgroundColor:c?"transparent":h},children:[c&&u.jsx("div",{className:"w-full h-full bg-red-600 text-white flex justify-center items-center font-bold text-base md:text-lg",children:"âœ•"}),n===z.Road&&u.jsx("div",{className:"w-full h-2 bg-gray-800 transform -rotate-45"})]}),u.jsx("span",{className:"text-[8px] md:text-[10px] font-bold text-white uppercase tracking-wider drop-shadow-md leading-none",children:o.name}),o.cost>0&&u.jsxs("span",{className:`text-[8px] md:text-[10px] font-mono leading-none ${s?"text-green-300":"text-red-400"}`,children:["$",o.cost]})]})},Xa=({stats:n,selectedTool:t,onSelectTool:a,newsFeed:i})=>{const o=x.useRef(null);return x.useEffect(()=>{o.current&&(o.current.scrollTop=o.current.scrollHeight)},[i]),u.jsxs("div",{className:"absolute inset-0 pointer-events-none flex flex-col justify-between p-2 md:p-4 font-sans z-10",children:[u.jsx("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start pointer-events-auto gap-2 w-full max-w-full",children:u.jsxs("div",{className:"bg-gray-900/90 text-white p-2 md:p-3 rounded-xl border border-gray-700 shadow-2xl backdrop-blur-md flex gap-3 md:gap-6 items-center justify-between md:justify-start w-full md:w-auto",children:[u.jsxs("div",{className:"flex flex-col",children:[u.jsx("span",{className:"text-[8px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest",children:"Treasury"}),u.jsxs("span",{className:"text-lg md:text-2xl font-black text-green-400 font-mono drop-shadow-md",children:["$",n.money.toLocaleString()]})]}),u.jsx("div",{className:"w-px h-6 md:h-8 bg-gray-700"}),u.jsxs("div",{className:"flex flex-col",children:[u.jsx("span",{className:"text-[8px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest",children:"Citizens"}),u.jsx("span",{className:"text-base md:text-xl font-bold text-blue-300 font-mono drop-shadow-md",children:n.population.toLocaleString()})]}),u.jsx("div",{className:"w-px h-6 md:h-8 bg-gray-700"}),u.jsxs("div",{className:"flex flex-col items-end",children:[u.jsx("span",{className:"text-[8px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest",children:"Day"}),u.jsx("span",{className:"text-base md:text-lg font-bold text-white font-mono",children:n.day})]})]})}),u.jsxs("div",{className:"flex flex-col-reverse md:flex-row md:justify-between md:items-end pointer-events-auto mt-auto gap-2 w-full max-w-full",children:[u.jsxs("div",{className:"flex gap-1 md:gap-2 bg-gray-900/80 p-1 md:p-2 rounded-2xl border border-gray-600/50 backdrop-blur-xl shadow-2xl w-full md:w-auto overflow-x-auto no-scrollbar justify-start md:justify-start",children:[u.jsx("div",{className:"flex gap-1 md:gap-2 min-w-max px-1",children:Wa.map(s=>u.jsx(Ya,{type:s,isSelected:t===s,onClick:()=>a(s),money:n.money},s))}),u.jsx("div",{className:"text-[8px] text-gray-500 uppercase writing-mode-vertical flex items-center justify-center font-bold tracking-widest border-l border-gray-700 pl-1 ml-1 select-none",children:"Build"})]}),u.jsxs("div",{className:"w-full md:w-80 h-32 md:h-48 bg-black/80 text-white rounded-xl border border-gray-700/80 backdrop-blur-xl shadow-2xl flex flex-col overflow-hidden relative",children:[u.jsxs("div",{className:"bg-gray-800/90 px-3 py-1.5 text-[10px] font-bold uppercase tracking-widest text-gray-300 border-b border-gray-600 flex justify-between items-center",children:[u.jsx("span",{children:"City Feed"}),u.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"})]}),u.jsx("div",{className:"absolute inset-0 pointer-events-none bg-[linear-gradient(to_bottom,rgba(255,255,255,0)_50%,rgba(0,0,0,0.1)_50%)] bg-size-[100%_4px] opacity-30 z-20"}),u.jsxs("div",{ref:o,className:"flex-1 overflow-y-auto p-2 md:p-3 space-y-2 text-[10px] md:text-xs font-mono scroll-smooth mask-image-b z-10",children:[i.length===0&&u.jsx("div",{className:"text-gray-500 italic text-center mt-10",children:"No active news stream."}),i.map(s=>u.jsxs("div",{className:`
                border-l-2 pl-2 py-1 transition-all animate-fade-in leading-tight relative
                ${s.type==="positive"?"border-green-500 text-green-200 bg-green-900/20":""}
                ${s.type==="negative"?"border-red-500 text-red-200 bg-red-900/20":""}
                ${s.type==="neutral"?"border-blue-400 text-blue-100 bg-blue-900/20":""}
              `,children:[u.jsx("span",{className:"opacity-70 text-[8px] absolute top-0.5 right-1",children:new Date(Number(s.id.split(".")[0])).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),s.text]},s.id))]})]})]})]})},Va=({onStart:n})=>u.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center z-50 text-white font-sans p-6 bg-black/30 backdrop-blur-sm transition-all duration-1000",children:u.jsxs("div",{className:"max-w-md w-full bg-slate-900/90 p-8 rounded-2xl border border-slate-700 shadow-2xl backdrop-blur-xl relative overflow-hidden animate-fade-in",children:[u.jsx("div",{className:"absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none"}),u.jsx("div",{className:"absolute -bottom-24 -left-24 w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"}),u.jsxs("div",{className:"relative z-10",children:[u.jsx("h1",{className:"text-5xl font-black mb-2 bg-linear-to-br from-white via-cyan-200 to-blue-400 bg-clip-text text-transparent tracking-tight",children:"SkyMetropolis"}),u.jsx("p",{className:"text-slate-400 mb-8 text-sm font-medium uppercase tracking-widest",children:"Isometric City Builder"}),u.jsx("button",{onClick:n,className:"w-full py-4 bg-linear-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-lg shadow-cyan-900/20 transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide",children:"Start Building"})]})]})}),qa=()=>{const n=[];for(let t=0;t<Se;t++){const a=[];for(let i=0;i<Se;i++)a.push({x:i,y:t,buildingType:z.None});n.push(a)}return n};function Ka(){const[n,t]=x.useState(!1),[a,i]=x.useState(qa),[o,s]=x.useState({money:Yn,population:0,day:1}),[c,h]=x.useState(z.Road),[p,d]=x.useState([]),w=x.useRef(a),y=x.useRef(o);x.useEffect(()=>{w.current=a},[a]),x.useEffect(()=>{y.current=o},[o]);const v=x.useCallback(B=>{d(N=>[...N.slice(-12),B])},[]);x.useEffect(()=>{n&&v({id:Date.now().toString(),text:"Welcome to SkyMetropolis. Terrain generation complete.",type:"positive"})},[n,v]),x.useEffect(()=>{if(!n)return;const B=setInterval(()=>{let N=0,A=0,E={};w.current.flat().forEach(k=>{if(k.buildingType!==z.None){const D=mt[k.buildingType];N+=D.incomeGen,A+=D.popGen,E[k.buildingType]=(E[k.buildingType]||0)+1}});const j=E[z.Residential]||0,Z=j*50;s(k=>{let D=k.population+A;return D>Z&&(D=Z),j===0&&k.population>0&&(D=Math.max(0,k.population-5)),{money:k.money+N,population:D,day:k.day+1}})},Wn);return()=>clearInterval(B)},[n]);const _=x.useCallback((B,N)=>{if(!n)return;const A=w.current,E=y.current,j=c;if(B<0||B>=Se||N<0||N>=Se)return;const Z=A[N][B],k=mt[j];if(j===z.None){if(Z.buildingType!==z.None)if(E.money>=5){const W=A.map(M=>[...M]);W[N][B]={...Z,buildingType:z.None},i(W),s(M=>({...M,money:M.money-5}))}else v({id:Date.now().toString(),text:"Cannot afford demolition costs.",type:"negative"});return}if(Z.buildingType===z.None)if(E.money>=k.cost){s(W=>({...W,money:W.money-k.cost}));const D=A.map(W=>[...W]);D[N][B]={...Z,buildingType:j},i(D)}else v({id:Date.now().toString()+Math.random(),text:`Treasury insufficient for ${k.name}.`,type:"negative"})},[c,v,n]),U=()=>{t(!0)};return u.jsxs("div",{className:"relative w-screen h-screen overflow-hidden selection:bg-transparent selection:text-transparent bg-sky-900",children:[u.jsx($a,{grid:a,onTileClick:_,hoveredTool:c,population:o.population}),!n&&u.jsx(Va,{onStart:U}),n&&u.jsx(Xa,{stats:o,selectedTool:c,onSelectTool:h,newsFeed:p}),u.jsx("style",{children:`
        @keyframes fade-in { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .animate-fade-in { animation: fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .mask-image-b { -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%); mask-image: linear-gradient(to bottom, transparent 0%, black 15%); }
        
        /* Vertical text for toolbar label */
        .writing-mode-vertical { writing-mode: vertical-rl; text-orientation: mixed; }
        
        /* Custom scrollbar for news */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        `})]})}const to={fullscreen:!0};function ro(){return[{title:"Sky Metropolis"},{property:"og:title",content:"Sky Metropolis"},{name:"description",content:"Sky Metropolis - A city building simulation game with isometric 3D graphics."}]}const no=dn(Ka);export{no as default,to as handle,ro as meta};
